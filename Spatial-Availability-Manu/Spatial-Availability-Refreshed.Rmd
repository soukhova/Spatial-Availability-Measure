---
title: "Introducing spatial availability, a singly-constrained measure of competitive accessibility"
abstract: |
  Accessibility indicators are widely used in transportation, urban, and healthcare planning, among many other applications. These measures are weighted sums of reachable opportunities from a given origin conditional on the cost of movement, and are estimates of the potential for spatial interaction. Over time, various proposals have been forwarded to improve their interpretability, mainly by introducing competition. In this paper, we demonstrate how a widely used measure of accessibility with congestion fails to properly match the opportunity-seeking population. We then propose an alternative formulation of accessibility with competition, a measure we call _spatial availability_. This measure results from using balancing factors that are equivalent to imposing a single constraint on conventional gravity-based accessibility. Further, we demonstrate how Two-Stage Floating Catchment Area (2SFCA) methods can be reconceptualized as singly-constrained accessibility. To illustrate the application of spatial availability and compare it to other relevant measures, we use data from the 2016 Transportation Tomorrow Survey of the Greater Golden Horseshoe area in southern Ontario, Canada.

journal: "Some Journal"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
linenumbers: true
linespacing: 1.5
numbersections: true
csl: elsevier-harvard.csl
output: rticles::elsevier_article
header-includes:
- \usepackage[font=small,skip=0pt]{caption}
---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r install-data-package, eval = FALSE, include=FALSE}
if (!require("TTS2016R", character.only = TRUE)) {
      remotes::install_github("soukhova/TTS2016R",
                        build_vignettes = TRUE)
  }
```

```{r load-packages, include=FALSE, cache=FALSE}
library(dplyr) # A Grammar of Data Manipulation
library(fitdistrplus) # Help to Fit of a Parametric Distribution to Non-Censored or Censored Data
library(geomtextpath) # Curved Text in 'ggplot2'
library(ggforce) # Accelerating 'ggplot2'
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggpmisc) # Miscellaneous Extensions to 'ggplot2'
library(ggrepel) # Automatically Position Non-Overlapping Text Labels with 'ggplot2'
library(ggspatial) # Spatial Data Framework for ggplot2
library(gridExtra) # Miscellaneous Functions for "Grid" Graphics 
library(huxtable) # Easily Create and Style Tables for LaTeX, HTML and Other Formats
library(kableExtra) # Construct Complex Table with 'kable' and Pipe Syntax
library(patchwork) # The Composer of Plots
library(RColorBrewer) # ColorBrewer Palettes
library(sf) # Simple Features for R
library(scales) # Scale Functions for Visualization
library(shadowtext) # Shadow Text Grob and Layer
library(skimr) # Compact and Flexible Summaries of Data
library(spdep) # Spatial Dependence: Weighting Schemes, Statistics
library(tidyr) # Tidy Messy Data
library(tmap) # Thematic Maps
library(TTS2016R) # An augmented 2016 Transportation Tomorrow Survey (TTS) data package
options(scipen = 999)
```

```{r sp_avail-function,include=FALSE}
#defining the spatial availability function
sp_avail <- function(x, o_id, d_id, pop, opp, r, f, alpha = 1){

  o_id <- rlang::enquo(o_id)
  d_id <- rlang::enquo(d_id)
  pop <- rlang::enquo(pop)
  opp <- rlang::enquo(opp)
  r <- rlang::enquo(r)
  f <- rlang::enquo(f)

  # Sum of population in system
  sum_pop <- x %>%
    dplyr::distinct(!!o_id,
                    .keep_all = TRUE) %>%
    dplyr::mutate(sum_pop = !!r*(!!pop)^alpha) %>%
    dplyr::pull(sum_pop) %>%
    sum()

  # Balancing factor size
  f_p <- dplyr::pull(x, !!r) * dplyr::pull(x, !!pop)^alpha / sum_pop

  # Sum of impedance
  sum_impedance <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_impedance = sum(!!f))

  # Join sum of impedance to table
  x <- x %>%
    dplyr::left_join(sum_impedance,
                     by = rlang::as_name(d_id))
  
  # Balancing factor impedance
  f_c <- dplyr::pull(x, !!f) / x$sum_impedance

  # Add balancing factors to table
  x$f_c <- f_c
  x$f_p <- f_p
  
  # Sum of balancing factors for mass and impedance
  sum_pa <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_pa= sum(f_p * f_c))

  x <- x %>%
    dplyr::left_join(sum_pa,
                     by = rlang::as_name(d_id))
  
  # Joint balancing factor
  f_t <- (f_p * f_c) / dplyr::pull(x, sum_pa)

  dplyr::pull(x, !!opp) * f_t
}

#detailed
sp_avail_detailed <- function(x, o_id, d_id, pop, opp, r, f, alpha = 1){
  
  o_id <- rlang::enquo(o_id)
  d_id <- rlang::enquo(d_id)
  pop <- rlang::enquo(pop)
  opp <- rlang::enquo(opp)
  r <- rlang::enquo(r)
  f <- rlang::enquo(f)
  
  sum_pop <- x %>%
    dplyr::distinct(!!o_id,
                    .keep_all = TRUE) %>%
    dplyr::mutate(sum_pop = !!r*(!!pop)^alpha) %>%
    dplyr::pull(sum_pop) %>%
    sum()
  
  f_p <- dplyr::pull(x, !!r) * dplyr::pull(x, !!pop)^alpha / sum_pop
  
  sum_impedance <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_impedance = sum(!!f))
  
  x <- x %>%
    dplyr::left_join(sum_impedance,
                     by = rlang::as_name(d_id))
  
  f_c <- dplyr::pull(x, !!f) / x$sum_impedance
  
  x$f_c <- f_c
  x$f_p <- f_p
  
  sum_pa <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_pa= sum(f_p * f_c))
  
  x <- x %>%
    dplyr::left_join(sum_pa,
                     by = rlang::as_name(d_id))
  x$f_t <- (f_p * f_c) / dplyr::pull(x, sum_pa)
  
  x %>%
    dplyr::mutate(V_ij = !!opp * f_t)
}
```

```{r synthetic-data, include=FALSE}
od_tt <- data.frame(i = c("A", "A", "A", "B", "B", "B", "C", "C", "C"), # Three origins
                    j = c("1", "2", "3", "1", "2", "3", "1", "2", "3"), # Three destinations
                    tt = c(15, 30, 100, 30, 15, 100, 100, 100, 15), # Travel time
                    pop = c(50000, 50000, 50000, 150000, 150000, 150000, 10000, 10000, 10000), # Population
                    opp = c(100000, 100000, 10000, 100000, 100000, 10000, 100000, 100000, 10000)) # Jobs
```

```{r data-figure-with-toy-example, include=FALSE}
od <- data.frame(id = c("A", "B", "C", "1", "2", "3"),
                 type = c("Population", "Population", "Population", "Jobs", "Jobs", "Jobs"),
                 size = c(50000, 150000, 10000, 100000, 100000, 10000),
                 x = c(2.5, 2.5, 6.5, 0.5, 0.5, 6.5),
                 y = c(7.5, 2.5, 4.5, 7.5, 2.5, 2.5))

centers <- data.frame(id = c("Urban center", "Suburb", "Satellite town"),
                 radius = rep(1.3, 3),
                 x = c(1.5, 1.5, 6.5),
                 y = c(2.5, 7.5, 3.5))

# od_lines coded as segments
od_lines <- data.frame(x = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 6.5, 6.5, 6.5),
                         y = c(7.5, 7.5, 7.5, 2.5, 2.5, 2.5, 4.5, 4.5, 4.5),
                         xend = c(0.5, 0.5, 6.5, 0.5, 0.5, 6.5, 0.5, 0.5, 6.5),
                         yend = c(7.5, 2.5, 2.5, 7.5, 2.5, 2.5, 7.5, 2.5, 2.5),
                         group = c("A", "A", "A", "B", "B", "B", "C", "C", "C"),
                    time = c("15 min", "30 min", "100 min",
                             "30 min", "15 min", "100 min",
                             "100 min", "100 min", "15 min"),
                         curvature = c(0.5, 0.5, -0.2, 0.5, 0.5, 0.5, 0.5, 0.5, -0.1))

od_table <- data.frame(Center = c("A", "B", "C", "1", "2", "3"),
  Size = c("50,000 pop", "150,000 pop", "10,000 pop", "100,000 jobs", "100,000 jobs", "10,000 jobs"))

od_table2 <- data.frame(Path = c("A to 1", "A to 2", "A to 3", 
                                "B to 1", "B to 2", "B to 3", 
                                "C to 1", "C to 2", "C to 3"),
  Value = c("15 mins", "30 mins", "100 mins", "30 mins", "15 mins", "100 mins", "100 mins", "100 mins", "15 mins"))
```

\newpage

# Introduction {#sec:introduction}

<!-- explain accessibility and how it's used -->

The concept of accessibility in transportation studies derives its appeal from the combination of the spatial distribution of opportunities and the cost of reaching them [@hansen1959; @handy_measuring_1997]. Accessibility analysis is employed in transportation, geography, public health, and many other areas, with the number of applications growing [@shi_literature_2020], especially as mobility-based planning is de-emphasized in favor of access-oriented planning [@deboosere2018; @handy2020; @proffitt2017; @yan2021]. 

<!-- Quickly review the backgroud for the research and identify problem -->

Accessibility analysis stems from the foundational works of @harris_market_1954 and @hansen1959. From these seminal efforts, many accessibility measures have been derived, particularly after the influential work of @wilson1971 on spatial interaction^[Utility-based measures derive from a very different theoretical framework, random utility maximization]. Of these, gravity-type accessibility is arguably the most common; since its introduction in the literature, it has been widely adopted in numerous forms [@cervero_transportation_2002; @paez2004network; @geurs2004; @levinson_accessibility_1998; @Arranz2019measuring]. Hanson-type accessibility indicators are essentially weighted sums of opportunities, with the weights given by an impedance function that depends on the cost of movement, and thus measure the _intensity of the possibility of interaction_ [@hansen1959]. This type of accessibility analysis offers a powerful tool to study the intersection between urban structure and transportation infrastructure [@handy_measuring_1997]. 

<!-- Identify a problem -->

Despite their usefulness, the interpretability of Hansen-type accessibility measures can be challenging [@geurs2004; @miller2018]. Since they aggregate opportunities, the results are sensitive to the size of the region of interest (e.g., a large city has more jobs than a smaller city). As a consequence, raw outputs are not necessarily comparable across study areas [@allen2019]. This limitation becomes evident when surveying studies that implement this type of analysis. For example, @paez_healthcare_2010 (in Montreal) and @campbell_2019_accessibility (in Nairobi) report accessibility as the number of health care facilities that can potentially be reached from origins. But what does it mean for a zone to have accessibility to less than 100 facilities in each of these two cities, with their different populations and number of facilities? For that matter, what does it mean for a zone to have accessibility to more than 700 facilities in Montreal, besides being "accessibility rich"? As another example, @bocarejo_s_transport_2012 (in Bogota), @elgeneidy_cost_2016 (in Montreal), and @jiang_2016_accessibility (in Beijing) report accessibility as numbers of jobs, with accessibility values often in the hundreds of thousands, and even exceeding one million jobs for some zones in Beijing and Montreal. As indicators of urban structure, these measures are informative, but the meaning of one million accessible jobs is harder to pin down: how many jobs must any single person have access to? Clearly, the answer to this question depends on how many people demand jobs.

The interpretability of Hansen-type accessibility has been discussed in numerous studies, including recently by @hu_2019_measuring, @kelobonye2020measuring, and in greater depth by @merlin2017competition. As hinted above, the limitations in interpretability are frequently caused by ignoring competition - without competition, each opportunity is assumed to be equally available to every single opportunity-seeking individual that can reach it [@shen1998; @paez2019; @kelobonye2020measuring]. This assumption is appropriate when the opportunity of interest is non-exclusive, that is, if use by one unit of population does not preclude use by another. For instance, national parks with abundant space are seldom used to full capacity, so the presence of some population does not exclude use by others. When it comes to exclusive opportunities, or when operations may be affected by congestion, the solution has been to account for competition. Several efforts exist that do so. In our reckoning, the first such approach was proposed by @weibull_axiomatic_1976, whereby the distance decay of the supply of employment and the demand for employment (by workers) were formulated under so-called axiomatic assumptions. This approach was then applied by @joseph1984 in the context of healthcare, to quantify the availability of general practitioners in Canada. About two decades later, @shen1998 independently re-discovered Weibull's [-@weibull_axiomatic_1976] formula [see footnote (7) in @shen1998] and deconstructed it to consider accessibility for different modes. These advances were subsequently popularized as the family of Two-Stage Floating Catchment area (2SFCA) methods [@luo2003] that have found widespread adoption in healthcare, education, and food systems [@yang_comparing_2006; @chen_spatial_2020; @ye_spatial_2018; @chen_enhancing_2019; @chen_evaluating_2020]. 

<!-- Explain what this paper aims to do -->

An important development contained in Shen's work is a proof that the population-weighted sum of the accessibility measure with competition equates to the number of opportunities available [footnote (7) and Appendix A in @shen1998]. This demonstration gives the impression that Shen-type accessibility allocates _all_ opportunities to the origins, however to the authors' knowledge, it has not interpreted in this way in the literature. For instance, @hu_changing_2014, @merlin2017competition, , and @tao_investigating_2020 all use Shen-type accessibility to calculate job access but report values as 'competitive accessibility scores' or simply 'job accessibility' and focus on the way in which job supply (opportunities) and demand (job-seeking population) are both discounted by travel cost. These works do not explicitly recognize that jobs that are assigned to each origin are in fact _all_ the opportunities in the system. This recognition, we argue, is critical to interpreting the meaning of the final result. Thus, in this paper we intend to revisit accessibility with competition within the context of disentangling how opportunities are allocated. We first argue that Shen's competitive accessibility misleadingly equates the travel-cost discounted opportunity-seeking population to the total zonal population provided in Shen's proof. This equivocation, we believe, results in a misleading interpretation of what Shen-type accessibility actually represents since the allocation of opportunities to population are masked by the presentation of results as rates (i.e., opportunities per capita). We then propose an alternative formulation of accessibility that incorporates competition by adopting a proportional allocation mechanism; we name this measure _spatial availability_. The use of balancing factors for proportional allocation is akin to imposing a single constraint on the accessibility indicator, in the spirit of Wilson's [-@wilson1971] spatial interaction model.
 
In this way, the aim of the paper is three-fold:

- First, we aim to demonstrate that Shen-type (and thus @weibull_axiomatic_1976 accessibility and the popular 2SFCA methods) produce misleading estimates of the opportunities allocated;

- Second, we introduce a new measure, _spatial availability_, which we submit is a more interpretable alternative to Shen-type accessibility, since opportunities in the system are preserved and proportionally allocated to the population; and

- Third, we show how Shen-type accessibility (and 2SFCA methods) can be seen as measures of singly-constrained accessibility. 

Discussion is supported by the use of the small synthetic example of @shen1998 and empirical data drawn from the 2016 Transportation Tomorrow Survey of the Greater Toronto and Hamilton Area in Ontario, Canada. In the spirit of openness of research in the spatial sciences [@brunsdon2021opening; @paez2021open] this paper has a companion open data product [@arribas2021Open], and all code is available for replicability and reproducibility purposes.

# Accessibility measures revisited {#background}

In this section we revisit Hansen-type and Shen-type accessibility indicators. We adopt the convention of using a capital letter for absolute values (number of opportunities) and lower case for rates (opportunities per capita).

## Hansen-type accessibility

Hansen-type accessibility measures follow the general formulation shown in Equation (\ref{eq:conventional-accessibility}):
```{=tex}
\begin{equation}
\label{eq:conventional-accessibility}
S_i = \sum_{j=1}^JO_j \cdot f(c_{ij})
\end{equation}
```

\noindent where:

-   $c_{ij}$ is a measure of the cost of moving between $i$ and $j$.
-   $f(\cdot)$ is an impedance function of $c_{ij}$; it can take the form of any monotonically decreasing function chosen based on positive or normative criteria [@paez2012measuring].
-   $i$ is a set of origin locations ($i = 1,\cdots,N$).
-   $j$ is a set of destination locations ($j = 1,\cdots,J$).
-   $O_j$ is the number of opportunities at location $j$; $O = \sum_{j=1}^J O_j$ is the total supply of opportunities in the study region.
-   $S$ is Hansen-type accessibility as weighted sum of opportunities.

As formally defined, accessibility $S_i$ is the sum of opportunities that can be reached from location $i$, weighted down by an impedance function of the cost of travel $c_{ij}$. Summing the opportunities in the neighborhood of $i$ provides estimates of the number of opportunities that can _potentially_ be reached from $i$. Several variants of this method result from using a variety of impedance functions; for example, cumulative opportunities measures are obtained when  $f(\cdot)$ is a binary or indicator function [e.g., @elgeneidy_cost_2016; @rosik_forecast_2021; @geurs2004; @qi_decadelong_2018]. Other measures use impedance functions modeled after any monotonically decreasing function [e.g., Gaussian, inverse power, negative exponential, or log-normal, among others, see, *inter alia*, @kwan_spacetime_1998; @vale_influence_2017; @reggiani_accessibility_2011; @li_approach_2020]. In practice, accessibility measures with different impedance functions tend to be highly correlated [@higgins2019; @santanapalacios2022; @kwan_spacetime_1998].

Gravity-based accessibility has been shown to be an excellent indicator of the intersection between spatially distributed opportunities and transportation infrastructure [@shi_literature_2020; @reggiani_accessibility_2011; @kwan_spacetime_1998]. However, beyond enabling comparisons of relative values they are not highly interpretable on their own [@miller2018]. To address the issue or interpretability, previous research has aimed to index and normalize values on a per demand-population basis [e.g., @barboza_balancing_2021; @pereira_distributional_2019; @wang_access_2021]. However, as recent research on accessibility discusses [@merlin2017competition; @allen2019; @paez2019; @kelobonye2020measuring], these steps do not adequately consider competition. In effect, when calculating $S_i$, every opportunity enters the weighted sum once for every origin $i$ that can reach it. This makes interpretability opaque, and to complicate matters, can also bias the estimated landscape of opportunity.

## Shen-type competitive accessibility

To account for competition, the influential works of @shen1998 and @weibull_axiomatic_1976, as well as the widely used 2SFCA approach of @luo2003, adjust Hansen-type accessibility with the population in the region of interest. The mechanics of this approach consist of calculating, for every destination $j$, the population that can reach it given the impedance function $f(\cdot)$; let us call this the _effective opportunity-seeking population_ (Equation (\ref{eq:effective-opportunity-seeking-population})). This value can be seen as the Hansen-type _market area_ (accessibility to population) of $j$. The opportunities at $j$ are then divided by the sum of the _effective opportunity-seeking population_ to obtain a measure of opportunities per capita, i.e., $R_j$ in Equation (\ref{eq:level-of-service}). This can be thought of as the _level of service_ at $j$. Per capita values are then allocated back to the population at $i$, again subject to the impedance function as seen in Equation (\ref{eq:2SFCA-step2}); this is accessibility with competition.

```{=tex}
\begin{equation}
\label{eq:effective-opportunity-seeking-population}
P_{ij}^* = P_{i} \cdot f(c_{ij})\\
\end{equation}
```

```{=tex}
\begin{equation}
\label{eq:level-of-service}
R_{j} = \frac{O_{j}}{\sum_i P_{ij}^*}\\
\end{equation}
```

```{=tex}
\begin{equation}
\label{eq:2SFCA-step2}
a_{i} = {\sum_j R_{j} \cdot f(c_{ij})}\\
\end{equation}
```

\noindent where:

-   $a$ is Shen-type accessibility as weighted sum of opportunities per capita (or weighted level of service).
-   $c_{ij}$ is a measure of the cost of moving between $i$ and $j$.
-   $f(\cdot)$ is an impedance function of $c_{ij}$.
-   $i$ is a set of origin locations ($i = 1,\cdots,N$).
-   $j$ is a set of destination locations ($j = 1,\cdots,J$).
-   $O_j$ is the number of opportunities at location $j$; $O = \sum_{j=1}^J O_j$ is the total supply of opportunities in the study region.
-   $P_i$ is the population at location $i$.
-   $P_{ij}^*$ is the population at location $i$ that can reach destination $j$ according to the impedance function; we call this the _effective opportunity-seeking population_.
-   $R_j$ is the ratio of opportunities at $j$ to the sum over all origins of the _effective opportunity-seeking population_ that can reach $j$; in other words, this is the total number of opportunities per capita found at $j$.

@shen1998 describes $P_i$ as the _"the number of people in location $i$ seeking opportunities"_. In our view, this is somewhat equivocal and where misinterpretation of the final result may arise. Consider a population center where the population is only willing to travel if a trip is less than or equal to 60 minutes. This is identical to the following impedance function:
```{=tex}
\begin{equation}
\label{eq:binary-impedance}
f(c_{ij}) =
\begin{cases}
1\text{ if }c_{ij}\leq60\text{ min}\\
0\text{ otherwise}\\
\end{cases}
\end{equation}
```

If an employment center is less than 60 minutes away, the population can seek opportunities there (i.e., $f(c_{ij})=1$). But are these people still part of the opportunity-seeking population for jobs located two hours away? Four hours? Ten hours? We would assume that they are not because their travel behaviour, as represented by the impedance function would yield $f(c_{ij})=0$, eliminating them from what we call, the _effective opportunity-seeking population_ $P_ij*$.  We see Shen's definition as ambiguous because, for the purpose of calculating accessibility, the impedance function defines what constitutes the population that effectively can seek opportunities at remote locations. Thus $P_i$ should be plainly understood as the population at location $i$ (as we define above) and not the _"the number of people in location $i$ seeking opportunities"_.

Furthermore, the same misunderstanding can be described for $O_j$ which Shen defines as _"the number of relevant opportunities in location j"_ . $O_j$ is weighted down by the same $f(c_{ij})$ in Equation (\ref{eq:2SFCA-step2}), so the _relevancy_ is determined by the travel behaviour associated with the impedance function not by $O_j$ itself. For this reason, $O_j$ should be understand plainly as the opportunities at location $j$ (as we also define above).

Furthermore, misunderstanding $P_i$ and $O_j$ may led to a misinterpretation of the final result $a_i$, especially as expressed in Shen's proof as shown in Equation (\ref{eq:2SFCA-total}).
```{=tex}
\begin{equation}
\label{eq:2SFCA-total}
\sum_{i=1}^N a_{i} P_i= \sum_{j=1}^JO_j\\
\end{equation}
```

Notice, misunderstanding $P_i$ and $O_j$ may allow some to misunderstand the units of $a_{i}$ as _"relevant opportunities"_ per _"people in location $i$ seeking opportunities"_. Instead, as symbolically expressed in the proof, $a_{i}$ is a proportion of the opportunities available to the population, since multiplying $a_i$ by the population at $i$ and summing for all origins in the system equals to the total number of opportunities in the system. Embedded in $a_i$ is already the travel behaviour so $P_i$ and $O_j$ must be plainly understand as population at $i$ and opportunities at $j$ to have Equation (\ref{eq:2SFCA-total}) hold true.

## Example 

In this section we use the example in @shen1998 to flesh out with concrete detail the importance of understanding $P_i$, $O_j$, and how travel behaviour weights down their counts. The example is the simple system shown in Figure \ref{fig:plot-toy-example}.

```{r, create-figure-with-toy-example, fig.cap="\\label{fig:plot-toy-example} Shen (1998) synthetic example with locations of employment centers (in orange), population centers (in blue), number of jobs and population, and travel times.", fig.show='hold', fig.align='center'}

ggplot() + 
  # Plot centers
  geom_circle(data = centers,
             aes(x0 = x, 
                 y0 = y,
                 r = radius)) +
  annotate(geom = "label", 
           x=c(0.5, 0.6, 7),
           y=c(9, 1, 5.2), 
           label = c("Suburban", "Urban", "Satellite"), 
           size=4, 
           label.size=NA) +
  # Connect origins and destinations with curves
  geom_curve(data = od_lines,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   linetype = group,
                   group = group),
             curvature = 0.25,
             size = 0,
             arrow = arrow(length = unit(0.03, unit = "npc"))) +
  # Text on curves
  geom_textcurve(data = od_lines,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   linetype = group,
                   group = group,
                   label = time),
             curvature = 0.25,
             size = 3) +
  # Plot origins and destinations
  geom_point(data = od,
            aes(size = size,
                x = x, 
                y = y, 
                color = type,
                shape = type)) +
  scale_size(range = c(4, 10)) +
  # Label origins and destinations
  geom_text(data = od, 
            aes(x, 
                y, 
                label=id), 
            size=4) +
  # Create table
  annotate(geom = "table",
           x = 8, 
           y = 9, 
           label = list(od_table),
           fill = "white",
           size=3) +
  # Theme the plot
  coord_fixed() + 
  theme_void() +
  guides(shape = "none", size = "none", color = "none", linetype ="none") 
```

```{r access-calcs-table, include=FALSE}
#table with all the accessibility calculations
# Impedance parameter
b <- 0.1

# Calculate impedance function
od_tt <- od_tt %>% mutate(f = exp(-b * tt))

# Level of service 
LOS_j <- od_tt %>%
  group_by(j) %>%
  summarize(opp = mean(opp),
            R_j = sum(pop * f),
            .groups = "drop") %>%
  mutate(LOS_j = opp/R_j)

# Hansen- and Shen-type accessibility
S <- od_tt %>%
  left_join(LOS_j %>% 
              dplyr::select(j, LOS_j, opp, R_j),
            by = "j") %>%
  group_by(i) %>%
  summarize(S_i = sum(opp.x * f), #first, hansen-type accessibility (unconstrained)
            a_i = sum(LOS_j * f)) #second, shen/2SFCA (singly constrained)
```

```{r toy-example-table-creation, include=FALSE}
od_tt1 <- merge(od_tt, 
                S, 
                by="i", 
                all.x = TRUE) %>%
  transmute(i, 
         pop, 
         j, 
         opp, 
         tt, 
         f, 
         pop_f = pop * f, 
         jobs_f = opp * f,
         S_i, 
         a_i)

colnames(od_tt1) = c("Origin", "Pop.", "Dest.", "Jobs", "TT", "f(TT)", "Pop * f(TT)", "Jobs * f(TT)", "S_i", "a_i") #, "BFCA_i")

od_tt1 <- od_tt1 %>% as_hux(scientific=FALSE)
```

```{r toy-example-table}
table_toy  <- od_tt1 %>%
  set_bold(1, everywhere) %>%
  set_bottom_border(c(1,4,7), everywhere) %>%
  set_align(everywhere, c(1, 3), "left") %>%
  set_align(everywhere, c(2, 4:10), "center") %>%
  set_number_format(everywhere, 2, fmt_pretty()) %>%
  set_number_format(everywhere, 4, fmt_pretty()) %>%
  set_number_format(everywhere, 6, 6) %>%
  set_number_format(everywhere, 7:10, fmt_pretty(digits = 3, format = "f")) %>%
  merge_cells(2:4, 1) %>% merge_cells(5:7, 1) %>% merge_cells(8:10, 1) %>%
  merge_cells(2:4, 2) %>% merge_cells(5:7, 2) %>% merge_cells(8:10, 2) %>%
  merge_cells(2:4, 9) %>% merge_cells(5:7, 9) %>% merge_cells(8:10, 9) %>% 
  merge_cells(2:4, 10) %>% merge_cells(5:7, 10) %>% merge_cells(8:10, 10) %>% 
  set_width(1.2) %>%
  set_height(4) %>%
  set_right_border(everywhere, 1:9, brdr(1, "solid", "grey")) %>%
  set_caption("Summary description of synthetic example: Hansen-type accessibility and Shen-type accessibility with competition with beta = 0.1") %>%
  set_label("tab:synthetic-example")

font_size(table_toy) <- 7

table_toy[1:10,]
```

Table \ref{tab:synthetic-example} contains the information needed to calculate $S_i$ and $a_i$ for this example. We use a negative exponential impedance function with $\beta=0.1$ [see @shen1998, footnote (5)]:
$$
f(c_{ij}) = \exp(-\beta\cdot c_{ij})
$$
In the table we see that population centers $A$ and $B$ have equal Hansen-type accessibility ($S_A = S_B=$ 27,292 jobs). On the other hand, the isolated satellite town of $C$ has low accessibility ($S_C=$ 2,240 jobs). But center $B$, despite its high accessibility, is a large population center. $C$, in contrast, is smaller but also relatively isolated and has a balanced ratio of jobs (10,0000) to population (10,000). It is difficult from these outputs to determine whether the accessibility at $C$ is better or worse than that at $A$ or $B$.

The results are easier to interpret when we consider Shen-type accessibility. The results indicate that $a_A \approx$ 1.337 jobs per capita, $a_B \approx$ 0.888, and $a_C\approx$ 0.996. The latter value is sensible given the jobs-population balance of $C$. Center $A$ is relatively close to a large number of jobs (more jobs than the population of $A$). The opposite is true of $B$. According to @shen1998, the sum of the population-weighted accessibility $a_i$ is exactly equal to the number of jobs in the region following Shen's proof:
$$
\begin{array}{l}
50,000\times 1.3366693 \\
+ 150,000 \times 0.8880224 \\
+ 10,000 \times 0.9963171 = 210,000
\end{array}
$$

As mentioned earlier, this property under the Shen's definition of $P_i$ equaling _"people in location $i$ seeking opportunities"_ , gives the impression that jobs are allocated to each origin $i$ in their totality. In other words, Shen defines $P_i$ to mean $P_{ij}^*$ (i.e., the _effective opportunity-seeking population_ which is already discounted by travel behaviour) while it in fact should be simply understood as the full population at $i$ and it is discounted by $a_i$ which already has travel behaviour embedded in its formulation. As seen in column __Pop * f(TT)__ in Table \ref{tab:synthetic-example} (i.e., $P_{ij}^* = P_i\cdot f(c_{ij})$), the number of individuals from population center $A$ that are _willing to reach_ employment centers 1, 2, and 3 are 11,156, 2,489, and 2.27 respectively. Therefore, the effective opportunity-seeking population is $P_A^* = \sum_jP_{Aj}^*$ 13,647.27, which is considerably lower than the total population of $A$ (i.e., $P_A=$ 50,000).

<!-- NOTE: This may be unneeded? AP what do you think

To ensure that the calculations are consistent with the travel behavior given by the impedance function, the number of accessible jobs per capita should be multiplied by the population who are willing to travel to the employment centers; hence, instead of the nominal number of jobs in the region, the number of jobs the method actually allocates is: -->
<!-- $$ -->
<!-- \begin{array}{l} -->
<!-- (11,156.51 + 2,489.35 + 2.26)\times 1.3366693 \\ -->
<!-- + (7,468.06 + 33,469.52 + 6.81)\times 0.8880224\\ -->
<!-- + (4.54 + 4.54 + 2,231.20)\times 0.9963171 \approx 56,834.59 -->
<!-- \end{array} -->
<!-- $$ -->

<!-- \noindent which is less than one-third of the total number of jobs in the region.  -->

<!-- Use of the total zonal population in the calculation, instead of the effective opportunity-seeking population, gives the impression that all jobs are allocated - however the result is inconsistent with the travel behavior in the model. When the impedance-weighted opportunity-seeking population is used, it becomes apparent that the number of jobs allocated is not equal to the total number of jobs in the region. This feature of the method is not immediately apparent because the results are given in terms of opportunities per capita. -->

Consider the example in Table \ref{tab:synthetic-example-2}, where we increase the friction of distance by changing $\beta$ to 0.5 (compared to the previous value of 0.1; see Figure \ref{fig:impedance-functions-comparison}).
```{r comparison-impedance-functions-synthetic-example, fig.cap="\\label{fig:impedance-functions-comparison}Comparison of two impedance functions in the example."}
data.frame(tt = seq(0, 110, 1)) %>%
  mutate(f1 = exp(-0.1 * tt),
         f2 = exp(-1 * tt)) %>%
  pivot_longer(cols = -tt,
               names_to = "Function",
               values_to = "f") %>%
  mutate(Function = case_when(Function == "f1" ~ "beta = -0.1",
                              Function == "f2" ~ "beta = -0.5")) %>%
  ggplot() +
  xlab("TT") +
  ylab("f(TT)") +
  geom_line(aes(x = tt, 
                y = f,
                color = Function)) +
  theme_minimal()
```

```{r access-calcs-table-2, include=FALSE}
#table with all the accessibility calculations
# Impedance parameter
b <- 1

# Calculate impedance function
od_tt <- od_tt %>% mutate(f = exp(-b * tt))

# Level of service 
LOS_j <- od_tt %>%
  group_by(j) %>%
  summarize(opp = mean(opp),
            R_j = sum(pop * f),
            .groups = "drop") %>%
  mutate(LOS_j = opp/R_j)

# Hansen- and Shen-type accessibility
S <- od_tt %>%
  left_join(LOS_j %>% 
              dplyr::select(j, LOS_j, opp, R_j),
            by = "j") %>%
  group_by(i) %>%
  summarize(S_i = sum(opp.x * f), #first, hansen-type accessibility (unconstrained)
            a_i = sum(LOS_j * f)) #second, shen/2SFCA (singly constrained),
```

```{r toy-example-table-creation-2, include=FALSE}
od_tt1 <- merge(od_tt, 
                S, 
                by="i", 
                all.x = TRUE) %>%
  transmute(i, 
         pop, 
         j, 
         opp, 
         tt, 
         f, 
         pop_f = pop * f, 
         jobs_f = opp * f,
         S_i, 
         a_i) %>%
  mutate(f = ifelse(f < 0.001, "< 0.001", round(f, 3)),
         pop_f = ifelse(pop_f < 0.001, "< 0.001", round(pop_f, 3)),
         jobs_f = ifelse(jobs_f < 0.001, "< 0.001", round(jobs_f, 3)))

colnames(od_tt1) = c("Origin", "Pop.", "Dest.", "Jobs", "TT", "f(TT)", "Pop * f(TT)", "Jobs * f(TT)", "S_i", "a_i") #, "BFCA_i")

od_tt1 <- od_tt1  %>%
  as_hux(scientific=TRUE)
```

```{r toy-example-table-2}
table_toy  <- od_tt1 %>%
  set_bold(1, everywhere) %>%
  set_bottom_border(c(1,4,7), everywhere) %>%
  set_align(everywhere, c(1, 3), "left") %>%
  set_align(everywhere, c(2, 4:10), "center") %>%
  set_number_format(everywhere, 2, fmt_pretty()) %>%
  set_number_format(everywhere, 4, fmt_pretty()) %>%
  #set_number_format(everywhere, 6:8, 6) %>%
  set_number_format(everywhere, 9:10, fmt_pretty(digits = 3, format = "f")) %>%
  merge_cells(2:4, 1) %>% merge_cells(5:7, 1) %>% merge_cells(8:10, 1) %>%
  merge_cells(2:4, 2) %>% merge_cells(5:7, 2) %>% merge_cells(8:10, 2) %>%
  merge_cells(2:4, 9) %>% merge_cells(5:7, 9) %>% merge_cells(8:10, 9) %>% 
  merge_cells(2:4, 10) %>% merge_cells(5:7, 10) %>% merge_cells(8:10, 10) %>% 
  set_width(1.3) %>%
  set_height(4) %>%
  set_right_border(everywhere, 1:9, brdr(1, "solid", "grey")) %>%
  set_caption("Summary description of synthetic example: Hansen-type accessibility and Shen-type accessibility with competition with beta = 0.5") %>%
  set_label("tab:synthetic-example-2")

font_size(table_toy) <- 7

table_toy[1:10,]
```

<!-- NOTE: this needs to be explained better, discuss it's purpose with AP --> 
As expected, Hansen-type accessibility drops, quite dramatically in this case: the friction of distance is so high that few opportunities are within reach. In contrast, Shen-type accessibility converges to the jobs/population ratio. Notice however that the population from center $A$ that effectively seeks opportunities at center 1 has collapsed to 0.015, while the number of jobs allocated from center 1 to $A$ given the friction of distance is only 0.031. So yes, the jobs/population ratio is 2, but only for a tiny fraction of the population of $A$ that effectively seeks opportunities at center 1.

<!-- NOTE: think about this...--> 
In what follows, we propose an alternative derivation of competitive accessibility that resolves the potential for misinterpretation as the way in which it accounts for population, opportunities, and travel behaviour is logically consistent and hence the resulting value, is more interpretable. 

# Introducing spatial availability: a singly-constrained measure of accessibility

In brief, we define the _spatial availability_ at $i$ ($V_{i}$) as the proportion of all opportunities $O$ that are allocated to $i$ from all destinations $j$:
$$
V_i = \sum_{j=1}^KO_jF^t_{ij}
$$

\noindent where:

-   $F^t_{ij}$ is a balancing factor that depends on the population and cost of movement in the system.
-   $O_j$ is the number of opportunities at $j$.
-   $V_i$ is the number of spatially available opportunities from the perspective of $i$.

The general form of spatial availability is also as a sum, and the fundamental difference with Hansen- and Shen-type accessibility is that opportunities are allocated proportionally. Balancing factors $F_{ij}$ allocate opportunities to $i$ in proportion to the size of the population of the different competing centers (the mass effect of the gravity model), and the cost of reaching opportunities (the impedance effect). In the next two subsections, we explain the intuition behind the method before defining it in full.

## Proportional allocation by population

According to the gravity modelling framework, the potential for interaction depends on the mass (i.e., the population) and the friction of distance (i.e., the impedance function). We begin by describing the proposed proportional allocation mechanism based on demand by population. The total population in the example is 210,000. The proportion of the population by population center is as follows:
$$
\begin{array}{l}
F^p_A = \frac{50,000}{210,000}\\
\\
F^p_B = \frac{150,000}{210,000}\\
\\
F^p_C = \frac{10,000}{210,000}\\
\end{array}
$$

Jobs are allocated proportionally from each employment center to each population center depending on their population sizes as per the balancing factors $F^p_i$. In this way, employment center 1 allocates $100,000\cdot \frac{50,000}{210,000}= 23,809.52$ jobs to $A$; $100,000\cdot \frac{150,000}{210,000}= 71,428.57$ jobs to $B$; and $100,000\cdot \frac{10,000}{210,000}= 7,142.857$ jobs to $C$. Notice how this mechanism ensures that the total number of jobs at employment center 1 is preserved at 100,000.

We can verify that the number of jobs allocated is consistent with the total number of jobs in the system:
$$
\begin{array}{l}
\text{Employment center 1 to population centers A, B, and C: }\\
100,000 \cdot \frac{50,000}{210,000} + 100,000 \cdot \frac{150,000}{210,000} + 100,000 \cdot \frac{10,000}{210,000} = 100,000\\
\\
\text{Employment center 2 to population centers A, B, and C: }\\
100,000 \cdot \frac{50,000}{210,000} + 100,000 \cdot \frac{150,000}{210,000} + 100,000 \cdot \frac{10,000}{210,000} = 100,000\\
\\
\text{Employment center 3 to population centers A, B, and C: }\\
10,000 \cdot \frac{50,000}{210,000} + 10,000 \cdot \frac{150,000}{210,000} + 10,000 \cdot \frac{10,000}{210,000} = 10,000\\
\end{array}
$$

In the general case where there are $N$ population centers in the region, we define the following population-based balancing factors:
```{=tex}
\begin{equation}
\label{eq:population-balancing-factor}
F^p_{i} = \frac{P_{i}^\alpha}{\sum_{i=1}^N P_{i}^\alpha}
\end{equation}
```

Balancing factor $F^p_{i}$ corresponds to the proportion of the population in origin $i$ relative to the population in the region. On the right hand side of the equation, the numerator $P_{i}^\alpha$ is the population at origin $i$. The summation in the denominator is over $i=1,\cdots,N$, and adds up to the total population of the region. Notice that we incorporate an empirical parameter $\alpha$. The role of $\alpha$ is to modulate the effect of demand by population. When $\alpha <1$, opportunities are allocated more rapidly to smaller centers relative to larger ones; $\alpha>1$ achieves the opposite effect.

Balancing factor $F^p_{i}$ can now be used to proportionally allocate a share of available jobs at $j$ to origin $i$. The number of jobs available to $i$ from $j$ balanced by population shares is defined as follows:
$$
V^p_{ij} = O_j\frac{F^p_{i}}{\sum_{i=1}^K F^p_{i}}
$$

In the general case where there are $J$ employment centers, the total number of jobs available from all destinations to $i$ is simply the sum of $V^p_{ij}$ over $j=1,\cdots, J$:
$$
V^p_{i} = \sum_{j=1}^J O_j\frac{F^p_{i}}{\sum_{i=1}^K F^p_{i}}
$$

Since the factor $F^p_{i}$, when summed over $i=1,\cdots,N$ always equals to 1 (i.e., $\sum_{i=1}^{N} F^p_{i} = 1$), the sum of all spatially available jobs equals $O$, the total number of opportunities in the region:
$$
\begin{array}{l}
\sum_{i=1}^N V^p_i =\sum_{i=1}^N\sum_{j=1}^JO_j\frac{F^p_{i}}{\sum_{i=1}^N F^p_{i}}\\
=\sum_{i=1}^N \frac{F^p_{i}}{\sum_{i=1}^N F^p_{i}}\cdot\sum_{j=1}^JO_j\\
=\sum_{j=1}^J O_j = O
\end{array}
$$
The terms $F^p_{i}$ act here as the balancing factors of the gravity model when a single constraint is imposed [i.e., to ensure that the sums of columns are equal to the number of opportunities per destination, see @ortuzar_2011_modelling, pp. 179-180 and 183-184]. As a result, the sum of spatial availability for all population centers equals the total number of opportunities.

The discussion so far concerns only the mass effect (i.e., population size) of the gravity model. In addition, the potential for interaction is thought to decrease with increasing cost, so next we define similar balancing factors but based on the impedance.

## Proportional allocation by cost

Clearly, using only balancing factors $F^p_{i}$ to calculate spatial availability $V^p_i$ does not account for the cost of reaching employment centers. Consider instead a set of balancing factors $F^c_{ij}$ that account for the friction of distance:
$$
\begin{array}{l}
F^c_{A1} = \frac{0.223130}{0.223130 + 0.049787 + 0.000045} = 0.8174398\\
F^c_{B1} = \frac{0.049787}{0.223130 + 0.049787 + 0.000045} = 0.1823954\\
F^c_{C1} = \frac{0.000045}{0.223130 + 0.049787 + 0.000045} = 0.0001648581\\
\end{array}
$$

Balancing factors $F^c_{ij}$ use the impedance function to proportionally allocate more jobs to closer population centers, that is, to those with populations _more willing to reach the jobs_. Indeed, the factors $F^c_{ij}$ can be thought of as the proportion of the population at $i$ willing to travel to destination $j$, conditional on the travel behavior as given by the impedance function.

In our example, the number of jobs allocated from employment center 1 to population center $A$ is $100,000\times 0.8174398 = 81,743.98$; to population center $B$ is $100,000\times 0.1823954 = 18,239.54$; and to population center $C$ is $100,000\times 0.0001648581 = 16.48581$. We see once more that the total number of jobs at the employment center is preserved at 100,000. In this example, the proportional allocation mechanism assigns the largest share of jobs to population center $A$, which is the closest to employment center 1, and the smallest to the more distant population center $C$.

In the general case where there are $N$ population centers and $J$ employment centers in the region, we define the following impedance-based balancing factors:
```{=tex}
\begin{equation}
\label{eq:impedance-balancing-factor}
F^c_{ij} = \frac{f(c_{ij})}{\sum_{i=1}^N f(c_{ij})}\\
\end{equation}
```

The total number of jobs available to $i$ from $j$ according to impedance is defined as follows:
$$
V^c_{ij} = O_j\frac{F^c_{i}}{\sum_{i=1}^N F^c_{i}}
$$

The total number of jobs available to $i$ from all destinations is:
$$
V^c_{i} = \sum_{j=1}^J O_j\frac{F^c_{i}}{\sum_{i=1}^N F^c_{i}}
$$

Like the population-based allocation factors, $F^c_{i}$ summed over $i=1,\cdots,N$ always equals to 1 (i.e., $\sum_{i=1}^{N} F^c_{i} = 1$). As before, the sum of all spatially available jobs equals $O$, the total number of opportunities in the region:
$$
\begin{array}{l}
\sum_{i=1}^N V^c_i =\sum_{i=1}^N\sum_{j=1}^JO_j\frac{F^c_{i}}{\sum_{i=1}^N F^c_{i}}\\
=\sum_{i=1}^N \frac{F^c_{i}}{\sum_{i=1}^N F^c_{i}}\cdot\sum_{j=1}^JO_j\\
=\sum_{j=1}^J O_j = O
\end{array}
$$

We are now ready to more formally define spatial availability with due consideration to both mass and cost effects.

## Assembling mass and impedance effects

Population and the cost of travel are both part of the gravity modelling framework. Since the balancing factors defined in the preceding sections are proportions (alternatively probabilities), they can be combined multiplicatively to obtain their joint effect (alternatively, the joint probability of allocating opportunities). This idea is captured by Equation (\ref{eq:balancing-factors}), where $F^p_{i}$ is the population-based balancing factor that grants a larger share of the existing opportunities to larger centers and $F^c_{ij}$ is the impedance-based balancing factor that grants a larger share of the existing opportunities to closer centers. This is in line with the tradition of gravity modeling.
```{=tex}
\begin{equation}
\label{eq:balancing-factors}
F^t_{ij} = \frac{F^p_{i} \cdot F^c_{ij}}{\sum_{i=1}^N F^p_{i} \cdot F^c_{ij}}
\end{equation}
```

\noindent with $F^p_{i}$ and $F^c_{i}$ as defined in Equations (\ref{eq:population-balancing-factor}) and (\ref{eq:impedance-balancing-factor}) respectively.

Balancing factors $F^t_{ij}$ are used to proportionally allocate jobs from $j$ to $i$. The spatial availability is given by Equation (\ref{eq:spatial-availability}).
```{=tex}
\begin{equation}
\label{eq:spatial-availability}
V_{i} = \sum_{j=1}^J O_j\ F^t_{ij}
\end{equation}
```

The terms in Equation \ref{eq:spatial-availability} are as follows:

-   $F^t_{ij}$ is a balancing factor as defined in Equation (\ref{eq:balancing-factors}).
-   $i$ is a set of origin locations in the region $i = 1,\cdots, N$.
-   $j$ is a set of destination locations in the region $j = 1,\cdots,J$.
-   $O_j$ is the number of opportunities at location $j$.
-   $V_{i}$ is the spatial availability at $i$.

Notice that, unlike $S_i$ in Hansen-type accessibility (Equation (\ref{eq:conventional-accessibility})), the population enters the calculation of $V_{i}$ through $F^p_i$. Returning to Shen's example in Figure \ref{fig:plot-toy-example}, Table \ref{tab:synthetic-example-spatial-availability} contains the information needed to calculate $V_i$.

```{r toy-example-spatial-availability-table-creation, include=FALSE}
# Impedance parameter
b <- 0.1

# Calculate impedance function
od_tt2 <- od_tt %>% 
  mutate(f = exp(-b * tt))

od_tt2 <- od_tt2 %>%
  mutate(catch = 1) %>%
  sp_avail_detailed(o_id = i,
                    d_id = j, 
                    pop = pop,
                    opp = opp,
                    r = catch,
                    f = f, 
                    alpha = 1) %>%
  transmute(i, 
         pop, 
         j, 
         opp, 
         tt, 
         f, 
         F_p = f_p, 
         F_c = f_c, 
         F_t = f_t,
         V_ij)

V_i <- od_tt2 %>%
  group_by(i) %>%
  summarize(V_i = sum(V_ij))

od_tt2 <- od_tt2 %>%
  left_join(V_i,
            by = "i")

colnames(od_tt2) = c("Origin", "Pop.", "Dest.", "Jobs", "TT", "f(TT)", "F^p", "F^c", "F", "V_ij", "V_i")

od_tt2 <- od_tt2 %>% 
  as_hux(scientific=FALSE)
```

```{r toy-example-spatial-availability-table}
table_toy_2  <- od_tt2 %>%
  set_bold(1, everywhere) %>%
  set_bottom_border(c(1,4,7), everywhere) %>%
  set_align(everywhere, c(1, 3), "left") %>%
  set_align(everywhere, c(2, 4:10), "center") %>%
  set_number_format(everywhere, 2, fmt_pretty()) %>%
  set_number_format(everywhere, 4, fmt_pretty()) %>%
  set_number_format(everywhere, 6:9, 6) %>%
  set_number_format(everywhere, 10:11, fmt_pretty(digits = 2, format = "f")) %>%
  merge_cells(2:4, 1) %>% merge_cells(5:7, 1) %>% merge_cells(8:10, 1) %>%
  merge_cells(2:4, 2) %>% merge_cells(5:7, 2) %>% merge_cells(8:10, 2) %>%
  merge_cells(2:4, 11) %>% merge_cells(5:7, 11) %>% merge_cells(8:10, 11) %>% 
  set_width(1.2) %>%
  set_height(4) %>%
  set_right_border(everywhere, 1:10, brdr(1, "solid", "grey")) %>%
  set_caption("Summary description of synthetic example: spatial availabilityy") %>%
  set_label("tab:synthetic-example-spatial-availability")

font_size(table_toy_2) <- 7

table_toy_2[1:10,]
```

In Table \ref{tab:synthetic-example-spatial-availability}, column __V_ij__ are the jobs available to each origin from each employment center. In this column $V_{A1}=$ 59,901 is the number of jobs available at $A$ from employment center 1. Column __V_i__ (i.e., $\sum_{j=1}^JV_{ij}$) gives the total number of jobs available to origin $i$. We can verify that the total number of jobs available is consistent with the total number of jobs in the region (with some small rounding error):
$$
\sum_{i=1}^N V_i = 66,833 + 133,203 + 9,963 \approx 210,000 
$$

Compare the calculated values of $V_i$ to column __S_i__ (Hansen-type accessibility) in Table \ref{tab:synthetic-example}. The spatial availability values are more intuitive. Recall that population centers $A$ and $B$ had identical Hansen-type accessibility to employment opportunities. According to $V_i$, population center $A$ has greater job availability due to: 1) its close proximity to employment center 1; combined with 2) less competition (i.e., a majority of the population have to travel longer distances to reach employment center 1). Job availability is lower for population center $B$ due to much higher competition (150,000 people can reach 100,000 jobs at equal cost). And center $C$ has almost as many jobs available as it has population. 

As discussed above, Hansen-type accessibility is not designed to preserve the number of jobs in the region. Shen-type accessibility ends up preserving the number of jobs in the region but the definitions of variables are internally inconsistent; the only way it preserves the number of jobs is if the effect of the impedance function is ignored within the definition of $P_i$ when expanding the values of jobs per capita to obtain the total number of opportunities. The proportional allocation procedure described above, in contrast, consistently returns a number of jobs available that matches the total number of jobs in the system. 

Since the jobs spatially available are consistent with the jobs in the region, it is possible to define a measure of spatial availability per capita:
```{=tex}
\begin{equation}
\label{eq:SA-per-capita}
v_i = \frac{V_i}{P_i}
\end{equation}
```

And, since the jobs are preserved, it is possible to use the regional jobs per capita as a benchmark to compare the spatial availability of jobs per capita at each origin:
```{=tex}
\begin{equation}
\label{eq:Regional-jobs-per-capita}
\frac{\sum_{j=1}^J O_j}{\sum_{i=1}^N P_i}
\end{equation}
```

In the example, since the population is equal to the number of jobs, the regional value of jobs per capita is $1.0$. To complete the illustrative example, the spatial availability of jobs per capita by origin is:
```{r SA-6, eval=TRUE, include=FALSE}
V_i$V_i[1]/50000
V_i$V_i[2]/150000
V_i$V_i[3]/10000
```

```{=tex}
\begin{equation}
\label{eq:SA-per-capita-2populations}
\begin{array}{l}
v_{1} = \frac{V_1}{P_1} =  \frac{66,833.47}{50,000} = 1.337\\
v_{2} =  \frac{V_{2}}{P_2} =  \frac{133,203.4}{150,000} = 0.888\\
v_{3} =  \frac{V_{3}}{P_3} =  \frac{9,963.171}{10,000} = 0.996\\
\end{array}
\end{equation}
```

We can see that population center $A$ has fewer jobs per capita than the regional benchmark, center $B$ has more, and center $C$ is at parity. Remarkably, the spatial availability per capita matches the values of $a_i$ in Table \ref{tab:synthetic-example}. Appendix A has a proof of the mathematical equivalence between the two measures. It is interesting to notice how @weibull_axiomatic_1976, @shen1998, as well as this paper, all reach identical expressions starting from different assumptions; this effect is known as _equifinality_ [see @ortuzar_2011_modelling, p. 333; and @williams_hall_1981]. Interestingly, this result means that Shen-type accessibility and 2SFCA can be re-conceptualized as singly-constrained accessibility measures.

## Why does proportional allocation matter?

Having shown that Shen-type accessibility and spatial availability produce equifinal results, it is reasonable to ask whether the distinction between them is of any importance.

<!-- is this correct explanation? --> 
Conceptually, we would argue that the incorrect interpretation of variables leads to internal inconsistency in the calculation of total opportunities in @shen1998: this points to a deeper issue that is only evident when we consider the internal values of the method. To illustrate, Table \ref{tab:synthetic-example} shows results of $a_i$ that are reasonable (and they match exactly the spatial availability per capita). But when we dig deeper, these results mask potentially misleading values of jobs allocated and taken. In addition, the internal values also lead to estimates of the impact of accessibility that are deceptive [see @sarlas_2020_betweenness]. For example, the estimated system-wide cost of travel considering the jobs allocated by $a_i$ in Table \ref{tab:synthetic-example} is as follows:
$$
\begin{array}{l}
11,157\times 15 \text{ min} + 2,489\times 30 \text{ min} + 2.27\times 100 \text{ min}\\
7,468\times 30 \text{ min} + 33,470\times 15 \text{ min} + 6.81\times 100 \text{ min}\\
0.454\times 100 \text{ min} + 0.454\times 100 \text{ min} + 2,231\times 15 \text{ min} = 1,002,581\text{ min}
\end{array}
$$

In contrast, the estimated system-wide cost of travel according to $V_i$ in Table \ref{tab:synthetic-example-spatial-availability} is as follows:
$$
\begin{array}{l}
59,901\times 15 \text{ min} + 6,923\times 30 \text{ min} + 10\times 100 \text{ min}\\
40,097\times 30 \text{ min} + 93,076\times 15 \text{ min} + 30\times 100 \text{ min}\\
2.4\times 100 \text{ min} + 1.3\times 100 \text{ min} + 9,959\times 15 \text{ min} = 3,859,054\text{ min}
\end{array}
$$

Therefore, not only does the Shen-type measure effectively allocate fewer than 56,835 out of a total of 210,000 jobs in the example, it also gives a biased estimate of the potential cost of travel in the system by obscuring the number of jobs not allocated.

# Empirical example of Toronto

In this section we illustrate the application of spatial availability through an empirical example. For this, we use population and employment data from the Greater Toronto and Hamilton Area (GTHA) in Ontario, Canada. This is the largest metropolitan region in Canada. For comparison, we calculate Hansen- and Shen-type accessibility, as well as the proposed spatial availability measure. 

## Data

We obtained population and employment data from the 2016 Transportation Tomorrow Survey (TTS). This survey collects representative urban travel information from 20 municipalities contained within the GTHA area in the southern part of Ontario, Canada (see Figure \ref{fig:TTS-16-survey-area}) [@data_management_group_tts_2018]. The data set includes Traffic Analysis Zones (TAZ) (n=`r round(length(TTS2016R::ggh_taz$GTA06), 3) %>% prettyNum(big.mark = ",")`), the number of jobs (n=`r round(sum(TTS2016R::ggh_taz$jobs), 3) %>% prettyNum(big.mark = ",")`) and workers (n=`r round(sum(TTS2016R::ggh_taz$workers), 3) %>% prettyNum(big.mark = ",")`) at each origin and destination. The TTS data is based on a representative sample of between 3% to 5% of households in the GTHA and is weighted to reflect the population covering the study area has a whole [@data_management_group_tts_2018]. 

To generate the travel cost for these trips, travel times between origins and destinations are calculated for car travel using the `R` package {r5r} [@r5r_2021] with a street network retrieved from OpenStreetMap. For the calculations a 3 hr travel time threshold was selected as it captures 99% of population-employment pairs (see the travel times summarized in Figure \ref{fig:TTS-16-survey-area}). This method does not account for traffic congestion or modal split, which can be estimated through other means [e.g., @allen_suburbanization_2021; @higgins2021changes]. For simplicity, we carry on with the assumption that all trips are taken by car in uncongested travel conditions. All data and data preparation steps are documented and can be freely explored in the companion open data product [{TTS2016R}](https://soukhova.github.io/TTS2016R/).

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# grouping the planning boundaries/municipalities so they make up the 20 regions in the TTS 2016. Note: st_buffer is used as there are small existing gaps between some boundaries. st_buffer of 10 m is enough to widen all boundaries and complete the st_union without issue.
group_ggh_pd_poly <- TTS2016R::ggh_pd %>% st_buffer(10) %>% group_by(REGION) %>% 
  summarize(REGION_name = first(REGION_name),
            geometry = st_union((geometry)))

# creating an object of centroids for each region - this will be used to label polygons on the map
group_ggh_pd <- sf::st_centroid(group_ggh_pd_poly) 
points <- sf::st_coordinates(group_ggh_pd) %>% data.frame() 
group_ggh_pd <- cbind(group_ggh_pd, points)

## manually readjusting the X and Y coordinate of "County of Peterborough" and "Brant" as they overlap some cities
group_ggh_pd[group_ggh_pd$REGION_name=="Brant", "X"] <- 544000.0
group_ggh_pd[group_ggh_pd$REGION_name=="Brant", "Y"] <- 4767466

group_ggh_pd[group_ggh_pd$REGION_name=="Peterborough County", "Y"] <- 4921000
```
```{r, echo=FALSE, message=FALSE, warning=FALSE, include = FALSE}
#plot 
TTS_area_plot <- ggplot() +
  geom_sf(data = TTS2016R::ggh_pd, color = "darkgray",
          aes(fill = REGION_name)) +
  scale_fill_manual(values = viridis::viridis(20)) +
  geom_sf(data = group_ggh_pd_poly, 
          color = "black", fill = NA, size = 0.7) +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot
                   height = unit(0.15, "cm")) + 
  geom_shadowtext(data = group_ggh_pd,
                  aes(x = X, y = Y, label = REGION_name),
                  size = 3.5,
                  nudge_y = 3000,
                  nudge_x = 2000) +
  theme_void() +
  theme(legend.position = "none",
        axis.title = element_blank()) 

# ggsave("images/TTS16-survey-area.png")
```
```{r creating-desc-stats-table}
#forming a complete descriptive statistic table

Statistics <- data.frame("Statistic" = c("Min.", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max.", "NA's"))

Trips <- data.frame("Trips" = c(summary(od_ft_tt$trips)[[1]] %>% round(), 
                                   summary(od_ft_tt$trips)[[2]] %>% round(),  
                                   summary(od_ft_tt$trips)[[3]] %>% round(), 
                                   summary(od_ft_tt$trips)[[4]] %>% round(), 
                                   summary(od_ft_tt$trips)[[5]] %>% round(),
                                   summary(od_ft_tt$trips)[[6]]%>% round(),
                                   NA))

Travel_time <- data.frame("TT" = c(summary(od_ft_tt$travel_time)[[1]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[2]] %>% round(),  
                                               summary(od_ft_tt$travel_time)[[3]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[4]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[5]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[6]] %>% round(),  
                                               3507)) 

# TAZ_Area <- data.frame("TAZ_Area" = c(summary(ggh_taz$AREA)[[1]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[2]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[3]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[4]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[5]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[6]] %>% round(1), 
#                                       NA))

Workers <- data.frame("Workers" = c(summary(ggh_taz$workers)[[1]] %>% round(), 
                                    summary(ggh_taz$workers)[[2]] %>% round(), 
                                    summary(ggh_taz$workers)[[3]] %>% round(), 
                                    summary(ggh_taz$workers)[[4]] %>% round(), 
                                    summary(ggh_taz$workers)[[5]] %>% round(), 
                                    summary(ggh_taz$workers)[[6]] %>% round(), 
                                    NA))

Jobs <- data.frame("Jobs" = c(summary(ggh_taz$jobs)[[1]] %>% round(), 
                              summary(ggh_taz$jobs)[[2]] %>% round(), 
                              summary(ggh_taz$jobs)[[3]] %>% round(), 
                              summary(ggh_taz$jobs)[[4]] %>% round(), 
                              summary(ggh_taz$jobs)[[5]] %>% round(), 
                              summary(ggh_taz$jobs)[[6]] %>% round(), 
                              NA)) 

desc_stats <- cbind(Statistics, Trips, Travel_time, Workers, Jobs)
```

```{r, TTS-16-survey-area, echo=FALSE, fig.cap="\\label{fig:TTS-16-survey-area}TTS 2016 study area (GTHA, Ontario, Canada) along with the descriptive statistics of the trips, calculated origin-destination car travel time (TT), workers per TAZ, and jobs per TAZ. Contains 20 regions (black boundaries) and sub-regions (dark gray boundaries).", out.width="80%", fig.show='hold', fig.align='center'}
TTS_area_plot <- TTS_area_plot + annotate(geom = "table",
            x = 915000, y = 4880000, 
           label = list(desc_stats))
ggsave("images/TTS16-survey-area.png")
knitr::include_graphics("images/TTS16-survey-area.png")

png()
```

## Calibration of an impedance function

In the synthetic example introduced in a preceding section, we used a negative exponential function with the parameter reported by @shen1998. For the empirical example, we calibrate an impedance function on the trip length distribution (TLD) of commute trips. Briefly, a TLD represents the proportion of trips that are taken at a specific travel cost (e.g., travel time); this distribution is commonly used to derive impedance functions in accessibility research [@lopez_2017_spatial; @horbachov_theoretical_2018; @batista_estimation_2019].

The empirical and theoretical TLD for this data set are represented in the top-left panel of Figure \ref{fig:TLD-Gamma-plot}. Maximum likelihood estimation and the Nelder-Mead method for direct optimization available within the {fitdistrplus} package [@fitdistrplus_2015] were used. Based on goodness-of-fit criteria and diagnostics the gamma distribution was selected (see Figure \ref{fig:TLD-Gamma-plot}).

<!--NOTE: maybe fit the impedance function for only toronto trips? not full GTHA-->

```{r data-for-impedance, include=FALSE}
# remove all NA trips from dataset and set all 0min travel times to 0.1 min
od_ft_tt  <- od_ft_tt %>% 
  filter( !is.na(travel_time)) %>% 
  mutate(travel_time = ifelse(travel_time == 0, 0.1, travel_time))
all_tt <- od_ft_tt  %>% 
  dplyr::select(trips, travel_time)

sum((od_ft_tt$trips))

all_tt <- all_tt[rep(seq_len(dim(all_tt)[1]), all_tt$trips), 2]
```

```{r fitting-impedance-function}
# using fitdist function to fit a distribution using the default maximum likelihood estimation method and Nelder-Mead method for direct optimization


gamma_ <- fitdistrplus::fitdist(data=all_tt, "gamma", method="mle", optim.method="Nelder-Mead") 


#lnorm_ <- fitdistrplus::fitdist(data=all_tt, "lnorm", method="mle", optim.method="Nelder-Mead")
#norm_ <-fitdistrplus::fitdist(data=all_tt, "norm", method="mle", optim.method="Nelder-Mead")
# #exp_ <- fitdistrplus::fitdist(data=all_tt, "exp", method="mle", optim.method="Nelder-Mead")
# pois_ <- fitdistrplus::fitdist(data=all_tt, "pois", method="mle", optim.method="Nelder-Mead") 
# nbinom_ <- fitdistrplus::fitdist(data=all_tt, "nbinom", method="mle", optim.method="Nelder-Mead")
# geom_ <- fitdistrplus::fitdist(data=all_tt, "geom", method="mle", optim.method="Nelder-Mead")
# beta_ <- fitdistrplus::fitdist(data=all_tt, "beta", method="mle", optim.method="Nelder-Mead")
# logis_ <- fitdistrplus::fitdist(data=all_tt, "logis", method="mle", optim.method="Nelder-Mead")
# plot(gamma_)
# plot(pois_)
# plot(nbinom_)
# plot(geom_)
# plot(beta_)
# plot(logis_)
```

```{r save-impedance-plot, include=FALSE}
# For some reason plot(gamma_) does not play well with knitr, so instead we save the figure and then include it as a graphic in the following chunk
png("images/impedance_function.png")
plot(gamma_)
dev.off()
```

```{r TLD-Gamma-plot, fig.cap="\\label{fig:TLD-Gamma-plot}Car trip length distribution and calibrated gamma distribution impedance function (red line) with associated Q-Q and P-P plots. Based on TTS 2016.", fig.show='hold', fig.align='center', out.width="80%"}
knitr::include_graphics("images/impedance_function.png")
```

The gamma distribution is defined in Equation (\ref{gamma-dist}), where we see that it depends on a shape parameter $\alpha$ and a rate parameter $\beta$. The estimated values of these paramters are $\alpha=$ `r round(gamma_$estimate[1], 3)` and $\beta =$ `r round(gamma_$estimate[2], 3)`.

```{=tex}
\begin{equation}
\label{gamma-dist}
\begin{array}{l} 
f(x, \alpha, \beta) = \frac {x^{\alpha-1}e^{-\frac{x}{\beta}}}{ \beta^{\alpha}\Gamma(\alpha)} \quad \text{for } 0 \leq x \leq \infty\\

\Gamma(\alpha) =  \int_{0}^{\infty} x^{\alpha-1}e^{-x} \,dx\\
\end{array}
\end{equation}
```

```{r prepare-table-for-calc-accessibility-Toronto}
#select the toronto muni boundary
toronto_muni_bound <- group_ggh_pd_poly %>% filter(REGION_name == "Toronto")

#indicate which zones are within or intersect the Toronto Municipality
TO_taz <- ggh_taz %>%
  filter(st_intersects(., toronto_muni_bound, sparse = FALSE)[,1]) %>% 
  dplyr::select(GTA06, AREA, jobs) %>%
  mutate(TAZToronto = "Yes")

# transfer calibrated impedance function values to OD matrix
od_ft_tt <- od_ft_tt %>%
  mutate(f = dgamma(travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"]))

#add the number of jobs and workers to the od_ft_tt matrix
od_ft <- od_ft_tt %>% 
  merge(ggh_taz %>% 
          dplyr::select(GTA06, workers) %>% 
          st_drop_geometry(),
        by.x = "Origin", 
        by.y="GTA06", 
        all.x = TRUE)

od_ft <- od_ft %>% 
  merge(ggh_taz %>% 
          dplyr::select(GTA06, jobs) %>% 
          st_drop_geometry(),
        by.x = "Destination", 
        by.y="GTA06", all.x = TRUE)

#jobs and origins at destinations IN Toronto; i.e., workers who are from Toronto but travel outside of Toronto and workers who travel to Toronto from outside are not included. They are considered edge effects.
TO_od_ft <- od_ft %>% 
  mutate(In_dest = ifelse(Destination %in% TO_taz$GTA06, 1, 0),
         In_org = ifelse(Origin %in% TO_taz$GTA06, 1, 0)) %>%
  filter(In_dest == 1 & In_org == 1) %>%
  dplyr::select(-c(In_dest, 
                   In_org))
```

```{r calc-accessibility-Toronto}
#table with all the accessibility calculations
TO_od_ft <- TO_od_ft %>%
  transmute(Origin, 
         workers, 
         Destination, 
         jobs, 
         travel_time, 
         f, 
         workers_f = workers * f, # <-- This is the opportunity-seeking population in Shen-type accessibility
         jobs_f = jobs * f) # <- Needed to calculate Hansen-type accessibility

# 
TO_workers <- TO_od_ft %>%
  distinct(Origin,
           workers)

#
TO_jobs <- TO_od_ft %>%
  distinct(Destination,
           jobs)

# Level of service for Shen-type accessibility
LOS_j <- TO_od_ft %>%
  group_by(Destination) %>%
  summarize(R_j = first(jobs)/sum(workers_f),
            .groups = "drop")

# Hansen-type accessibility
S_i <- TO_od_ft %>%
  group_by(Origin) %>%
  summarize(S_i = sum(jobs_f)) # Hansen-type accessibility (unconstrained)

# Shen-type accessibility
a_i <- TO_od_ft %>%
  left_join(LOS_j,
            by = "Destination") %>%
  group_by(Origin) %>%
  summarize(a_i = sum(R_j * f),  #Shen/2SFCA
            .groups = "drop")
  
# Opportunity seeking population by origin in Shen-type measure
osp_i <- TO_od_ft %>%
  group_by(Origin) %>%
  summarise(osp = sum(workers_f),
            total_population = first(workers))
  
# Spatial availabiity disaggregated
V_ij <- TO_od_ft %>% # then Spatial Availability (singly constrained)
  mutate(r = 1) %>%
  sp_avail_detailed(o_id = Origin,
                    d_id = Destination, pop = workers, opp = jobs, r = r, f = f, alpha = 1.0) #alpha 1.54 

# Spatial availabiity
V_i <- V_ij %>%
  group_by(Origin) %>%
  summarise(V_i = sum(V_ij))
```

```{r join-results}
# Join all results to traffic analysis zones
TO_taz_acc <- TO_taz %>%
  dplyr::select(-c(AREA, jobs, TAZToronto)) %>%
  left_join(osp_i,
            by = c("GTA06" = "Origin")) %>%
  left_join(TO_workers,
            by = c("GTA06" = "Origin")) %>%
  left_join(TO_jobs,
            by = c("GTA06" = "Destination")) %>%
  left_join(S_i,
            by = c("GTA06" = "Origin")) %>%
  left_join(a_i,
            by = c("GTA06" = "Origin")) %>%
  left_join(V_i,
            by = c("GTA06" = "Origin")) %>%
  mutate(jobs = replace_na(jobs, 0),
         s_i = S_i/total_population,
         v_i = V_i/total_population,
         # Shen=type accessibility in number of jobs after multiplying by total population 
         A1_i = a_i * total_population,
         # Shen=type accessibility in number of jobs after multiplying by opportunity-seeking population
         A2_i = a_i * osp)
```

```{r verify-employment, include=FALSE}
# Regional total number of jobs
TO_taz_acc %>%
  st_drop_geometry() %>%
  summarize(jobs = sum(jobs))

# Verify that A_i times workers adds up to regional total
TO_taz_acc %>%
  st_drop_geometry() %>%
  #transmute(jobs = A_i * workers) %>%
  summarize(jobs = sum(A1_i, 
                       na.rm = TRUE))
```

```{r verify-population, include=FALSE}
# Regional total population
TO_taz_acc %>%
  st_drop_geometry() %>%
  summarize(workers = sum(workers,
                          na.rm = TRUE))

# Regional total opportunity-seeking population in Shen-type accessibility
TO_taz_acc %>%
  st_drop_geometry() %>%
  summarize(workers = sum(osp,
                          na.rm = TRUE))

# Regional total opportunity-seeking population in spatial availability
TO_taz_acc %>%
  st_drop_geometry() %>%
  summarize(workers = sum(V_i,
                          na.rm = TRUE))
```

```{r descriptive-statistics, eval=FALSE, include=FALSE}
TO_taz_acc %>%
  st_drop_geometry() %>%
  dplyr::select(-c(GTA06)) %>%
  skim()
```

```{r absolute-accessibility-plot-S_i, fig.cap="\\label{fig:plot-Hansen-Type-S-TO}Estimated accessibility to employment in Toronto according to Hansen-type indicator. Greyed out TAZ are zones with no residential population, i.e., with null spatial availability values."}

TO_taz_acc %>%
  ggplot() +
  geom_sf(aes(fill = S_i)) +
  scale_fill_distiller(name = "Hansen-type accessibility",
                       palette = "BuPu", #legend scale bar,
                       direction = 1,
                         na.value = "grey90") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   location = "br",
                   height = unit(0.15, "cm")) +
  theme_minimal() + 
  theme(axis.text = element_blank())
```

```{r absolute-accessibility-plot-A2_i, fig.cap="\\label{fig:plot-Shen-type-A-TO}Estimated accessibility to employment in Toronto according to Shen-type indicator. Greyed out TAZ are zones with no residential population, i.e., with null accessibility values."}

TO_taz_acc %>%
  ggplot() +
  geom_sf(aes(fill = A2_i)) +
  scale_fill_distiller(name = "Shen-type accessibility x OSP",
                       palette = "BuPu", #legend scale bar,
                       direction = 1,
                         na.value = "grey90") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   location = "br",
                   height = unit(0.15, "cm")) +
  theme_minimal() + 
  theme(axis.text = element_blank())
```

```{r absolute-accessibility-plot-V_i, fig.cap="\\label{fig:plot-SA-TO}Estimated spatial availability of employment in Toronto. Greyed out TAZ are zones with no residential population, i.e., with null spatial availability values."}
TO_taz_acc %>%
  ggplot() +
  geom_sf(aes(fill = V_i)) +
  scale_fill_distiller(name = "Spatial availability",
                       palette = "BuPu", #legend scale bar,
                       direction = 1,
                         na.value = "grey90") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   location = "br",
                   height = unit(0.15, "cm")) +
  theme_minimal() + 
  theme(axis.text = element_blank())
```

Figures \ref{fig:plot-Hansen-Type-S-TO}, \ref{fig:plot-Shen-type-A-TO}, and \ref{fig:plot-SA-TO} are the absolute accessibility values in number of jobs accessible/available.


```{r per-capita-accessibility-plot-s_i, fig.cap="\\label{fig:plot-Hansen-Type-S-TO}Estimated accessibility per capita to employment in Toronto according to Hansen-type indicator. Greyed out TAZ are zones with no residential population, i.e., with null spatial availability values."}

TO_taz_acc %>%
  ggplot() +
  geom_sf(aes(fill = S_i/workers)) +
  scale_fill_distiller(name = "Hansen-type accessibility",
                       palette = "BuPu", #legend scale bar,
                       direction = 1,
                         na.value = "grey90") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   location = "br",
                   height = unit(0.15, "cm")) +
  theme_minimal() + 
  theme(axis.text = element_blank())
```

```{r per-capita-accessibility-plot-a_i, fig.cap="\\label{fig:plot-Shen-type-A-TO}Estimated accessibility to employment in Toronto according to Shen-type indicator. Greyed out TAZ are zones with no residential population, i.e., with null accessibility values."}

TO_taz_acc %>%
  ggplot() +
  geom_sf(aes(fill = a_i)) +
  scale_fill_distiller(name = "Shen-type accessibility x OSP",
                       palette = "BuPu", #legend scale bar,
                       direction = 1,
                         na.value = "grey90") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   location = "br",
                   height = unit(0.15, "cm")) +
  theme_minimal() + 
  theme(axis.text = element_blank())
```

```{r per-capita-accessibility-plot-v_i, fig.cap="\\label{fig:plot-SA-TO}Estimated spatial availability of employment in Toronto. Greyed out TAZ are zones with no residential population, i.e., with null spatial availability values."}
TO_taz_acc %>%
  ggplot() +
  geom_sf(aes(fill = v_i)) +
  scale_fill_distiller(name = "Spatial availability",
                       palette = "BuPu", #legend scale bar,
                       direction = 1,
                         na.value = "grey90") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   location = "br",
                   height = unit(0.15, "cm")) +
  theme_minimal() + 
  theme(axis.text = element_blank())
```

How do Shen-type internal values perform? The opportunity seeking population according to Shen-type measure greatly exceeds the population:
```{r}
osp_i %>%
  summarize(osp = sum(osp),
            population = sum(total_population))
```

The ratio of effective opportunity-seeking population to population is shown next:
```{r}
osp_i %>%
  mutate(ratio = osp/total_population) %>%
  left_join(TO_taz,
            by = c("Origin" = "GTA06")) %>%
  st_sf() %>%
  ggplot() +
  geom_sf(aes(fill = ratio)) +
  geom_sf(data = TO_taz,
          fill = NA) +
  scale_fill_distiller(name = "OSP/P",
                       palette = "BuPu", #legend scale bar,
                       direction = 1,
                         na.value = "grey90") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   location = "br",
                   height = unit(0.15, "cm")) +
  theme_minimal() + 
  theme(axis.text = element_blank())
  
```

The effect is not constant in space.

As a consequence of the inflated population (osp > population), the travel time is exaggerated by Shen-type measure:
```{r}
TO_od_ft %>%
  left_join(a_i,
            by = "Origin") %>%
  mutate(total_travel_time = a_i * workers_f * travel_time) %>%
  summarize(total_travel_time = sum(total_travel_time)) %>%
  mutate(total_travel_time = units::set_units(total_travel_time,
                                              min) %>%
           units::set_units(h))

V_ij %>%
  mutate(total_travel_time = V_ij * travel_time) %>%
  summarize(total_travel_time = sum(total_travel_time)) %>%
  mutate(total_travel_time = units::set_units(total_travel_time,
                                              min) %>%
           units::set_units(h))
```

Why do these differences matter? Think about equity analysis!

<!-- CONTINUE REVIEWING FROM HERE

```r

#calculate Hansen-type accessibility for workers from any origin to jobs in Toronto 
TO_od_ft <- TO_od_ft %>% 
  mutate(TO_S_ij = f * jobs) 

TO_c_accessibility <- TO_od_ft %>%
  group_by(Origin) %>%
  summarise(TO_S_i = sum(TO_S_ij, na.rm = T),
            trips_i = sum(trips, na.rm = T),
            workers = mean(workers, na.rm=T))

#Merge TO accessibly calculation to the To_TAZ:
TO_taz_acc <- TO_taz %>% 
  merge(TO_c_accessibility, 
        by.x=c("GTA06"), 
        by.y=c("Origin"), all.x=T)
```

```r calc-for-avail, include=FALSE, warning=FALSE, message=FALSE
#calculate spatial availability
TO_od_ft <- TO_od_ft %>%
  mutate(catch = 1) %>%
  mutate(TO_V_ij = sp_avail(., 
                         o_id = Origin,
                         d_id = Destination,
                         pop = workers,
                         opp = jobs,
                         r = catch,
                         f = f))

#verify that the sum of all jobs is consistent with the number of jobs
sum(TO_od_ft$TO_V_ij, na.rm=T)
sum_jobs <- TO_od_ft %>%
  group_by(Destination) %>% 
  summarise(jobs = mean(jobs))
sum(sum_jobs$jobs, na.rm = T)

#aggregating spatial availability  
TO_availability <- TO_od_ft %>%
  group_by(Origin) %>%
  summarize(TO_V_i = sum(TO_V_ij),
            TO_v_i = sum(TO_V_ij)/mean(workers),
            TO_avgtt_i = mean(travel_time),
            TO_avg_f_i = mean(f)) 

#Merge TO availability calculation to the TAZ sf object created for accessibility above:
TO_taz_acc <- TO_taz_acc %>% 
  merge(TO_availability, 
        by.x=c("GTA06"), 
        by.y=c("Origin"), 
        all.x=T) 
```

```r calc-for-shen-accessibility1, include=FALSE, warning=FALSE, message=FALSE

#calculate shen's accessibility step 1
TO_od_ft <- TO_od_ft %>%
  mutate(f)

LOS_j <- TO_od_ft %>% 
  group_by(Destination) %>%
  summarise(R_j = sum(f * workers, na.rm=T),
            jobs = mean(jobs, na.rm=T),
            .groups = "drop") %>%
  mutate(LOS_j = jobs/R_j)

#aggregate shen's accessibility
TO_c_shen_accessibility <- TO_od_ft %>%
  left_join(LOS_j %>% 
              dplyr::select(Destination, LOS_j, jobs, R_j),
            by = "Destination") %>%
  group_by(Origin) %>%
  summarize(ShenA_i = sum(LOS_j * f))
```

```r calc-for-shen-accessibility2, include=FALSE, warning=FALSE, message=FALSE
#Merge TO availability calculation to the TAZ sf object created for accessibility above:
TO_taz_acc <- TO_taz_acc %>% 
  merge(TO_c_shen_accessibility, 
        by.x=c("GTA06"), 
        by.y=c("Origin"), 
        all.x=T) 

```
--->

## Accessibility and spatial availability of jobs in Toronto

Toronto is the largest city in the GTHA and represents a significant subset of workers and jobs in the GTHA; `r percent(sum(TO_od_ft$workers)/sum(od_ft$workers))` of workers in the GTHA travel to jobs in Toronto and `r percent(sum(TO_od_ft$jobs)/sum(od_ft$jobs))` of jobs are located within Toronto. 

<!-- Update this text after discussion with Dr. Paez--> 

<!-- Replaced inline code with "#r#", to make it work again replace back to "`r" -->

<!-- As will be discussed, when accessibility and spatial availability values are compared, this significant subset of jobs in Toronto illustrates both issues associated with the competition effect. Specifically, since accessibility does not include the single-opportunity constraint like spatial availability does, it *overestimates* the jobs available for most TAZ in proximity to Toronto (i.e., GTA) and *underestimates* the jobs available for TAZ in the periphery of the GTHA.

Figure \ref{fig:plot-access-SA-TO} presents the accessibility and spatial availability for the full TTS data set. Conventionally, higher accessibility is interpreted as the ability to reach more opportunities. Within the accessibility plot, job access values follow a radial trend where a few TAZ with a high values are strictly located within the boundaries of Toronto and values radially decrease further from the boundaries of Toronto. This general trend is echoed in qualitative studies which find the further from Toronto the longer the employment commute [@axisa_factors_2012] and the closer to core of Toronto the more opportunities are accessible [for some to certain types of jobs, see @paez_jobs_2013].

Next, the spatial availability measure is presented alongside the accessibility plot in Figure \ref{fig:plot-access-SA-GGH-TTS}. Similar to the accessibility plot, the higher the value, the more access that TAZ has to jobs in the GTHA. Since spatial availability constrains its total to match the total number of opportunities, high values of spatial availability can be seen as higher access to *available* jobs (i.e., competitive job access) and we can observe which TAZ have spatial availability values that are above or below the regional average of #r# round(mean(TO_taz_acc$TO_V_i, na.rm=T), 0)`. It is worth noting that the spatial availability and accessibility plots do not follow the same spatial distribution. Within the spatial availability plot, job access appears more evenly assigned throughout the GTHA. Particularly, job access values, as measured by spatial availability, are higher around the north east and south west periphery TAZ and more moderate in and around Toronto than compared to accessibility.

Note that in Figure \ref{fig:plot-access-SA-GGH-TTS} it can be observed that a few TAZ are greyed out; this corresponds to a null accessibility and spatial availability. Overall, #r# percent(length(cumsum((TO_taz_acc %>% filter(is.na(TO_A_i)) %>% st_drop_geometry)$TO_A_i))/length(cumsum((TO_taz_acc %>% st_drop_geometry)$TO_A_i)))` of TAZ contain zero home-to-work GTHA trips and as such are allocated a null accessibility and spatial availability. The majority of these TAZ contain no worker population, specifically, #r# round(TO_taz_acc %>% filter(is.na(TO_A_i) & workers == "0") %>% dplyr::select(workers) %>% st_drop_geometry %>% count()/TO_taz_acc %>% filter(is.na(TO_A_i)) %>% dplyr::select(workers) %>% st_drop_geometry %>% count(),2)*100`% have zero workers while only #r# round(TO_taz_acc %>% filter(is.na(TO_A_i) & jobs == "0") %>% dplyr::select(jobs) %>% st_drop_geometry %>% count()/TO_taz_acc %>% filter(is.na(TO_A_i)) %>% dplyr::select(jobs) %>% st_drop_geometry %>% count(),2)*100`% of these TAZ have zero jobs (#r# round(TO_taz_acc %>% filter(is.na(TO_A_i) & jobs == "0" & workers=="0") %>% dplyr::select(jobs) %>% st_drop_geometry %>% count()/TO_taz_acc %>% filter(is.na(TO_A_i)) %>% dplyr::select(TO_A_i) %>% st_drop_geometry %>% count(),2)*100`% have both zero workers and jobs).

```{r plot-access-SA-TO, fig.cap="\\label{fig:plot-access-SA-TO}Calculated accessibility (top) and spatial availability (bottom) of employment from origins in destinations and origins in Toronto. Greyed out TAZ represent null accessibility and spatial availability values.", fig.width=7, fig.height=9, message=FALSE}

## accessibility

#creating the main plot
mplot_access_TO <- ggplot() +
  geom_sf(data = TO_taz_acc, aes(fill= TO_A_i), color = NA) + #data
    scale_fill_distiller(palette = "BuPu", #legend scale bar
                         name = expression(A["i"]),
                         na.value = "grey90",
                         limits = c( round(min(TO_taz_acc$TO_A_i, na.rm=T)), round(max(TO_taz_acc$TO_A_i, na.rm=T)) ),
                         breaks = c(round(min(TO_taz_acc$TO_A_i, na.rm=T)), 5000, 10000, 15000, 20000, round(max(TO_taz_acc$TO_A_i, na.rm=T))),
                         labels = c(round(min(TO_taz_acc$TO_A_i, na.rm=T)), 5000, 10000, 15000, 20000, round(max(TO_taz_acc$TO_A_i, na.rm=T)))) +
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80)) # positing legend and clipping out white space

## spatial availability 

mplot_SA_TO <- ggplot() +
  geom_sf(data = TO_taz_acc, aes(fill= TO_V_i), color = NA) + #data
    scale_fill_distiller(palette = "YlGn", #legend scale bar
                         name =  expression(V["i"]),
                         na.value = "grey90",
                         limits = c( round(min(TO_taz_acc$TO_V_i, na.rm=T)), round(max(TO_taz_acc$TO_V_i, na.rm=T)) ),
                         breaks = c(round(min(TO_taz_acc$TO_V_i, na.rm=T)), 5000, 10000, 15000, round(max(TO_taz_acc$TO_V_i, na.rm=T))),
                         labels = c(round(min(TO_taz_acc$TO_V_i, na.rm=T)), 5000, 10000, 15000, round(max(TO_taz_acc$TO_V_i, na.rm=T)))) +
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80)) # positing legend and clipping out white space

mplot_access_TO / mplot_SA_TO
```

```{r TO-benchmark, include=FALSE}
benchmark_TO_V_i_workers <- TO_taz_acc %>% st_drop_geometry() %>% 
  summarise(avg_VO = sum(TO_V_i, na.rm = TRUE)/sum(workers, na.rm = TRUE)) %>% 
  as.numeric()
```

To enhance the interpretability, spatial availability can be normalized to provide more meaningful insight into how many jobs are *available* on average for each TAZ. This normalization, shown in Figure \ref{fig:plot-avail-GGH-TTS-per-worker}, demonstrates which TAZ have above (reds) and below (blue) the average available jobs per worker in the GTHA (#r# round(benchmark_TO_V_i_workers, 2)`). Similar to the spatial availability plot of the GTHA jobs in Figure \ref{fig:plot-access-SA-GGH-TTS}, we can see that many average or above average jobs per worker TAZ (whites and reds) are present in southern Peel and Halton (south-west of Toronto), Waterloo and Brantford (even more south-west of Toronto), and Hamilton and Niagara (south of Toronto), however, the distribution is uneven and many TAZ within these areas do have below average values (blues). 

Interestingly, when considering *competitive* job access, many areas outside of Toronto have similar jobs per worker values as TAZ in Toronto. This is contrary to the notion that since Toronto has high job access it has a significant density of employment opportunities in the GTHA. Not all jobs in Toronto are *available* since Toronto has a high density of _competition_ in addition to density of jobs opportunities. For instance, urban centers outside of Toronto such as those found in Brantford, Guelph, southern Peel, Halton, and Niagara have TAZ which are far above the the TTS average jobs per worker and higher than TAZ within Toronto. High job access is not seen in the accessibility plot which suggests that these less densely populated urban centers may have sufficient employment opportunities for their populations; this finding is obscured when only considering the accessibility measure for job access as will be later discussed.

It is also worth noting that there is almost two times more jobs per worker in the GTHA jobs spatial availability results than the GTHA Toronto spatial availability results. This suggests that all GTHA people who work in the city of Toronto, on average, face more competition for jobs than all GTHA people who work anywhere in the GTHA <!---The causes for this trend are numerous and can include .... as mentioned by study  cite ? Or no.

```{r plot-avail-TO-per-worker, fig.cap="\\label{fig:plot-avail-TO-per-worker}Spatial availability per worker, from origins to job opportunities in Toronto.", fig.width=7, message = FALSE}

mplot_SApW_TO <- ggplot() +
  geom_sf(data = TO_taz_acc, aes(fill= TO_V_i/workers), color = NA) + #data
    scale_fill_gradient2(low = "deepskyblue4",
                         mid = "ghostwhite",
                         high = "red", #legend scale bar
                         name = expression(v["i"]),
                         limits = c(0, round(max(TO_taz_acc$TO_V_i/TO_taz_acc$workers, na.rm=TRUE))), 
                         midpoint= benchmark_TO_V_i_workers, #average V_i per capita
                         na.value = "grey90") + 
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80))# positing legend and clipping out white space

mplot_SApW_TO
```
<!-- NOTE: what do we add next??-->

\newpage

# Discussion and Conclusions

Words go here.

<!--
**NOTE: Reserve this critique for the discussion -- In reference to Allen and Farber's method** 

But while such a model can account for competition, the mutual dependence of the balancing factors in a doubly-constrained model means they must be iteratively calculated which makes them more computationally-intensive. Furthermore, the double constraint means that the sum of opportunity-seekers and the sum of opportunities must match, which is not necessarily true in every potential use case (e.g., there might be more people searching for work than jobs exist in a region).
-->
<!-- 
**NOTE: To develop this for later..
It should be noted that this is a novel approach which has yet to be sufficiently refined for estimating purposes, however, there is room for an additional competitive measure as prevailing measure do _not_ always reflect trends seen in empirical case studies. XXX. Similarly, conventional accessibility (i.e., potential interaction), fail to reflect empirical observations in certain contexts as well. XXX. Measures are highly depending on specific contexts and environments, thus there's conceptually room for an additional measure. 


# Appendix A: Step-by-step accessibility calculations for synthetic example

Details for the synthetic example:
<!-- \renewcommand{\arraystretch}{2.5} #this adds line space in each row of the table
```{r toy-example-table-appendix}
od_tt %>%
  dplyr::select(-c(f)) %>%
  kable(format = "latex",
        booktabs = TRUE,
        col.names = c("Origin", "Destination", "Travel Time", "Population", "Jobs"),
        caption = "\\label{tab:toy-example}Summary description of synthetic example")
```

\noindent and: 
$$
\beta = -0.1 \space in \space f(c_{ij}) = exp(\beta *tt_{ij})
$$

## Conventional gravity accessibiliy

$$
A_i = \sum_{j=1}^JO_j \cdot f(c_{ij})
$$

Solved in one step:
$$
\sum_{j=1}^JO_j = E1 + E2 =  750 + 220 = 970 \space jobs
$$

```{=tex}
\begin{equation}
\begin{array}{l}
A_{A} = 100000 \cdot \exp(\beta*15) + 100000 \cdot \exp(\beta*30) + 10000 \cdot \exp(\beta*100) = 27292 \\
A_{B} = 100000 \cdot \exp(\beta*30) + 100000 \cdot \exp(\beta*15) + 10000 \cdot \exp(\beta*100) = 27292 \\
A_{C} = 100000 \cdot \exp(\beta*100) + 100000 \cdot \exp(\beta*100) + 10000 \cdot \exp(\beta*100) = 2240
\end{array}
\end{equation}
```

$A_{A}$, $A_{B}$, and $A_{C}$ values represent the number of travel-cost adjusted opportunities accessible to each population. Specifically, only a proportion of opportunities are allocated to population centers based on their travel cost value (higher the travel cost lower the number of opportunities). The population is not considered in this measure and the allocation of opportunities is not constrained, it is only adjusted based on the weight of the travel cost. With our negative exponential distance decay, accessibility can be as high as 210,000 (the total number of opportunities in the region) and as low as essentially 0. 

However, in many instances being close to opportunities doesn't necessarily mean much practically to an individual nor can this scale of 0 to the maximum number of total opportunities in the region be operationalized by decision-makers. However, correlates have been found so it is a strong indicator of urban structure, but practically what does it mean for an individual to live in a population center of $A_{C} =$ 2,240 potential job opportunities? On a scale of 0 to 210,000 ($f(c_{ij})=0$ to $f(c_{ij})=1$), this value is low but of the three population centers it is around average. However, $A_{B}$ also has the largest population of all population centers. It has a population that is three times the population center of $A_{A}$ but an accessibility value that is equal to $A_{A}$'s accessibility value. Does it make sense that in both population centers, the accessibility is equal or should it be adjusted based on population? Adjusting based on population is not equivalent as both centers have different travel costs to a different magnitude of opportunities. From this perspective, competitive measures such as the FCA were introduced with the most recently popularized 2SFCA is discussed as follows.

## 2 step floating catchment approach (2SFCA)

Step one:
```{=tex}
\begin{equation}
\begin{array}{l}
R_{j} = \frac{O_{j}}{\sum_i P_{i} \cdot f(c_{ij})}\\

R_{1} = \frac{100000}{60000 \cdot \exp(\beta*15) + 160000 \cdot \exp(\beta*30) + 10000 \cdot \exp(\beta*100)} = 4.683 \\
R_{2} = \frac{100000}{60000 \cdot \exp(\beta*30) + 160000 \cdot \exp(\beta*15) + 10000 \cdot \exp(\beta*100)} = 2.584 \\
R_{3} = \frac{10000}{60000 \cdot \exp(\beta*100) + 160000 \cdot \exp(\beta*100) + 10000 \cdot \exp(\beta*15)} = 4.462 \\
\end{array}
\end{equation}
```

Step two:
```{=tex}
\begin{equation}
\begin{array}{l}
S_{i} = {\sum_j R_{j} \cdot f(c_{ij})}\\
S_{A} = 4.683 \cdot \exp(\beta*15) + 2.584 \cdot \exp(\beta*30) + 4.462 \cdot \exp(\beta*100) = 1.174 \\
S_{B} = 4.683 \cdot \exp(\beta*30) + 2.584 \cdot \exp(\beta*15) + 4.462 \cdot \exp(\beta*100) = 0.810 \\
S_{C} = 4.683 \cdot \exp(\beta*100) + 2.584 \cdot \exp(\beta*100) + 4.462 \cdot \exp(\beta*15) = 0.996
\end{array}
\end{equation}
```

```{r steps-calc-2sfca, eval=FALSE}
#step 1
a <- {100000}/{60000*exp(-0.1*15) + 160000*exp(-0.1*30) + 10000*exp(-0.1*100)}
b <- {100000}/{60000*exp(-0.1*30) + 160000*exp(-0.1*15) + 10000*exp(-0.1*100)}
c <- {10000}/{60000*exp(-0.1*100) + 160000*exp(-0.1*100) + 10000*exp(-0.1*15)}
a
b
c
#step 2
(a*exp(-0.1 *15)) + (b*exp(-0.1 *30)) + (c*exp(-0.1 *100))
(a*exp(-0.1 *30)) + (b*exp(-0.1 *15)) + (c*exp(-0.1 *100))
(a*exp(-0.1 *100)) + (b*exp(-0.1 *100)) + (c*exp(-0.1 *15))
```

We see that the PPR $R_{j}$ for each employment center can be interpreted as the total number of jobs accessible to the total travel-cost adjusted population. This step recognizes that not all opportunities can be distributed to the entire population evenly since not _all_ opportunities can be reached by _all_ population centers. It is assumed that all population and employment centers are in the same catchment. 

In step two, $S_{i}$ values represent the travel-cost adjusted PPR for each population center. Put another way, here $S_{A}$, $S_{B}$, and $S_{C}$ values represent the number of jobs accessible to each population center after being travel-cost adjusted from both the opportunities-perspective and population-perspective. The value could theoretically be on a scale of 0 to the maximum total number of PPR in the catchment (i.e., $f(c_{ij})=0$ to $f(c_{ij})=1$); in this case that value is 4.683 jobs per person. 

It may seem that this method locates opportunities and population in an unconstrained manner, but it is in fact constrained from the opportunities perspective. See the proof below on how 2SFCA (and @shen1998 method) cancels out an equals Spatial Availability. 

--->

# Appendix A

Equivalence of Shen-type accessibility and spatial availability

Population allocation factor:

$$
F^p_{ij} = \frac{P_{i\in r}^\alpha}{\sum_{i}^K P_{i\in r}^\alpha}
$$

$$
F^p_{A} = \frac{P_{A}^\alpha}{P_{A}^\alpha + P_{B}^\alpha + P_{C}^\alpha}
$$

Cost allocation factor:

$$
F^c_{ij} = \frac{f(c_{ij})}{\sum_{i=A}^K f(c_{ij})}
$$

$$
F^c_{A1} = \frac{f(c_{A1})}{f(c_{A1})+f(c_{B1})+f(c_{C1})}
$$

$$
F^c_{B1} = \frac{f(c_{A2})}{f(c_{A2})+f(c_{B2})+f(c_{C2})}
$$

$$
F^c_{C1} = \frac{f(c_{A3})}{f(c_{A3})+f(c_{B3})+f(c_{C3})}
$$

Now let's put it together with P, and see how the denominators end up cancelling out:

$$
v_{i} = \sum_{j}\frac{O_j}{P_{i\in r}^\alpha}\frac{\frac{P_{i\in r}^\alpha}{\sum_{i}^K P_{i\in r}^\alpha} \cdot \frac{f(c_{ij})}{\sum_{i}^K f(c_{ij})}}{\sum_{i}^K \frac{P_{i\in r}^\alpha}{\sum_{i}^K P_{i\in r}^\alpha} \cdot \frac{f(c_{ij})}{\sum_{i}^K f(c_{ij})}}
$$

$$
v_{A} = \frac{O_1}{P_{A}^\alpha}(\frac{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A1})}{f(c_{A1})+f(c_{B1})+f(c_{C1})}}{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A1})}{f(c_{A1})+f(c_{B1})+f(c_{C1})} + \frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{B1})}{f(c_{A1})+f(c_{B1})+f(c_{C1})}+ \frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{C1})}{f(c_{A1})+f(c_{B1})+f(c_{C1})}}) +
$$

$$
\frac{O_2}{P_{A}^\alpha}(\frac{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A2})}{f(c_{A2})+f(c_{B2})+f(c_{C2})}}{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A2})}{f(c_{A2})+f(c_{B2})+f(c_{C2})} + \frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{B2})}{f(c_{A2})+f(c_{B2})+f(c_{C2})}+\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{C2})}{f(c_{A2})+f(c_{B2})+f(c_{C2})}} )+
$$

$$
\frac{O_3}{P_{A}^\alpha}(\frac{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A3})}{f(c_{A3})+f(c_{B3})+f(c_{C3})}}{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A3})}{f(c_{A3})+f(c_{B3})+f(c_{C3})} + \frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{B3})}{f(c_{A3})+f(c_{B3})+f(c_{C3})}+\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{C3})}{f(c_{A3})+f(c_{B3})+f(c_{C3})}} )
$$


First, notice how the denominator on the denominator is the same across the summation? Let's simplify it:

$$
v_{A} = \frac{O_1}{P_{A}^\alpha}(\frac{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A1})}{f(c_{A1})+f(c_{B1})+f(c_{C1})}}{\frac{P_{A}^\alpha \cdot f(c_{A1}) + P_{A}^\alpha \cdot f(c_{B1}) + P_{A}^\alpha \cdot f(c_{C1})}{(P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha) \cdot (f(c_{A1})+f(c_{B1})+f(c_{C1}))}}) +
$$

$$\frac{O_2}{P_{A}^\alpha}(\frac{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A2})}{f(c_{A2})+f(c_{B2})+f(c_{C2})}}{\frac{P_{A}^\alpha \cdot f(c_{A2}) + P_{A}^\alpha \cdot f(c_{B2}) + P_{A}^\alpha \cdot f(c_{C2})}{(P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha) \cdot (f(c_{A2})+f(c_{B2})+f(c_{C2}))}}) +
$$

$$
\frac{O_3}{P_{A}^\alpha}(\frac{\frac{P_{A}^\alpha}{P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha} \cdot \frac{f(c_{A3})}{f(c_{A3})+f(c_{B3})+f(c_{C3})}}{\frac{P_{A}^\alpha \cdot f(c_{A3}) + P_{A}^\alpha \cdot f(c_{B3}) + P_{A}^\alpha \cdot f(c_{C3})}{(P_{A}^\alpha+P_{B}^\alpha+P_{C}^\alpha) \cdot (f(c_{A3})+f(c_{B3})+f(c_{C3}))}} )
$$


See how the denominator of the denominator is the same as the denominator of the numerator's denominator for each J (J=1, J=2, and J=3)? Let's cancel those out and simplify:

$$
v_{A} = \frac{O_1}{P_{A}^\alpha}(\frac{P_{A}^\alpha \cdot f(c_{A1})}{P_{A}^\alpha \cdot f(c_{A1}) + P_{A}^\alpha \cdot f(c_{B1}) + P_{A}^\alpha \cdot f(c_{C1})} +
$$

$$\frac{O_2}{P_{A}^\alpha}\frac{P_{A}^\alpha \cdot f(c_{A2})}{P_{A}^\alpha \cdot f(c_{A2}) + P_{A}^\alpha \cdot f(c_{B2}) + P_{A}^\alpha \cdot f(c_{C2})} +
$$

$$
\frac{O_3}{P_{A}^\alpha}\frac{P_{A}^\alpha \cdot f(c_{A3})}{P_{A}^\alpha \cdot f(c_{A3}) + P_{A}^\alpha \cdot f(c_{B3}) + P_{A}^\alpha \cdot f(c_{C3})} )
$$


Next, see how we can cancel out the $P_{A}^\alpha$? Let's do that.

$$
v_{A} = O_1(\frac{f(c_{A1})}{P_{A}^\alpha \cdot f(c_{A1}) + P_{B}^\alpha \cdot f(c_{B1}) + P_{C}^\alpha \cdot f(c_{C1})} + O_2\frac{f(c_{A2})}{P_{A}^\alpha \cdot f(c_{A2}) + P_{B}^\alpha \cdot f(c_{B2}) + P_{C}^\alpha \cdot f(c_{C2})} + O_3\frac{f(c_{A3})}{P_{A}^\alpha \cdot f(c_{A3}) + P_{B}^\alpha \cdot f(c_{B3}) + P_{C}^\alpha \cdot f(c_{C3})} )
$$

\newpage

# References {#references .unnumbered}

