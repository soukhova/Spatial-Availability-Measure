---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Workshop

## Introducing spatial availability, a singly-constrained competitive-access accessibility measure

Antonio Paez (School of Earth, Environment and Society, McMaster University, Canada)

<!-- badges: start -->
<!-- badges: end -->

<!--
ALL IMAGES WERE CREATED BY ANTONIO USING TAYASUI SKETCHES ON AN IPAD
-->

# Abstract

Accessibility measures are widely used in transportation, urban and healthcare planning, among other applications. These measures are weighted sums of the opportunities that can be reached given the cost of movement and are interpreted to represent the potential for spatial interaction. Though these measures are useful in understanding spatial structure, their methodologies count available opportunities multiple times. This leads to interpretability issues, as noted in recent research on balanced floating catchment areas (BFCA) and competitive measures of accessibility. In this paper, we respond to the limitations of the accessibility measure by proposing a new measure of  _spatial availability_ which is calculated by imposing a single constraint on the conventional gravity-based accessibility. Similar to the gravity model from which spatial availability is derived, a single constraint ensures that the marginals at the destination are met and thus the number of opportunities are preserved. Through examples, we detail the formulation of the proposed measure. Further, we use data from the 2016 Transportation Tomorrow Survey of the Greater Golden Horseshoe area in southern Ontario, Canada, to contrast how the conventional accessibility measure tends to overestimate and underestimate the number of jobs _available_ to workers. We conclude with some discussion of the possible uses of spatial availability and argue that, compared to conventional measures of accessibility, it can offer a more meaningful and interpretable measure of opportunity access. All data and code used in this research are openly available.

# Keywords

- Spatial availability
- Accessibility
- Gravity model
- Transportation
- TTS

## From accessibility to spatial availability

![](images/Image-01.png)

![](images/Image-02.png)

![](images/Image-03.png)

![](images/Image-04.png)

![](images/Image-05.png)

![](images/Image-06.png)

![](images/Image-07.png)

![](images/Image-08.png)

![](images/Image-09.png)

![](images/Image-10.png)

![](images/Image-11.png)

![](images/Image-12.png)

![](images/Image-13.png)

![](images/Image-14.png)

![](images/Image-15.png)

![](images/Image-16.png)

![](images/Image-17.png)

Formalizing this, we see that spatial availability $V_i$ is the weighted, and _constrained_, sum of opportunities:
$$
V_i = \sum_j^J O_j\frac{f(c_{ij})}{\sum_n^N f(c_{nj})}
$$

\noindent where:

- $N$ is the number of locations where population is
- $J$ is the number of locations where opportunities are

Compare to accessibility:
$$
S_i = \sum_j^JO_jf(c_{ij})
$$

Let us change the set up to illustrate a different point.

![](images/Image-18.png)

![](images/Image-19.png)

When we formalize this we see again that _spatial availability_ is a weighted sum of the opportunities, constrained to match the total:
$$
V_i = \sum_j O_j\frac{P_i}{\sum_n^N P_n}
$$

We have described two proportional allocation mechanisms:

1. By the cost of interaction (through the impedance function)

1. By the size of the population

These are consistent with the principles of spatial interaction (e.g., the gravity model):

1. The friction of space

1. The importance of size (mass)

We call these quantities _proportional allocation factors_:

$$
F^C_{ij} = \frac{f(c_{ij})}{\sum_n^N f(c_{nj})}
$$

\noindent and:

$$
F^P_i = \frac{P_i}{\sum_n^N P_m}
$$

The two factors are combined as follows:
$$
F_{ij}^T = \frac{F^C_{ij}F^P_i}{\sum_n^NF^C_{ij}F^P_i}
$$

\noindent to give the following expression for _spatial availability_:
$$
V_i = \sum_j^J O_jF^T_{ij}
$$

Compare again to accessibility:
$$
S_i = \sum_j^JO_jf(c_{ij})
$$

Spatial availability is a measure of the number of opportunities that are available from a location. It is singly constrained measure of accessibility.

- It constrains the sum of available opportunities to match the total number of opportunities in the region
- It is easier to interpret than accessibility
- It provides intuitive results
- It gives a natural baseline for equity analysis

## Exercise

In reference to the figure below.

![](images/Exercise.png)

This is a tiny system with two population centers ($a$ and $b$) and two employment centers ($A$ and $B$). For the exercise use the following impedance function for $c_{ij}$, where $c$ is duration in minutes:
$$
f(c_{ij}) = \begin{cases}
\frac{1}{c_{ij}^\alpha} &\text{for } c_{ij}\le\delta\\
0 & \text{for } c_{ij}>\delta\\
\end{cases}
$$

Assume that the number of people and jobs at each location is as shown below:
$$
\begin{array}{l}
P_{a} = 80 \\
P_{b} = 120 \\
O_{A} = 100 \\
O_{B} = 50 
\end{array}
$$

Further, the travel times in minutes between these locations are:
$$
\begin{array}{l}
c_{aA} = 15 \\
c_{Ab} = 20 \\
c_{bB} = 15 
\end{array}
$$

Use $\alpha=1$ and $\delta=45$ min.

As a reminder, accessibility is:
$$
S_i = \sum_j O_jf(c_{ij})
$$

### Questions: Part 1

1. What is the _global_ jobs/population ratio in this system?
1. What does $\delta=45$ min represent?
1. Calculate the impedance for each population center-employment center pair.
1. Calculate the accessibility.
1. Tabulate $F^c_{ij}$ for each population center-employment center pair. what do these values represent?
1. Tabulate $F^P_{i}$ for each population center. What do these values represent?
1. Tabulate $F^T_{ij}$ for each population center-employment center pair. what do these values represent?
1. Calculate the jobs available from each employment center to each population center (i.e., $V_ij$).
1. Calculate the jobs available at each population center (i.e., $V_i$).
1. Verify that $\sum_iV_i = \sum_jO_j$
1. Calculate the jobs per capita at each population center (i.e., $v_i = \frac{V_i}{P_i}$)
1. Compare to the global jobs/population ratio.
1. In which of the two population centers is the risk of unemployment higher? Discuss.
1. What do you think would happen if $\alpha$ was less than one or greater than one? Explain.

```{r include=FALSE}
library(accessibility)
library(dplyr)
library(ggplot2)
library(leaflet)
library(patchwork)
library(sf)
library(tidyr)
library(TTS2016R)
```

```{r function-spatial-availability, include=FALSE}
spav <- function(){
  
  # Calculate the impedance function given the cost. There is a cutoff value. If c is greater than delta, the impedance is zero.
  od <- od |>
    mutate(f = ifelse(travel_time <= delta, 1/travel_time^alpha, 0))
  
  # Calculate the denominator of the proportional allocation factor by cost $F^c$. It is the sum over the origins of the impedance.
  sum_f <- od |>
    group_by(to_id) |>
    summarize(sum_f = sum(f))
  
  # Join the denominator to the od table.
  od <- od |>
    left_join(sum_f,
              by = "to_id") |>
    # Calculate the proportional allocation factor $F^c$. It is the impedance divided by the sum of the impedance by origin.
    mutate(Fc = f/sum_f)
  
  # Calculate the proportional allocation factor by population $F^P$.
  Fp <- lu |>
    transmute(id,
              Fp = P/sum(P))
  
  # Join $F^P$ to the od table.
  od <- od |>
    left_join(Fp,
              by = c("from_id" = "id"))
  
  # Calculate the denominator of the total proportional allocation factor. It is the sum of the product of $F^c$ and $F^P$ by origin.
  FT <- od |>
    group_by(to_id) |>
    summarize(FT = sum(Fc * Fp))
  
  # Join the denominator of $F^T$ to od table.
  od <- od |>
    left_join(FT,
              by = "to_id") |>
    # Calculate $F^T$
    mutate(FT = Fc * Fp/FT)
  
  # Join the opportunities to the od table.
  Vij <- od |>
    left_join(lu,
              by = c("to_id" = "id")) |>
    # Calculate the proportion of opportunities available from each destination to each origin.
    mutate(Vij = O * FT)
  
  return(Vij)
}
```

```{r exercise-1-part-1, include=FALSE}
# Define the parameters for the scenario.
alpha <- 1
delta<- 45

# Define the inputs for the scenario

# origin destination cost table. 
od <- data.frame(from_id = c("a", "a", "b", "b"), to_id = c("A", "B", "A", "B"), travel_time = c(15, 50, 20, 15))
# Land uses: population and opportunities.
lu <- data.frame(id = c("a", "b", "A", "B"), P = c(80, 120, 0, 0), O = c(0, 0, 100, 50))
```

```{r exercise-1-part-1-spatial-availability, include=FALSE}
Vij_1 <- spav()
Vi_1 <- Vij_1 |>
  group_by(from_id) |>
  summarize(Vi = sum(Vij))
```

```{r exercise-1-part-1-spatial-availability-package-accessibility, include=FALSE}
#Alternatively, using package {accessibilit}

spatial_availability(od |> 
                       # Remove columns that the function does not use
                       select(from_id, to_id, travel_time) |> 
                       # Remove od pairs that exceed the threshold
                       filter(travel_time <= 45), 
                     lu, 
                     opportunity = "O", 
                     travel_cost = "travel_time", 
                     demand = "P", 
                     decay_function = decay_power(1))
```

### Solution: Part 1

The spatial availability is as follows:
$$
\begin{array}{l}
V_{a} = 47.1 \text{ jobs}\\ 
V_{b} = 102.9 \text{ jobs}
\end{array}
$$

Next, suppose that there is an upgrade in the transportation system that shortens the duration of trips between $a-A$, so the new travel times are:
$$
\begin{array}{l}
c_{aA} = 5 \\
c_{Ab} = 20 \\
c_{bB} = 15 
\end{array}
$$

Continue to use $\alpha =1$ and $\delta=45$ min.

```{r exercise-1-part-2, include=FALSE}
# Define the parameters for the scenario.
alpha <- 1
delta<- 45

# Define the inputs for the scenario

# origin destination cost table. 
od <- data.frame(from_id = c("a", "a", "b", "b"), to_id = c("A", "B", "A", "B"), travel_time = c(5, 40, 20, 15))
# Land uses: population and opportunities.
lu <- data.frame(id = c("a", "b", "A", "B"), P = c(80, 120, 0, 0), O = c(0, 0, 100, 50))
```

```{r exercise-1-part-2-spatial-availability, include=FALSE}
Vij_2 <- spav()
Vi_2 <- Vij_2 |>
  group_by(from_id) |>
  summarize(Vi = sum(Vij))
```

```{r exercise-1-part-2-spatial-availability-package-accessibility, include=FALSE}
#Alternatively, using package {accessibilit}

spatial_availability(od |> 
                       # Remove columns that the function does not use
                       select(from_id, to_id, travel_time) |> 
                       # Remove od pairs that exceed the threshold
                       filter(travel_time <= 45), 
                     lu, 
                     opportunity = "O", 
                     travel_cost = "travel_time", 
                     demand = "P", 
                     decay_function = decay_power(1))
```

### Questions: Part 2

1. Does the accessibility of $b$ change? Discuss.
1. Explain the changes to spatial availability $V_i$ and spatial availability per capita $v_i$ compared to those calculated using the earlier travel times.

### Solution: Part 2

The spatial availability is now as follows:
$$
\begin{array}{l}
V_{a} = 82.7 \text{ jobs}\\ 
V_{b} = 67.3 \text{ jobs}
\end{array}
$$

## Exercise 2

```
library(accessibility)
library(dplyr)
library(TTS2016R)
```

```{r}
data("ggh_taz")
data("od")
```

The identifiers of TAZs in Toronto are 1-625 according to the [Data Guide](http://dmg.utoronto.ca/wp-content/uploads/2022/06/2016TTS_DataGuide.pdf) of TTS (p. 29).

```{r}
TO_taz <- c(1:625) |> 
  as.character()
```


```{r}
lu <- ggh_taz |>
  filter(GTA06 %in% TO_taz) |>
  transmute(id = GTA06,
            P = workers,
            O = jobs)
```


Global jobs/workers ratio:
```{r}
sum(lu$O)/sum(lu$P)
```

Prepare the travel time matrix by filtering TAZ that are in Toronto.
```{r}
od_ggh <- od
od <- od |>
  filter(Origin %in% lu$id, 
         Destination %in% lu$id) |>
  transmute(from_id = Origin,
            to_id = Destination,
            travel_time)
```

The maximum travel time in the table is:
```{r}
max(od$travel_time)
```

We can use a 
```{r}
alpha <- 0.005
ggplot() +
  geom_function(fun = function(x) 1/(abs(x)^alpha),
                xlim = c(1, max(od$travel_time))) +
  xlab("t (travel time in min)") +
  ylab("f(t)") +
  theme_minimal()
```

Calculate accessibility:
```{r exercise-2-accessibility, include=FALSE}
#Alternatively, using package {accessibilit}
Si <- gravity(travel_matrix = od |> 
                # Remove columns that the function does not use
                select(from_id, to_id, travel_time), 
              land_use_data = lu, 
              opportunity = "O", 
              travel_cost = "travel_time", 
              #demand = "workers", 
              decay_function = decay_power(alpha)) |>
  rename(Si = O)
```

Calculate spatial availability:
```{r exercise-2-spatial-availability, include=FALSE}
#Alternatively, using package {accessibilit}
Vij <- spatial_availability(travel_matrix = od |> 
                              select(from_id, to_id, travel_time), 
                            land_use_data = lu, 
                            opportunity = "O", 
                            travel_cost = "travel_time", 
                            demand = "P", 
                            decay_function = decay_power(alpha),
                            detailed_results = TRUE) |>
  rename(Vi = O)

Vi <- Vij |>
  group_by(from_id) |>
  summarize(Vi = sum(Vi)) |>
  rename(id = from_id)
```

Join the results to the zoning system for plotting:
```{r}
results <- lu |>
  left_join(Si,
            by = "id") |>
  left_join(Vi,
            by = "id")
```

Verify the total of jobs in the region, the jobs accessible, and the jobs available:
```{r}
# Sum of jobs in land use table,
sum(lu$O)
# Sum of jobs accessible.
sum(results$Si, na.rm = TRUE)
# Sum of jobs available.
sum(results$Vi, na.rm = TRUE)
```
Summary of results of accessibility and availability:
```{r}
results |> 
  st_drop_geometry() |>
  select(Si, Vi) |>
  summary()
```

Calculate values per capita:
```{r}
results <- results |>
  mutate(si = Si/P,
         vi = Vi/P)
```

Summary of values per capita:
```{r}
results |> 
  st_drop_geometry() |>
  select(si, vi) |>
  summary()
```

```{r}
Si_plot <- ggplot() +
  geom_sf(data = results,
          aes(fill = Si)) +
  geom_sf(data = lu,
          fill = NA) +
  scale_fill_viridis_c(direction = 1) +
  theme_void() +
  ggtitle("Accessibility")
```

```{r}
Vi_plot <- ggplot() +
  geom_sf(data = results,
          aes(fill = Vi)) +
  geom_sf(data = lu,
          fill = NA) +
  scale_fill_viridis_c(direction = 1) +
  theme_void() +
  ggtitle("Spatial Availability")
```

Render:
```{r}
Si_plot + Vi_plot
```

```{r}
si_plot <- ggplot() +
  geom_sf(data = results,
          aes(fill = si)) +
  geom_sf(data = lu,
          fill = NA) +
  scale_fill_viridis_c(direction = 1) +
  theme_void() +
  ggtitle("Accessibility per capita")
```

```{r}
vi_plot <- ggplot() +
  geom_sf(data = results,
          aes(fill = vi)) +
  geom_sf(data = lu,
          fill = NA) +
  scale_fill_viridis_c(direction = 1) +
  theme_void() +
  ggtitle("Spatial Availability per capita")
```

Render:
```{r}
si_plot + vi_plot
```

Ratio of $S_i$ to $V_i$ indicates that $S_i$ is not simply a scaled-up version of $V_i$ but rather something different:
```{r}
ggplot() +
  geom_sf(data = results,
          aes(fill = Si/Vi)) +
  geom_sf(data = lu,
          fill = NA) +
  scale_fill_viridis_c(direction = 1, trans = "log10") +
  theme_void()
```

The same is true of $s_i$: the ratio of $s_i$ to $v_i$ indicates it is not simply a scaled-up version of $v_i$ but rather something different:
```{r}
ggplot() +
  geom_sf(data = results,
          aes(fill = si/vi)) +
  geom_sf(data = lu,
          fill = NA) +
  scale_fill_viridis_c(direction = 1, trans = "log10") +
  theme_void()
```


```{r}
ggplot() +
  geom_sf(data = results,
          aes(fill = vi)) +
  geom_sf(data = lu,
          fill = NA) +
  scale_fill_gradient2(midpoint = sum(lu$O)/sum(lu$P)) +
  theme_void() +
  ggtitle("Spatial Availability per capita")
```


```{r}

bins <- quantile(results$si, na.rm = TRUE) |> as.numeric()
pal <- colorBin("RdBu", domain = results$si, bins = bins)

labels <- sprintf(
  "<strong>%s</strong><br/>%g workers<br/>%g jobs accessible<br/>%g jobs / person",
  results$id, 
  results$P,
  results$Si,
  results$si
) %>% lapply(htmltools::HTML)

leaflet(data = results |> st_transform(crs = 4326 )) |> 
  addPolygons(
    fillColor = ~pal(si),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"))
```

```{r}

bins <- quantile(results$vi, na.rm = TRUE) |> as.numeric()
pal <- colorBin("RdBu", domain = results$vi, bins = bins)

labels <- sprintf(
  "<strong>%s</strong><br/>%g workers<br/>%g jobs available<br/>%g jobs / person",
  results$id, 
  results$P,
  results$Vi,
  results$vi
) %>% lapply(htmltools::HTML)

leaflet(data = results |> st_transform(crs = 4326 )) |> 
  addPolygons(
    fillColor = ~pal(vi),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"))
```


