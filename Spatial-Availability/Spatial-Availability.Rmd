---
title: "Introducing spatial availability, a singly-constrained competitive-access accessibility measure"
author:
  - name: "Author One"
    email: "author.1@example.com"
    affiliation: Some School
  - name: "Author Two"
    email: "author.2@example.com"
    affiliation: Some School
    footnote: "Corresponding Author"
address:
  - code: Some School
    address: "Address"
footnote:
  - code: 1
    text: "Corresponding Author"
abstract: |
  Accessibility measures are widely used in transportation, urban, and health care planning, among other applications. These measures are weighted sums of the opportunities that can be reached given the cost of movement and are interpreted as the potential for spatial interaction. These measures are useful to understand spatial structure but double counting of opportunities leads to interpretability issues, as noted in recent research on balanced floating catchment areas (BFCA) and competitive measures of accessibility. In this paper we propose a new measure of _spatial availability_ which is calculated by imposing a single constraint on conventional gravity-based accessibility. Similar to the gravity model from which it is derived, a single constraint ensures that the marginals at the destination are met and thus the number of opportunities are preserved. Through examples, we detail the formulation of the proposed measure. Further, we use data from the 2016 travel survey in the Greater Toronto and Hamilton Area in Canada to contrast how conventional accessibility overestimates and underestimates the number of jobs _available_ to workers. We conclude with some discussion of the possible uses of spatial availability. Overall, we argue that spatial availability can be a more meaningful and interpretable measure of opportunity access in relation to conventional accessibility. All data and code used in this research are openly available.

journal: "Journal of Transport Geography"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
#linenumbers: true
#numbersections: true
csl: elsevier-harvard.csl
output: rticles::elsevier_article
header-includes:
- \usepackage[font=small,skip=0pt]{caption}

---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  warning = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r install-data-package, include=FALSE}
if (!require("AccessPack", character.only = TRUE)) {
      remotes::install_github("soukhova/AccessPack",
                        build_vignettes = TRUE)
  }
```

```{r load-packages, include=FALSE, cache=FALSE}
library(AccessPack)
library(dplyr)
library(fitdistrplus)
library(ggplot2)
library(kableExtra)
library(patchwork)
library(sf)
library(scales)
library(ggpmisc)
library(ggrepel)
library(cowplot)
library(ggspatial)
library(spdep)
library(RColorBrewer)
# library(extrafont)
# font_import()
# loadfonts(device = "win")

options(scipen = 999)
```

\newpage

# Introduction

The concept of accessibility is a relatively simple one whose appeal derives from combining the spatial distribution of opportunities and the cost of reaching them [@hansen1959]. Numerous methods for calculating accessibility have been proposed that can be broadly organized into infrastructure-, place-, person-, and utility-based measures [@geurs2004]. Of these, the place-based family of measures is arguably the most common, capturing the number of opportunities reachable from an origin using the transportation network. A common type of placed-based measure is the gravity measure of accessibility that captures the potential for interaction; since it was first developed by @hansen1959 it has been widely adopted by literature in many forms [e.g., @cervero_transportation_2002; @paez2004network; @geurs2004; @handy_measuring_1997; @levinson_accessibility_1998].

Accessibility analysis is employed in transportation, geography, public health, and many other areas, particularly as mobility-based planning is de-emphasized in favor of access-oriented planning [@deboosere2018; @handy2020; @proffitt2017; @yan2021]. However, while measures of accessibility are excellent indicators of the intersection between urban structure and transportation infrastructure, their interpretability has been criticized in the past. Previous research has highlighted how the weighting of opportunities using an impedance function can make gravity measures more difficult for planners and policymakers to interpret compared to simpler cumulative opportunity measures [@geurs2004; @miller2018]. Moreover, because place-based measures are sensitive to the number of opportunities and the size of the opportunity-seeking population (e.g., a large city has more nearby jobs and more job-seekers than a smaller city) raw values cannot be easily compared across study areas [@allen2019].

For this reason, place-based intra- and inter-regional comparisons of accessibility are challenging to interpret. Gravity-based accessibility indicators are spatially smoothed estimates of the total number of opportunities, however, the meaning of their magnitudes is unclear. This is evident when we consider the "total accessibility" in the region, a quantity that is not particularly meaningful since it is not constrained to resemble, let alone match the number of opportunities available. Furthermore, while accessibility depends on the number of opportunities weighted by the travel costs associated with reaching them, the calculated accessibilities are not sensitive to the demand for those opportunities at the origins. Put another way, traditional measures of place-based accessibility do not capture the competition for opportunities. This shortcoming [@geurs2004] is particularly acute when opportunities are "non-divisible" in the sense that, once taken they are no longer available to other members of the population. Examples of indivisible opportunities include jobs (when a person takes up a job, the same job cannot be taken by anyone else) and placements at schools (once a student takes a seat at a school, that particular opportunity is no longer available for another student). From a different perspective, employers may see workers as opportunities, so when a worker takes a job, this particular individual is no longer in the available pool of candidates for hiring.

To remedy these issues, researchers have proposed several different approaches for calculating competitive accessibility values. On the one hand, this includes several approaches that first normalize the number of opportunities available at a destination by the demand for them from the origin zones and, second, sum the demand-corrected opportunities which can be reached from the origins [e.g. @joseph1984; @shen1998]. These advances were popularized in the family of two-step floating catchment area methods [@luo2003] that have found widespread adoption for calculating competitive accessibility to a variety of opportunities such as healthcare, education, and food access [@yang_comparing_2006; @chen_spatial_2020; @ye_spatial_2018; @chen_enhancing_2019; @chen_evaluating_2020]. In principle floating catchment areas purport to account for competition/congestion effects, although in practice several researchers [e.g., @delamater2013spatial; @wan2012three] have found that they tend to over-estimate the level of demand and/or service. The underlying issue, as demonstrated by @paez2019, is the multiple counting of both population and level of service, which can lead to biased estimates if not corrected.

A second approach is to impose constraints on the gravity model to ensure flows between zones are equal to the observed totals. Based on Wilson's [-@wilson1971] entropy-derived gravity model, researchers can incorporate constraints to ensure that the modeled flows match some known quantities in the data inputs. In this way, models can be singly-constrained to match the row- or column-marginals (the trips produced or attracted, respectively), whereas a doubly-constrained model is designed to match both marginals. Allen and Farber [-@allen2019] recently incorporated a version of the doubly-constrained gravity model within the floating catchment area approach to calculate competitive accessibility to employment using transit across eight cities in Canada. But while such a model can account for competition, the mutual dependence of the balancing factors in a doubly-constrained model means they must be iteratively calculated which makes them more computationally-intensive. Furthermore, the double constraint means that the sum of opportunity-seekers and the sum of opportunities must match, which is not necessarily true in every potential use case (e.g., there might be more people searching for work than jobs exist in a region).

In this paper we propose an alternative approach to measuring competitive accessibility. We call it a measure of **spatial availability** , and it aims to capture the number of indivisible opportunities that are not only _accessible_ but also _available_ to the opportunity-seeking population, in the sense that they have not been claimed by a competing seeker of the opportunity. As we will show, spatial availability is a singly-constrained measure of accessibility. By allocating opportunities in a proportional way based on demand and distance, this method avoids the issues that result from multiple counting of opportunities in conventional accessibility analysis. The method returns meaningful accessibility estimates that correspond to the rate of available opportunities per opportunity-seeking population. Moreover, the method also returns a benchmark value for the region under study against which results for individual origins can be compared both inter- and intra-regionally.

In the following sections we will describe and illustrate this new measure using a toy data set and an empirical example. First, we will describe the analytical framework of the measure. Second, we calculate the spatial availability (SA) using data from the Transportation Tomorrow Survey (TTS) home-to-work commute in 2016 for the Greater Toronto and Hamilton Area (GTHA) in Ontario, Canada, and discuss differences with conventional unconstrained accessibility analysis Thirdly, we will calculate the SA using a simple hypothetical population and employment centers data set for two additional use-cases: one of jobs from the perspective of the population considering catchment restrictions and another of workers from the perspective of employers. Finally, we conclude by discussing the advantages of the spatial availability measure and the breadth of potential uses.

In the spirit of openness of research in the spatial sciences [@brunsdon2021opening; @paez2021open] this paper has a companion open data product [@arribas2021Open], and all code will be available for repeatability and reproducibility purposes.

# Background {#background}

Most accessibility measures (excluding utility-based measures) are derived from the gravity model and follow the formulation shown in Equation (\ref{eq:conventional-accessibility}). The limitations associated with this conventional and widely used measure, namely issues in interpretation and spatial bias, are the motivation for the _spatial availability_ measure which we propose and describe in the following sections. Here we use a simple example to introduce the key concepts, and we will use the conventional accessibility measure for comparison. In this way, we aim to show the differences between accessibility and spatial availability, which helps to explain how spatial availability can improve interpretability in the analysis of spatially dispersed opportunities.

\begin{equation}
\label{eq:conventional-accessibility}
A_i = \sum_{j=1}^JO_jf(c_{ij})
\end{equation}

\noindent where:

-   $A$ is accessibility. 
-   $i$ is a set of origin locations.
-   $j$ is a set of destination locations.
-   $O_j$ is the number of opportunities at location $j$. These are opportunities for activity and add some sort of *supply* to the area;
-   $c_{ij}$ is a measure of the cost of moving between $i$ and $j$
-   $f(\cdot)$ is an impedance function of $c_{ij}$; it can take the form of any monotonically decreasing function chosen based on positive or normative criteria [@paez2012measuring].

Accessibility $A_i$ is the weighted sum of opportunities that can be reached from location $i$, given the cost of travel $c_{ij}$. Summing the opportunities in the neighborhood of $i$ as defined by the impedance function $f(\cdot)$, provides estimates of the number of opportunities that can be reached from $i$ at a certain cost. The type of accessibility can be modified depending on the impedance function; for example, the measure could be cumulative opportunities [if $f(\cdot)$ is a binary or indicator function e.g.,@elgeneidy_cost_2016; @rosik_forecast_2021; @geurs2004; @qi_decadelong_2018] or a gravity measure using an impedance function modeled after any monotonically decreasing function [e.g., Gaussian, inverse power, negative exponential, or log-normal, among others; see, _inter alia_, @kwan_spacetime_1998;  @vale_influence_2017; @reggiani_accessibility_2011; @li_approach_2020].

## Synthetic example {#accessibility-numerical-example}

The setup for our synthetic example is a system with three employment centers and nine population centers, as summarized in Table \ref{tab:toy-example}. Accessibility to jobs at each population center is calculated using the accessibility measure $A_i$ in Equation (\ref{eq:conventional-accessibility}). In this simple example we use the straight line distance between the population and jobs for $c_{ij}$ and a negative exponential function with $\beta = 0.0015$. As noted, $A_i$ represents the number of jobs (i.e., opportunities) that can be reached from each population center given the estimated cost as depicted in Figure \ref{fig:toy-example-accessibility}. 

```{r toy-example, eval = FALSE}
ggplot() + 
  geom_sf(data = toy_sim_zones %>% filter(type=="jobs"),
            aes(size = number),
          shape = 16,
          color = "Black") +
    geom_sf(data = toy_sim_zones %>% filter(type=="population"),
            aes(size = number),
          shape = 17,
          color = "dimgrey") +
  geom_sf_text(data = toy_sim_zones,
               aes(label = id_short),
               size = 3,
               nudge_y = -500) +
  scale_size(range = c(2, 5))  + 
  theme(legend.position = "none",
        axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

```{r create-figure-with-toy-example, fig.height=2, include=FALSE}
ggplot() + 
  geom_sf(data = toy_sim_zones %>% filter(type=="jobs"),
            aes(size = number),
          shape = 16,
          color = "grey") +
    geom_sf(data = toy_sim_zones %>% filter(type=="population"),
            aes(size = number),
          shape = 17,
          color = "dimgrey") +
  geom_sf_text(data = toy_sim_zones,
               aes(label = id_short),
               size = 3,
               nudge_y = -600) +
  scale_size(range = c(2, 4))  + 
  theme(legend.position = "none",
        axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
ggsave("images/figure-1.png",
       width = 3,
       height = 2)
```

```{r toy-example-table}
toy_sim_zones %>%
  st_drop_geometry() %>%
  dplyr::select(-id) %>%
  mutate(fig = "") %>%
  kable(format = "latex",
        booktabs = TRUE,
        col.names = c("ID", "Number", "Location Type", " "),
        caption = "\\label{tab:toy-example}Description of toy data set") %>%
  #kable_styling(latex_options = c("scale_down")) %>%
  column_spec(4, 
              image = "images/figure-1.png") %>%
  collapse_rows(columns = 4, 
                latex_hline = "major", 
                valign = "middle")
```

```{r toy-example-accessibility}
# Calculate impedance function
beta <- 0.0015
toy_od_table <- toy_od_table %>%
  mutate(f = exp(-beta * distance))

# using the origin-destination table (OD) of all origin to destination trips; filter in only jobs which are mean distance or less away from a population center and sum number of jobs available in each origin (population center)
c_accessibility <- toy_od_table %>% 
  mutate(A_ij = f * Jobs) %>%
  group_by(Origin) %>%
  summarise(A_i = sum(A_ij))

#pass conventional accessibility calculation into the spatial object (toy_sim_zones)
toy_sim_zones_access  <- toy_sim_zones %>% 
  left_join(c_accessibility, 
            by = c("id" = "Origin")) 
```

```{r toy-example-accessibility-plot, fig.cap="\\label{fig:toy-example-accessibility}Accessibility of jobs from population centers for the simple toy data set"}
# Plot the accessibility to employment in the example;
ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = A_i, size = A_i, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type,
              size = number),
          fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), 
                     name = "Location Type", 
                     labels=c("Population", "Jobs"),
                     guide = guide_legend(order = 2)) +
  guides(shape =guide_legend(override.aes=list(size=5))) +
  scale_size_continuous(range = c(2,7), name = "Accessibility \n(A_i)", guide = "none") +
  scale_fill_distiller(palette = "OrRd", direction = 1, name = "Accessibility \n(A_i)",
                       limits = c(0, max(toy_sim_zones_access$A_i, na.rm = T)),
                       guide = guide_colorbar(order = 1)) +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1.5, 
                                        color = "grey", 
                                        fill = "gray95"))
```
Figure \ref{fig:toy-example-accessibility} shows the locations of the three employment centers (black circles), where the size of the symbol is in proportion to the number of jobs at each location. We also see nine population centers (triangles), where the size of the symbol is proportional to the accessibility ($A_i$) to jobs. The accessibility values illustrates the following:

- Population centers (triangles) in the middle of the plot are relatively close to all three employment centers and thus have the highest levels of job accessibility. Population center `r toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(id_short)` is relatively central and close to all employment centers, and it is the closest population to the second largest employment center in the region. Unsurprisingly, this population center has the highest accessibility `r  toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(A_i) %>% round(2)`);

- Population centers (triangles) near the left edge of the map (only in proximity to the small employment center) have the lowest levels of job accessibility. Population center `r toy_sim_zones_access %>% slice_min(A_i, n=1) %>% pull(id_short)` is quite peripheral and the closest employment center is also the smallest one. Consequently, it has the lowest accessibility with $A_i=$ `r toy_sim_zones_access %>% slice_min(A_i, n=1, with_ties = F) %>% pull(A_i) %>% round(2)`);

### The effect of competition for opportunities

Accessibility measures are excellent indicators of the intersection between urban structure and transportation infrastructure [@shi_literature_2020; @reggiani_accessibility_2011;@kwan_spacetime_1998]. However, beyond enabling comparisons of relative values they are not highly interpretable on their own [@miller2018]. For instance, from Figure \ref{fig:toy-example-accessibility}, `r toy_sim_zones_access %>% slice_min(A_i, n=1) %>% pull(id_short)` has lower accessibility than `r toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(id_short)` but despite the accessibility value for `r toy_sim_zones_access %>% slice_min(A_i, n=1) %>% pull(id_short)` being relatively low it is still better than _zero_. To address this interpretability issue, previous research has aimed to index and normalize values on a per demand-population basis [e.g., @barboza_balancing_2021; @pereira_distributional_2019; @wang_access_2021]. However, as recent research on accessibility discusses [see for instance @allen2019; @paez2019], these steps do not address the bias introduced through the uneven multiple-counting of opportunities which are unconstrained by demand-side competition. This is similar to the congestion effect that floating catchment area methods aim to address, although they do not necessarily solve the issue completely [see @paez2019]. The underlying issue arises as a result of the underlying assumption that for conventional accessibility $A_i$ all opportunities for all origins $i=1,\cdots,n$ are _available_ to any one who can reach them: in other words, they are assumed to be divisible and non-competitive. This results in every opportunity entering the weighted sum once for every origin $i$ that can reach it. Put another way, if a densely populated population center pops up next to `r toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(id_short)` this center too will have a high accessibility score since $A_i$ does not consider competition of opportunities from neighbouring population centers. This neglect to constraint opportunity counts (i.e., single-constraint) obscures the interpretability of accessibility which may manifests in the following two ways of biased estimation:

1) Demand centers in the less dense outer limits of the urban core may be assigned disproportionately _high_ accessibility values. These periphery areas are traditionally located in proximity to more dense urban demand centers and large urban opportunity centers and thus may have low travel cost to these large opportunity centers. Accessibility $A_i$ does not consider opportunity-constraints and as such these periphery demand centers benefit from the high accessibility to opportunities without competition considerations from their more dense and more centrally located neighbours. 

2) Remote areas which are still within the region of the analysis and have regionally-relative low demand centers, opportunity centers, and travel cost to opportunity centers, are assigned disproportionately _low_ accessibility values. These more remote areas may be sufficiently supplied with opportunities proportionate to their demand but this relationship is obscured by the artificially high accessibility awarded to demand and opportunity rich areas in which competition disproportionately occurs. 

The spatially uneven multiple-counting of opportunities (i.e., the competition effect) leave decision makers unclear on how to interpret resulting accessibility estimates and all recent accessibility measures which seek to improve interpretability are either vulnerable to this impact or require potentially unrealistic assumptions. As previously mentioned, the floating catchment areas (FCA) method increases interpretability by purporting to account for competition, however, as discussed by Paez, Higgins, and Vivona [-@paez2019], FCA methods are vulnerable to a similar multiple-counting effect. On this same note, the doubly-constrained gravity model proposed by Allen and Farber [-@allen2019] which is based on the FCA method accounts for competition but requires that the magnitude of demand matches the opportunities or be re-scaled to match. As already noted, this assumption is not always realistic for many opportunity types such as in the case of job seekers and jobs.  

To address the competition effect and introduce a more realistic assumption regarding non-divisible opportunities, we propose a singly-constrained gravity measure called **spatial availability**. This measure fundamentally seeks to answer for an individual at a specific demand center the following questions: _"many opportunities are accessible, but the same opportunities are also accessible to my (possibly) numerous neighbours... what does a high accessibility actually mean to me?"_ and _"a few opportunities are accessible to me but I am located in a remote area with proportionally few neighbours relative to the region... what does low accessibility mean to me?"_. Beyond the individual, spatial availability, can also be used as-is to evaluate the _spatial mismatch_ of accessible opportunities and demand-seeking population within regions and between regions. 

## The analytical framework of spatial availability

Spatial availability $V_{ij}$ is defined by opportunities $O$ which are proportionally allocated based on a population allocation factor $F^p_{ij}$ and cost of travel allocation factor $F^c_{ij}$ for all origins $i$ to all destinations $j$ as detailed in Equation  (\ref{eq:spatial-availability}). In line with the tradition of gravity modeling, the proposed framework distinguishes between opportunities at a destination and demand for opportunities at the origin. 

\begin{equation}
\label{eq:spatial-availability}
V_{ij} = O_j\frac{F^p_{ij} \cdot F^c_{ij}}{\sum_{i=1}^K F^p_{ij} \cdot F^c_{ij}}
\end{equation}

\noindent where:

-   $V_{ij}$ is spatial availability. 
-   $i$ is a set of origin locations in the region $K$.
-   $j$ is a set of destination locations in the region $K$.
-   $O_j$ is the number of opportunities at location $j$ in the region $K$.
-   $F^p_{ij}$ is the proportional allocation factor of the population in $i$ relative to the population in region $K$.
-   $F^c_{ij}$ is the proportion allocation factor of travel cost for $i$ relative to the travel cost in region $K$; it is a product of a monotonically decreasing (i.e., impedance) function associated with the cost of travel between $i$ and $j$.

To explain the analytical framework, the calculation of opportunity access to jobs (i.e., _job access_ ) is illustrated with a step-by-step example for two population centers ($P_2$ and $P_3$) in the role of demand (i.e., the number of individuals in the labour market who "demand" employment) and one employment center ($O_1$) in the role of opportunities. 

Additionally, since spatial availability $V_{ij}$ consists of these two allocation factors, we detail first how the role of population allocation factor $F^p_{ij}$ in producing $V^p_{ij}$, next the role of the travel cost allocation factor $F^c_{ij}$ in producing $V^c_{ij}$, and finally how both allocation factors in the final general form of spatial availability $V_{ij}$ are combined.

### Population and travel cost allocation factors

We begin with allocation based on demand; consider an employment center $j$ with $O_j^r$ jobs of type $r$. In the general case where there are $K$ population centers in the region, the following factor can be defined in Equation (\ref{eq:pop-alloc-factor}). 

\begin{equation}
\label{eq:pop-alloc-factor}
F^p_{ij} = \frac{P_{i\in r}^\alpha}{\sum_{i=1}^K P_{i\in r}^\alpha}
\end{equation}

The population allocation factor $F^p_{ij}$ corresponds to the proportion of the population in origin $i$ relative to the rest of the region's population centres $K$. On the right hand side of the equation, the numerator $P_{i\in r}$ is the population at origin $i$ that is eligible and 'demand' jobs of type $r$ (e.g., those with a certain level of training or in a designated age group, etc.). The summation in the denominator is over $i=1,\cdots,K$, the number of population at all origins $i$ in the region $K$. To modulate the effect of the size in from this factor we also add an empirical parameter $\alpha$ (i.e., $\alpha <1$ places greater weight on smaller centres relative to larger ones while $\alpha>1$ achieves the opposite effect). This population allocation factor $F^p_{ij}$ can now be used to proportionally allocate a share of the jobs at a destination $j$ to all origin pairs. 

More broadly, since the factor $F^p_{ij}$ is a proportion, when it is summed over $i=1,\cdots,K$ it always equals to 1 (i.e., $\sum_i^{K} F^p_{ij} = 1$). This is notable since the share of jobs (the spatial availability based on population $V^p_{ij}$) at each destination $j$ allocated to (i.e., available to) each origin is equal to $V^p_{ij} = O_j \cdot F^p_{ij}$ and since the sum of F^p_{ij} is equal to 1 it follows that $\sum_{i=1}^I V_{ij} = O_j$. In other words, the number of jobs across the region is preserved. The result is a proportional allocation of jobs (opportunities) to origins based on population demand; this factor does not consider travel cost, that is defined in the travel cost allocation factor $F^c_{ij}$ which is introduced shortly. 

To illustrate the population allocation factor, consider an employment center has 300 jobs ($O_1= 300$) in a region with two population centers which have 240 and 120 people, respectively, ($P_2= 240$ and $P_3 = 120$). For simplicity, assume that all the population in the region is eligible for these jobs, that is, that the entirety of the population is included in the set $r$.  Also assume that $\alpha=1$ meaning the only impact on value is the population size for each center. The population allocation factors $F^p_{ij}$ for the jobs at $O_1$ for each population center $P_2$ and $P_3$ would be defined as shown in Equation (\ref{eq:pop-alloc-factor-2populations}). 

\begin{equation}
\label{eq:pop-alloc-factor-2populations}
\begin{array}{l}\
F^p_{2,1} = \frac{P_2 ^\alpha}{P_2^\alpha + P_3^\alpha} = \frac{240}{240 + 120} = \frac{240}{360}\\
F^p_{3,1} = \frac{P_3^\alpha}{P_2^\alpha + P_3^\alpha}  = \frac{120}{240 + 120} = \frac{120}{360}\\
\end{array}
\end{equation}


The $F^p_{ij}$ values can be used to find a _partial_ spatial availability of jobs which is only defined by the relative population demanding jobs; this partial spatial availability $V^p_{ij}$ for each population center would be calculated as follows in Equation  (\ref{eq:pop-alloc-factor-SA-2populations}). 

\begin{equation}
\label{eq:pop-alloc-factor-SA-2populations}
\begin{array}{l}\
V^p_{2,1} = O_1 \cdot F^p_{2,1} = 300 \cdot \frac{240}{360} = 200 \\
V^p_{3,1} = O_1 \cdot F^p_{3,1} = 300 \cdot \frac{120}{360} = 100 \\
\end{array}
\end{equation}

It can be seen that when using only the proportional allocation factor $F^p_{ij}$ to calculate spatial availability (differentiated here by being defined as $V^p_{ij}$ instead of $V_{ij}$), proportionally more jobs are allocated to the bigger population center (i.e., 2 times more jobs as it is 2 times larger in population). We can also see that the sum of spatial availability for all population centers is equal to the sum of jobs, i.e., total opportunities are preserved. However, as mentioned, using only the proportional allocation factor $F^p_{ij}$ to calculate spatial availability does not account for how far population centers $P_2$ or $P_3$ are from employment center $O_1$. To account for this effect we introduce a second allocation factor $F^c_{ij}$ based on distance to the employment centers defined in Equation  (\ref{eq:tcost-alloc-factor}).

\begin{equation}
\label{eq:tcost-alloc-factor}
F^c_{ij} = \frac{f(c_{ij})}{\sum_{i=1}^K f(c_{ij})}\\
\end{equation} 

\noindent where $c_{ij}$ is the cost (e.g., the distance, travel time, etc.) from population center $i$ to employment center $j$, and $f(\cdot)$ is an impedance function that is a monotonically decreasing function of cost ($c_{ij}$); in other words, the travel cost allocation factor $F^c_{ij}$ serves to proportionally allocates more jobs to closer locations through an impedance function. To continue illustrating, assume that the impedance function is a negative exponential function and assume that $\beta$. This parameter modulates the steepness of the impedance effect and is empirically determined in the case of positive accessibility, or set by the analyst to meet a preset condition in the case of normative accessibility [@paez2012measuring]. For the sake of the example, we set a value of 1. Also suppose that the distance from population center $P_2$ to employment center $O_1$ is 0.6 km, and the distance from population center $P_3$ to employment center $O_1$ is 0.3 km. The proportional allocation factor $F^p_{ij}$ for the jobs at $O_1$ for both population centers $P_2$ and $P_3$ is defined as follows in Equation  (\ref{eq:tcost-allocation-factor-2populations}). 

\begin{equation}
\label{eq:tcost-allocation-factor-2populations}
\begin{array}{l}\
F^c_{2,1} = \frac{\exp(-\beta \cdot D_{2,1})}{\exp(-\beta \cdot D_{2,1}) + \exp(-\beta \cdot D_{3,1})} = \frac{\exp(-0.6)}{\exp(-0.6) + \exp(-0.3)} = 0.426\\
F^c_{3,1} = \frac{\exp(-\beta \cdot D_{3,1})}{\exp(-\beta \cdot D_{2,1}) + \exp(-\beta \cdot D_{3,1})}  = \frac{\exp(-0.3)}{\exp(-0.6) + \exp(-0.3)} = 0.574\\
\end{array}
\end{equation}

We can see that the proportional allocation factor for $P_3$ is larger than $P_2$ since the distance to $O_1$ is shorter. Using the travel cost proportional allocation factors $F^c_{ij}$ as defined in Equation (\ref{eq:tcost-allocation-factor-2populations}), we can now calculate the spatial availability of jobs for each population center based only on $F^c_{ij}$ and the jobs available $O_1$ to these two competing population centers (note: $V^c_{ij}$ not the complete $V_{ij}$) as follows in Equation (\ref{eq:tcost-allocation-factor-SA-2populations}).

\begin{equation}
\label{eq:tcost-allocation-factor-SA-2populations}
\begin{array}{l}\
V^c_{2,1} = O_1 \cdot F^c_{2,1} = 300 \times 0.426 = 127.8\\
V^c_{3,1} = O_1 \cdot F^c_{3,1} = 300 \times  0.574 = 172.2\\
\end{array}
\end{equation}

As shown, the spatial availability defined by $F^c_{ij}$ (i.e., $V^c_{ij}$) allocates $P_3$ a larger share of jobs since the population center is closer to $O_1$. However, as previously discussed, $P_3$ has a smaller population than $P_2$, so $P_2$ receives a larger share of jobs when spatial availability when it is defined by $F^p_{ij}$ (i.e., $V^p_{ij}$). It is necessary to combine both population and travel cost factors to better reflect demand; these two components are in line with how demand is conventionally modelled in accessibility calculations which are re-scale on a per demand-population basis or also consider competition [e.g., @allen2019; @barboza_balancing_2021; @yang_comparing_2006]. Fortunately, since both $F^c_{ij}$ and $F^p_{ij}$ preserve the total number of opportunities (jobs) as they independently sum to 1, they can be combined multiplicatively to calculate the proposed spatial availability ($V_{ij}$) which considers demand to be based on both population and travel cost.

### Putting Spatial Availability Together

We can combine the proportional allocation factors by population $F^p_{ij}$ and travel cost $F^c_{ij}$ and calculate spatial availability $V_{ij}$ as introduced in Equation (\ref{eq:spatial-availability}) and repeated below:

$$
V_{ij} = O_j\frac{F^p_{ij} \cdot F^c_{ij}}{\sum_{i=1}^K F^p_{ij} \cdot F^c_{ij}}
$$

To complete the illustrative example of employment center $O_1$ and population centers $P_2$ and $P_3$, the resulting spatial availability $V_{ij}$ is calculated for both population centers is calculated in Equation (\ref{eq:SA-2populations}). 

\begin{equation}
\label{eq:SA-2populations}
\begin{array}{l}\
V_{2,1} = O_1\cdot \frac{F^p_{2,1} \cdot F^c_{2,1}}{F^p_{2,1} \cdot F^c_{2,1} + F^p_{3,1} \cdot F^c_{3,1}} = 300 \frac{\big(\frac{2}{3} \big) \big(0.426 \big)}{\big(\frac{2}{3} \big) \big(0.426 \big) + \big(\frac{1}{3} \big) \big(0.574 \big)} = 179.4\\
V_{3,1} = O_1\cdot \frac{F^p_{3,1} \cdot F^c_{3,1}}{F^p_{2,1} \cdot F^c_{2,1} + F^p_{ik} \cdot F^c_{ik}} = 300 \frac{\big(\frac{1}{3} \big) \big(0.574 \big)}{\big(\frac{2}{3} \big) \big(0.426 \big) + \big(\frac{1}{3} \big) \big(0.574 \big)}  =  120.6 \\
\end{array}
\end{equation}

As can be seen, fewer jobs are allocated to population center $P_2$ compared to the allocation by population only, to account for the higher cost of reaching the employment center. On the other hand, distance alone allocated more jobs to the closest population center (i.e., $P_3$), but since it is smaller, it also gets a smaller share of the jobs overall. To reiterate, the sum of jobs at employment center $O_1$ that are allocated to population centers $P_2$ and $P_3$ simultaneously based on *population-* and *travel cost* allocation factors are preserved (i.e., $V_{2,1} + V_{3,1} = O_1$).

In the common case that population centers have multiple destination opportunities $j$, spatial availability is simply the sum of Equation  (\ref{eq:spatial-availability}) for all opportunities $J$ (i.e., $V_i = \sum_{j=1}^J V_{ij}$). The resulting value of $V_i$ represents opportunities (e.g., jobs) that can be accessed from origin $i$ and that are *not* allocated to any other competing origin: $V_i$ is thus the weighted sum of available opportunities and is the _opportunity access_ for that origin $i$ considering constrained opportunity availability. When comparing $V_i$ to the singly-constrained gravity model (see Wilson [-@wilson1971]), $V_i$ is the result of constraining $A_i$ to match one of the marginals in the origin-destination table, the known total of opportunities.

Since the sum of opportunities is preserved in the procedures above, it is possible to calculate a highly interpretable measure of spatial availability per capita (lower-case $v_i$) as follows in Equation (\ref{eq:SA-per-capita}).

\begin{equation}
\label{eq:SA-per-capita}
v_i = \frac{V_i}{P_i}
\end{equation}

To complete the illustrative example, the per capita spatial availability of jobs would be calculated as follows in Equation  (\ref{eq:SA-per-capita-2populations}). 

\begin{equation}
\label{eq:SA-per-capita-2populations}
\begin{array}{l}\
v_{2,1} = \frac{V_{2,1}}{P_2} =  \frac{179.4}{240} = 0.8\\
v_{3,1} =  \frac{V_{3,1}}{P_3} =  \frac{120.6}{120} = 1.0\\
\end{array}
\end{equation}

We can see that since $P_3$ is closer to $O_1$ and has less competition (as it has a smaller population than $P_2$), $P_3$ benefits with a higher spatial availability of jobs per job-seeking population. We can also compare these values to the overall ratio of jobs-to-population in this region of one job center and two population centers is $300/(240 + 120)=$ `r round(300/(240 + 120), 2)`. 

# Empirical data set: measuring spatial availability and accessibility of jobs in the GTHA

Applying the spatial availability and the the conventional accessibility measure described in the [Background]{#background}, in this section, we use an empirical data set and two examples to demonstrate how the spatially uneven multiple-counting of opportunities (i.e., competition effect) inherent to the accessibility measure in Equation (\ref{eq:conventional-accessibility}) introduces spatial bias and obscures interpretability.  This competition effect is highlighted by calculating spatial availability as in Equation (\ref{eq:spatial-availability}) and comparing the relative difference between the two measures. 

The first example demonstrates how accessibility broadly overestimates _job access_ (relative to spatial availability) and particularly overestimates job access for areas in the less dense outer limits of the urban core. The second example demonstrates how accessibility underestimates job access for areas in the urban periphery. Both examples are based on the home-based work trips in the Greater Toronto and Hamilton Area (GTHA). We first introduce the data used, then calibrate the impedance function, and finally illustrate the two examples. 

## Data

The 2016 Transportation Tomorrow Survey (TTS) data for 20 municipalities contained within the GTHA area in the province of Ontario, Canada (43.6°N 79.73°W) is used within this section (Figure \ref{fig:TTS-16-survey-area}) [@data_management_group_tts_2018]. This data set includes home-based origins and employment destinations defined by centroids of Traffic Analysis Zones (TAZ) (n=`r round(length(AccessPack::ggh_taz$GTA06), 3) %>% prettyNum(big.mark = ",")`), the number of jobs (n=`r round(sum(AccessPack::ggh_taz$jobs), 3) %>% prettyNum(big.mark = ",")`) and workers (n=`r round(sum(AccessPack::ggh_taz$workers), 3) %>% prettyNum(big.mark = ",")`) at each origin and destination, and the trips from origin to destination for the morning home-to-work commute (n=`r round(sum(AccessPack::od_ft_tt$trips), 3) %>% prettyNum(big.mark = ",")`). 

Also included are travel times and cost of travel from origin to destination by car; travel times are calculated using the R package `r5r` [@r5r_2021] and an impedance function based on these travel times is derived. It is important to note that for simplicity, all trips within this data set are assumed to be taken by car, and the travel time is calculated from an origin TAZ centroid to a destination TAZ centroid. The centroid is snapped to the nearest street line by `r5r` and the travel time is calculated for all trips assuming a car travel mode and a department of 7:00am on Wednesday October 2021, an mid-week date selected by the authors. Additionally, only travel times less than or equal to 180 mins (3 hrs); this threshold represents 99% of trip's travel times which are summarized in the descriptive statistics in Table \ref{tab:TTS-16-desc-stats}. All data and data preparation steps can be freely explored in companion open data product [`AccessPack`](https://github.com/soukhova/AccessPack).

```{r TTS-16-survey-area, echo=FALSE, fig.cap="\\label{fig:TTS-16-survey-area}The TTS 2016 study area within the Greater Golden Horseshoe in Ontario, Canada.", out.width="80%", fig.align='center'}
knitr::include_graphics("images/Greater-Golden-Horseshoe-Map.png")
```

```{r creating-desc-stats-table}
#forming a complete descriptive statistic table

Statistics <- data.frame("Statistics" = c("Min.", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max.", "NA's"))

Trips <- data.frame("OD_Trips" = c(summary(od_ft_tt$trips)[[1]] %>% round(), 
                                   summary(od_ft_tt$trips)[[2]] %>% round(),  
                                   summary(od_ft_tt$trips)[[3]] %>% round(), 
                                   summary(od_ft_tt$trips)[[4]] %>% round(), 
                                   summary(od_ft_tt$trips)[[5]] %>% round(),
                                   summary(od_ft_tt$trips)[[6]]%>% round(),
                                   NA))

Travel_time <- data.frame("OD_Travel_time" = c(summary(od_ft_tt$travel_time)[[1]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[2]] %>% round(),  
                                               summary(od_ft_tt$travel_time)[[3]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[4]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[5]] %>% round(), 
                                               summary(od_ft_tt$travel_time)[[6]] %>% round(),  
                                               3507)) 

TAZ_Area <- data.frame("TAZ_Area" = c(summary(ggh_taz$AREA)[[1]] %>% round(), 
                                      summary(ggh_taz$AREA)[[2]] %>% round(), 
                                      summary(ggh_taz$AREA)[[3]] %>% round(), 
                                      summary(ggh_taz$AREA)[[4]] %>% round(), 
                                      summary(ggh_taz$AREA)[[5]] %>% round(), 
                                      summary(ggh_taz$AREA)[[6]] %>% round(), 
                                      NA))

Workers <- data.frame("Workers" = c(summary(ggh_taz$workers)[[1]] %>% round(), 
                                    summary(ggh_taz$workers)[[2]] %>% round(), 
                                    summary(ggh_taz$workers)[[3]] %>% round(), 
                                    summary(ggh_taz$workers)[[4]] %>% round(), 
                                    summary(ggh_taz$workers)[[5]] %>% round(), 
                                    summary(ggh_taz$workers)[[6]] %>% round(), 
                                    NA))

Jobs <- data.frame("Jobs" = c(summary(ggh_taz$jobs)[[1]] %>% round(), 
                              summary(ggh_taz$jobs)[[2]] %>% round(), 
                              summary(ggh_taz$jobs)[[3]] %>% round(), 
                              summary(ggh_taz$jobs)[[4]] %>% round(), 
                              summary(ggh_taz$jobs)[[5]] %>% round(), 
                              summary(ggh_taz$jobs)[[6]] %>% round(), 
                              NA)) 

desc_stats <- cbind(Statistics, Trips, Travel_time, TAZ_Area, Workers, Jobs)

#kable tabling 
desc_stats %>%
  kable(format = "latex",
        align="lrrrrrr",
        booktabs = T,
        col.names = c(" ", "(#)", "(min)", "(km^2)", "(#)", "(#)"),
        caption = "\\label{tab:TTS-16-desc-stats}Descriptive statistics of the trips, workers, and jobs for the traffic analysis zones (TAZ) from the TTS 2016 dataset along with estimated car origin-destination travel times.") %>%
  add_header_above(c(" ", "Trips", "Car Travel Time", "Area", "Workers", "Jobs"), align = "r")%>%
  kable_styling(full_width = "T", 
                latex_options = c("scale_down"),
                position = "center")
```


## Calibrating an Impedance Function

In the synthetic example introduced in a [preceding section]{#accessibility-numerical-example}, an arbitrary negative exponential function describing travel cost (as a function of distance) was used as the impedance function. In this empirical example, the travel time is calculated based on the existing street network in the GTHA and an impedance function callibrated based on the trip length distribution (TLD). For background, a TLD is the representation of the likelihood that a proportion of trips are taken at a specific travel cost; this distribution is commonly used to derive impedance functions in accessibility research [@horbachov_theoretical_2018; @batista_estimation_2019].

The empirical and theoretical TLD for this data set are represented in the top-left panel of Figure \ref{fig:TLD-Gamma-plot}. Maximum likelihood estimation and the Nelder-Mead method for direct optimization available within the `fitdistrplus` package [@fitdistrplus_2015] were used. Based on goodness-of-fit criteria and diagnostics seen in Figure \ref{fig:TLD-Gamma-plot}, the gamma distribution was selected (also see Figure \ref{fig:plot-cullen-frey} in the Appendix).  

```{r data-for-impedance}
# remove all NA trips from dataset and set all 0min travel times to 0.1 min
od_ft_tt  <- od_ft_tt %>% 
  filter( !is.na(travel_time)) %>% 
  mutate(travel_time = ifelse(travel_time == 0, 0.1, travel_time))
all_tt <- od_ft_tt  %>% 
  dplyr::select(trips, travel_time)

all_tt <- all_tt[rep(seq_len(dim(all_tt)[1]), all_tt$trips), 2]
```

```{r fitting-impedance-function}
# using fitdist function to fit a distribution using the default maximum likelihood estimation method and Nelder-Mead method for direct optimization
gamma_ <- fitdistrplus::fitdist(data=all_tt, "gamma", method="mle", optim.method="Nelder-Mead") 
#lnorm_ <- fitdistrplus::fitdist(data=all_tt, "lnorm", method="mle", optim.method="Nelder-Mead")
#norm_ <-fitdistrplus::fitdist(data=all_tt, "norm", method="mle", optim.method="Nelder-Mead")
# #exp_ <- fitdistrplus::fitdist(data=all_tt, "exp", method="mle", optim.method="Nelder-Mead")
# pois_ <- fitdistrplus::fitdist(data=all_tt, "pois", method="mle", optim.method="Nelder-Mead") 
# nbinom_ <- fitdistrplus::fitdist(data=all_tt, "nbinom", method="mle", optim.method="Nelder-Mead")
# geom_ <- fitdistrplus::fitdist(data=all_tt, "geom", method="mle", optim.method="Nelder-Mead")
# beta_ <- fitdistrplus::fitdist(data=all_tt, "beta", method="mle", optim.method="Nelder-Mead")
# logis_ <- fitdistrplus::fitdist(data=all_tt, "logis", method="mle", optim.method="Nelder-Mead")
# plot(gamma_)
# plot(pois_)
# plot(nbinom_)
# plot(geom_)
# plot(beta_)
# plot(logis_)
```

```{r save-impedance-plot, include=FALSE}
# For some reason plot(gamma_) does not play well with knitr, so instead we save the figure and then include it as a graphic in the following chunk
png("images/impedance_function.png")
plot(gamma_)
dev.off()
```

```{r TLD-Gamma-plot, fig.cap="\\label{fig:TLD-Gamma-plot}Empirical TTS 2016 home-based car trip length distribution (black) and calibrated gamma distribution impedance function (red) with associated Q-Q and P-P plots"}
knitr::include_graphics("images/impedance_function.png")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#dgamma is the density plot for gamma function; adding values as "f" our impedance function
od_ft_tt <- od_ft_tt %>%
  mutate(f = dgamma(travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"]))
```

<!--
```{r TLD-gamma-calculation}
tld <- od_ft_tt %>%
  mutate(tt_classes = cut(travel_time, 
                          150,
                          ordered_result = TRUE)) %>%
  group_by(tt_classes) %>%
  summarize(trips = sum(trips),
            travel_time = mean(travel_time))

# processing data for plot
plot_data1 <- data.frame(estimate = "Empirical",
                         travel_time = tld$travel_time,
                         prop_trips = tld$trips/sum(tld$trips))
plot_data2 <- data.frame(estimate = "Calibrated",
                         travel_time = tld$travel_time,
                         prop_trips = dgamma(tld$travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"]))
plot_data3 <- rbind(plot_data1, plot_data2)
plot_data3$estimate <- factor(plot_data3$estimate, levels=c("Empirical", "Calibrated"))

```

```{r}
#dgamma is the density plot for gamma function
ggplot(data = plot_data3, aes(x = travel_time, y = prop_trips, colour=estimate,linetype=estimate,shape=estimate)) + 
  geom_point(size = 2) +
  geom_line(size=1) +
  labs(title = "Trip length distribution",
       x = "Home-based car travel time to work (min)",
       y = "Proportion of trips") + 
      scale_color_manual("Distribution", 
                         values = c("Empirical" = "Black",
                                    "Calibrated" = "Red"))    +
      scale_linetype_manual("Distribution",values=c(0,1)) +
      scale_shape_manual("Distribution",values=c(16,NA))+
  theme_light() +
  theme(plot.title = element_text(hjust=0.5),
        legend.position = c(0.85,0.80),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank()) 
  
```
-->

The resulting calibrated gamma distribution, which serves as the impedance function for the empirical data set, is given in the following general form where the estimated 'shape' is $\alpha$, the estimated 'rate' is $\beta$, and $\Gamma(\alpha)$ is defined in Equation (\ref{gamma-dist}).

\begin{equation}
\label{gamma-dist}
\begin{array}{l}\ 
f(x, \alpha, \beta) = \frac {x^{\alpha-1}e^{-\frac{x}{\beta}}}{ \beta^{\alpha}\Gamma(\alpha)} \quad \text{for }	0 \leq x \leq \infty\\

\Gamma(\alpha) =  \int_{0}^{\infty} x^{\alpha-1}e^{-x} \,dx\\
\end{array}
\end{equation}

The shape and rate parameters were empirically estimated and their values are `r round(gamma_$estimate[1], 3)` and `r round(gamma_$estimate[2], 3)` respectively. It is important to reiterate that this impedance function is derived using empirical home-to-work data, after selecting trips in the 2016 TTS data set taken by car. Modal split and travel times can be estimated through other methods [e.g., @allen_suburbanization_2021; @higgins2021changes] but for illustrative purposes, this example considers only travel by car and jobs reached by car. 

## Measuring access to jobs in Toronto

```{r calc-for-accessibility-Toronto}
#transform CRS
toronto_muni_bound <- st_transform(toronto_muni_bound, crs=32617)

#select only zones within Toronto Municipality

TO_taz <- ggh_taz %>%
  filter(st_intersects(., toronto_muni_bound, sparse = FALSE)[,1]) %>% dplyr::select(GTA06, AREA, jobs)

# transfer calibrated impedance function values to OD matrix
od_ft_tt <- od_ft_tt %>%
  mutate(f = dgamma(travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"]))

#add the number of jobs and workers to the od_ft_tt matrix
od_ft <- od_ft_tt %>% merge(ggh_taz %>% dplyr::select(GTA06, workers) %>% st_drop_geometry(),
                   by.x = "Origin", by.y="GTA06", all.x = TRUE)

od_ft <- od_ft %>% merge(ggh_taz %>% dplyr::select(GTA06, jobs) %>% st_drop_geometry(),
                   by.x = "Destination", by.y="GTA06", all.x = TRUE)

#jobs at destinations IN Toronto and origins from anywhere; workers are associated with the origin (ggh) and jobs with the destination (Toronto)
TO_od_ft <- od_ft %>% filter(Destination %in% TO_taz$GTA06)

#calculate accessibility for workers from any origin to jobs in Toronto 
TO_c_accessibility <- TO_od_ft %>% 
  mutate(TO_A_ij = f * jobs) %>%
  group_by(Origin) %>%
  summarise(TO_A_i = sum(TO_A_ij, na.rm = T),
            trips_i = sum(trips, na.rm = T))

#Merge TO accessibly calculation to the ggh_taz:
TO_taz_acc <- ggh_taz %>% merge(TO_c_accessibility, by.x=c("GTA06"), by.y=c("Origin"), all.x=T) 
```

```{r calc-for-accessibility-GGH}
# transfer calibrated impedance function values to OD matrix
od_ft_tt <- od_ft_tt %>%
  mutate(f = dgamma(travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"]))

#add the number of jobs and workers to the od_ft_tt matrix
od_ft <- od_ft_tt %>% merge(ggh_taz %>% dplyr::select(GTA06, workers) %>% st_drop_geometry(),
                   by.x = "Origin", by.y="GTA06", all.x = TRUE)

od_ft <- od_ft %>% merge(ggh_taz %>% dplyr::select(GTA06, jobs) %>% st_drop_geometry(),
                   by.x = "Destination", by.y="GTA06", all.x = TRUE)

#calculate accessibility for workers from any origin to jobs in Toronto 
GGH_c_accessibility <- od_ft %>% 
  mutate(GGH_A_ij = f * jobs) %>%
  group_by(Origin) %>%
  summarise(GGH_A_i = sum(GGH_A_ij, na.rm = T),
            trips_i = sum(trips, na.rm = T))

#Merge TO accessibly calculation to the ggh_taz:
GGH_taz_acc <- ggh_taz %>% merge(GGH_c_accessibility, by.x=c("GTA06"), by.y=c("Origin"), all.x=T) 
```

```{r bbox-main-plot-accessibility-Toronto-TTS}
bbox_new1 <- st_bbox(toronto_muni_bound) # current bounding box

xrange <- bbox_new1$xmax - bbox_new1$xmin # range of x values
yrange <- bbox_new1$ymax - bbox_new1$ymin # range of y values

bbox_new1[1] <- bbox_new1[1] - (0.3 * xrange) # xmin - left
bbox_new1[3] <- bbox_new1[3] + (0.2 * xrange) # xmax - right
bbox_new1[2] <- bbox_new1[2] - (0.2 * yrange) # ymin - bottom
bbox_new1[4] <- bbox_new1[4] + (0.3 * yrange) # ymax - top

bbox_new <- bbox_new1 %>%  # take the bounding box ...
  st_as_sfc()
```

```{r calc-for-avail, include=FALSE, warning=FALSE, message=FALSE}
#calculate spatial availability
TO_od_ft <- TO_od_ft %>%
  mutate(catch = 1) %>%
  mutate(TO_V_ij = sp_avail(., 
                         o_id = Origin,
                         d_id = Destination,
                         pop = workers,
                         opp = jobs,
                         r = catch,
                         f = f))

#verify that the sum of all jobs is consistent with the number of jobs
sum(TO_od_ft$TO_V_ij, na.rm=T)
sum_jobs <- TO_od_ft %>% group_by(Destination) %>% summarise(jobs = mean(jobs))
sum(sum_jobs$jobs, na.rm = T)

#aggregating spatial availability  
TO_availability <- TO_od_ft %>%
  group_by(Origin) %>%
  summarize(TO_V_i = sum(TO_V_ij),
            TO_avgtt_i = mean(travel_time),
            TO_avg_f_i = mean(f)) 

#Merge TO availability calculation to the TAZ sf object created for accessibility above:
TO_taz_acc <- TO_taz_acc %>% merge(TO_availability, by.x=c("GTA06"), by.y=c("Origin"), all.x=T) 
```

Toronto is the largest city in the GTHA and represents a significant subset of workers and jobs in the GTHA; `r percent(sum(TO_od_ft$workers)/sum(od_ft$workers))` of workers in the GTHA travel to jobs in Toronto and  `r percent(sum(TO_od_ft$jobs)/sum(od_ft$jobs))` of jobs are located within Toronto. As later discussed, this significant subset of jobs illustrates the first issue associated with the accessibility measure competition effect: neglecting to include the single-constraint overestimates job access for TAZ with a low proportion of workers that are next to TAZ with a high proportion of jobs and workers. 

Accessibility is first calculated and presented in Figure \ref{fig:plot-access-SA-Toronto-TTS}. The higher the accessibility value, the more accessible employment opportunities are to home-based origins. It can be briefly summarized that the accessibility values follow a radial trend where the majority of TAZs in the core of Toronto have high accessibility values and values decrease in TAZs which are further from the city boundary. This general trend is echoed in qualitative studies which find the further from Toronto the longer the employment commute  [@axisa_factors_2012] and the closer to core of Toronto the more opportunities are accessible [for some to certain types of jobs; @paez_jobs_2013].

Next, job access is calculated using the spatial availability measure and is presented alongside the accessibility plot in Figure \ref{fig:plot-access-SA-Toronto-TTS}. Similar to the accessibility plot, the higher the value the more access that TAZ has to jobs in the city of Toronto. However, since spatial availability constrains the total number of opportunities, high values of spatial availability can be seen as higher access to _available_ jobs and we can observe which TAZs have job access values which are above or below the regional average of `r round(mean(TO_taz_acc$TO_V_i, na.rm=T), 0)`.

```{r plot-access-SA-Toronto-TTS, fig.cap="\\label{fig:plot-access-SA-Toronto-TTS}Calculated accessibility (top) and spatial availability (bottom) of employment from origins in the GGH to destinations in the City of Toronto.", fig.width=7, fig.height=9}

## accessibility

#creating the main plot
mplot_access_TTS <- ggplot() +
  geom_sf(data = TO_taz_acc, aes(fill= TO_A_i), color = NA) + #data
    scale_fill_distiller(palette = "Spectral", #legend scale bar
                         name = "Accessibility \n(A_i)",
                         limits = c(0, 25000), 
                         na.value = "grey90") + 
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  geom_rect(data = data.frame(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, # rectangle on main plot marking inset location
                              xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
              aes(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, 
                  xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
            fill = NA, colour = "dimgrey", size = 1) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80)) # positing legend and clipping out white space

#main plot + adding the inset map. 
mplot_access_TTS <- ggdraw(mplot_access_TTS) +
  draw_plot({mplot_access_TTS + coord_sf(xlim = st_coordinates(bbox_new)[c(1,2),1],
                                         ylim = st_coordinates(bbox_new)[c(2,3),2],
                                         expand = FALSE) + 
      theme(legend.position = "none")},
    x = 0.57, y = 0.01,  # The distance along a (0,1) x-axis (and y axis) to draw the left edge (the bottom edge) of the plot
    width = 0.46, height = 0.46) # The width and height of the plot expressed as proportion of the entire ggdraw object

mplot_SA_TTS <- ggplot() +
  geom_sf(data = TO_taz_acc, aes(fill= TO_V_i), color = NA) + #data
    scale_fill_distiller(palette = "Spectral", #legend scale bar
                         name = "Spatially Availability \n(V_i)",
                         limits = c(0, 15000), 
                         na.value = "grey80") + 
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  geom_rect(data = data.frame(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, # rectangle on main plot marking inset location
                              xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
              aes(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, 
                  xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
            fill = NA, colour = "dimgrey", size = 1) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80)) # positing legend and clipping out white space

#main plot + adding the inset map. 
mplot_SA_TTS <- ggdraw(mplot_SA_TTS) +
  draw_plot({mplot_SA_TTS + coord_sf(xlim = st_coordinates(bbox_new)[c(1,2),1],
                                         ylim = st_coordinates(bbox_new)[c(2,3),2],
                                         expand = FALSE) + 
      theme(legend.position = "none")},
    x = 0.57, y = 0.01,  # The distance along a (0,1) x-axis (and y axis) to draw the left edge (the bottom edge) of the plot
    width = 0.46, height = 0.46) # The width and height of the plot expressed as proportion of the entire ggdraw object

## spatial availability
mplot_SA_TTS <- ggplot() +
  geom_sf(data = TO_taz_acc, aes(fill= TO_V_i), color = NA) + #data
    scale_fill_distiller(palette = "Spectral", #legend scale bar
                         name = "Spatially Availability \n(V_i)",
                         limits = c(0, 15000), 
                         na.value = "grey90") + 
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  geom_rect(data = data.frame(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, # rectangle on main plot marking inset location
                              xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
              aes(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, 
                  xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
            fill = NA, colour = "dimgrey", size = 1) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80)) # positing legend and clipping out white space

#main plot + adding the inset map. 
mplot_SA_TTS <- ggdraw(mplot_SA_TTS) +
  draw_plot({mplot_SA_TTS + coord_sf(xlim = st_coordinates(bbox_new)[c(1,2),1],
                                         ylim = st_coordinates(bbox_new)[c(2,3),2],
                                         expand = FALSE) + 
      theme(legend.position = "none")},
    x = 0.57, y = 0.01,  # The distance along a (0,1) x-axis (and y axis) to draw the left edge (the bottom edge) of the plot
    width = 0.46, height = 0.46) # The width and height of the plot expressed as proportion of the entire ggdraw object

mplot_access_TTS / mplot_SA_TTS

```

\newpage
```{r Toronto-benchmark, include=FALSE}
benchmark_TO_V_i_workers <- TO_taz_acc %>% st_drop_geometry() %>% summarise(avg_VO = sum(TO_V_i, na.rm=TRUE)/sum(workers, na.rm=TRUE)) %>% as.numeric()
```

The visual differences between accessibility and spatial availability plots in Figure \ref{fig:plot-access-SA-Toronto-TTS} are stark. The TAZ within and 10-20 km outside of Toronto's boundary have relatively lower values (i.e., fewer reds and oranges) as measured by spatial availability than as measured by accessibility. There are also more pockets of low job availability (i.e., blues) within the city of Toronto once competition to those jobs is accounted for.

To enhance the interpretability of spatial availability, the measure can be normalized to provide more meaningful insight into how many jobs are _available_ on average for each TAZ. This normalization, shown in Figure \ref{fig:plot-avail-Toronto-TTS-per-worker}, demonstrates which TAZ have above (reds) and below (blue) the average (`r round(benchmark_TO_V_i_workers, 2)`) available jobs per worker in the GTHA to jobs located within the city of Toronto. Similarly, we can also observe an uneven spatial distribution of job accessibility within Toronto (as also shown in the spatial availability plot in Figure \ref{fig:plot-access-SA-Toronto-TTS}) where spatially available jobs are consistently distant from the average and often greater than 1 job per worker for the south-central and south-west TAZ in Toronto, although this trend is not as pronounced in the south-east and other pockets in the City.

```{r plot-avail-Toronto-TTS-per-worker, fig.cap="\\label{fig:plot-avail-Toronto-TTS-per-worker}Calculated spatial availability of employment, per worker, from origins in the GTHA to destinations in the City of Toronto.", fig.width=7}
mplot_SApW_TTS <- ggplot() +
  geom_sf(data = TO_taz_acc, aes(fill= TO_V_i/workers), color = NA) + #data
    scale_fill_gradient2(low = "deepskyblue4",
                         mid = "ghostwhite",
                         high = "red", #legend scale bar
                         name = "Spatially Availability \n per Worker (v_i)",
                         limits = c(0, max(TO_taz_acc$TO_V_i/TO_taz_acc$workers)), 
                         midpoint= benchmark_TO_V_i_workers, #average V_i per capita
                         na.value = "gray90") + 
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  geom_rect(data = data.frame(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, # rectangle on main plot marking inset location
                              xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
              aes(xmin = bbox_new1$xmin, ymin = bbox_new1$ymin, 
                  xmax = bbox_new1$xmax, ymax = bbox_new1$ymax),
            fill = NA, colour = "dimgrey", size = 1) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80))# positing legend and clipping out white space

#main plot + adding the inset map. 
mplot_SApW_TTS <- ggdraw(mplot_SApW_TTS) +
  draw_plot({mplot_SApW_TTS + coord_sf(xlim = st_coordinates(bbox_new)[c(1,2),1],
                                         ylim = st_coordinates(bbox_new)[c(2,3),2],
                                         expand = FALSE) + 
      theme(legend.position = "none")},
    x = 0.57, y = 0.00,  # The distance along a (0,1) x-axis (and y axis) to draw the left edge (the bottom edge) of the plot
    width = 0.46, height = 0.46) # The width and height of the plot expressed as proportion of the entire ggdraw object
mplot_SApW_TTS
```

\newpage

## Measuring access to jobs in the GTHA

Next, we repeat the analysis for all origins to _all_ jobs in the GTHA using both accessibility and spatial availability measures. As will be later elaborated, the full TTS data set demonstrates the second issue associated with the competition effect expressed by the accessibility measure. More specifically, this issue underestimates job access for TAZ which are on located in the periphery of the GTHA and have relatively-low proportion of workers and are relatively isolated (by travel cost) from the Toronto which has the highest density of jobs. The first issue, namely the over estimation of the TAZ which are on the outer limits outside the Toronto border can also be observed.

Accessibility and spatial availability are both calculated and presented in Figure \ref{fig:plot-access-SA-GGH-TTS}. Interestingly, despite the majority of jobs being located within Toronto - general trends are similar for both accessibility plots but not for both spatial availability plots. For instance, the accessibility values follow a radial trend where the majority of TAZ in Toronto have high accessibility values and values decrease in TAZ which are further from the city boundary. However, it can be seen that the radial effect is less pronounced and TA outside of Toronto appear to have a higher accessibility value. Conversely, spatial availability does not appear to follow a radial trend as depicted in the previous plot in Figure \ref{fig:plot-access-SA-Toronto-TTS}. Job access, as measured by spatial availability, appears much more even throughout the GTHA (in comparison to job access as measured by accessibility). This can be noted in higher values around the north east and south west periphery TAZ and more moderate values in and around Toronto. 

```{r calc-for-avail-GGH, include=FALSE, message=FALSE}
#calculate spatial availability
GGH_od_ft <- od_ft %>%
  mutate(catch = 1) %>%
  mutate(GGH_V_ij = sp_avail(., 
                         o_id = Origin,
                         d_id = Destination,
                         pop = workers,
                         opp = jobs,
                         r = catch,
                         f = f))

#verify that the sum of all jobs is consistent with the number of jobs
sum(GGH_od_ft$GGH_V_ij, na.rm=T)
sum_jobs <- GGH_od_ft %>% group_by(Destination) %>% summarise(jobs = mean(jobs))
sum(sum_jobs$jobs, na.rm = T)

#aggregating spatial availability  
GGH_availability <- GGH_od_ft %>%
  group_by(Origin) %>%
  summarize(GGH_V_i = sum(GGH_V_ij),
            GGH_avgtt_i = mean(travel_time),
            GGH_avg_f_i = mean(f)) 

#Merge TO availability calculation to the TAZ sf object created for accessibility above:
GGH_taz_acc <- GGH_taz_acc %>% merge(GGH_availability, by.x=c("GTA06"), by.y=c("Origin"), all.x=T) 
```


```{r plot-access-SA-GGH-TTS, fig.cap="\\label{fig:plot-access-SA-GGH-TTS}Calculated accessibility (top) and spatial availability (bottom) of employment from origins in the GTHA to destinations in the GTHA", fig.width=7, fig.height=9, message=FALSE}
## accessibility

#creating the main plot
mplot_access_TTS_GGH <- ggplot() +
  geom_sf(data = GGH_taz_acc, aes(fill= GGH_A_i), color = NA) + #data
    scale_fill_distiller(palette = "Spectral", #legend scale bar
                         name = "Accessibility \n(A_i)",
                         na.value = "grey90") +
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80)) # positing legend and clipping out white space

## spatial availability 

mplot_SA_TTS_GGH <- ggplot() +
  geom_sf(data = GGH_taz_acc, aes(fill= GGH_V_i), color = NA) + #data
    scale_fill_distiller(palette = "Spectral", #legend scale bar
                         name = "Spatially Availability \n(V_i)",
                         na.value = "grey90") + 
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80)) # positing legend and clipping out white space

mplot_access_TTS_GGH / mplot_SA_TTS_GGH
```

\newpage

```{r GGH-benchmark, include=FALSE}
benchmark_GGH_V_i_workers <- GGH_taz_acc %>% st_drop_geometry() %>% summarise(avg_VO = sum(GGH_V_i, na.rm = TRUE)/sum(workers, na.rm = TRUE)) %>% as.numeric()
```

Similar to the per worker spatial availability plot for jobs in Toronto (Figure \ref{fig:plot-avail-Toronto-TTS-per-worker}), Figure \ref{fig:plot-avail-GGH-TTS-per-worker} depicts which TAZ have above or below average job access (i.e., `r round(benchmark_GGH_V_i_workers,2) ` jobs per worker) considering all jobs and workers in the GTHA. We can discern some similar general trends, such as a higher concentration of jobs per worker in TAZ which are within Toronto, however, the plot is distinct and more similar to the spatial availability plot where the jobs per worker values are more evenly distributed throughout the GTHA, relative to the trends in the accessibility plot. We can also see higher jobs per worker in employment areas in different cites such as Mississauga and Burlington (south-west of Toronto), Waterloo and Brantford (even more south-west of Toronto), and Hamilton and Niagara (south of Toronto). 

Again, spatial availability can also be represented on a per worker basis and a similar trend between spatial availability in Figure \ref{fig:plot-avail-Toronto-TTS-per-worker} can be seen for all GTHA jobs in Figure \ref{fig:plot-avail-GGH-TTS-per-worker}. Interestingly, when considering the jobs which are _available_, many areas outside of Toronto have similar jobs per worker values as TAZ in Toronto. This is contrary to the common belief that Toronto is one of the only hubs for employment opportunities <!-- cite -->. Urban centers in Brantford, Guelph, Mississauga, Burlington, and Niagara have TAZs which are far above the the average jobs per worker and compare to TAZ within Toronto. This suggests that these less densely populated areas may have sufficient employment opportunities for their population and this finding is obscured when only considering the accessibility measure for job access. 

It is also worth noting that within the full sample of the GTHA, there is almost two times more jobs per worker than the rate for Toronto jobs per GTHA worker This suggests that all GTHA people who work in the city of Toronto, on average, face more competition for jobs than all GTHA people who work anywhere in the GTHA <!---The causes for this trend are numerous and can include .... as mentioned by study  cite -->. 

```{r plot-avail-GGH-TTS-per-worker, fig.cap="\\label{fig:plot-avail-GGH-TTS-per-worker}Calculated spatial availability of employment, per worker, from origins in the GTHA to destinations in the City of Toronto.", fig.width=7, message = FALSE}

mplot_SApW_TTS_GGH <- ggplot() +
  geom_sf(data = GGH_taz_acc, aes(fill= GGH_V_i/workers), color = NA) + #data
    scale_fill_gradient2(low = "deepskyblue4",
                         mid = "ghostwhite",
                         high = "red", #legend scale bar
                         name = "Spatially Availability \n per Worker (v_i)",
                         limits = c(0, max(GGH_taz_acc$GGH_V_i/GGH_taz_acc$workers)), 
                         midpoint= benchmark_GGH_V_i_workers, #average V_i per capita
                         na.value = "grey90") + 
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") + 
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() +
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80))# positing legend and clipping out white space

mplot_SApW_TTS_GGH
```
\newpage

# Discussion

In the preceding section we used both accessibility and spatial availability to explore the opportunity landscape in the GTHA. To build on these findings, we return to the two issues produced by the competition effect as associated with the accessibility $A_i$ measure. As we described, accessibility has the tendency to overestimate job access for areas which may experience high competition (issue 1) and underestimate job access for areas with low competition (issue 2).

To compare both accessibility and spatial availability, we calculate their relative magnitudes by re-scaling both measures from 0 to 100 where each value of the measure is divided by the maximum value as described in Equation \ref{eq:index-measures} by $A^I_{ij}$ and $V^I_{ij}$. This re-scaling process is done since accessibility cannot be meaningfully compared through normalization on a per worker basis since the methodology inherently multiple-counts opportunities which is not the case for spatial availability. Re-scaling is repeated for both measures for the subset of jobs in Toronto and for all jobs in the GTHA and differences are calculated as described in Equation \ref{eq:dif-index-measures}. 

\begin{equation}
\label{eq:index-measures}
\begin{array}{l}\
A^I_{ij} = \frac{A_{ij}}{\max(A_{ij})}\cdot100\\
V^I_{ij} = \frac{V_{ij}}{\max(V_{ij})}\cdot100\\
\end{array}
\end{equation}

\begin{equation}
\label{eq:dif-index-measures}
Dif_{ij} = \frac{V^I_{ij} - A^I_{ij}}{A^I_{ij}}\cdot100
\end{equation}

## Overestimating jobs access (issue 1)

```{r indexed-measures-calculation-Toronto}
#here we index (re-scale) the accessibility and spatial availability measures and split up the objects into POSITIVE change (i.e. when SA is higher than accessibility) and NEGATIVE change (i.e. when SA is lower than accessibility)

TO_indexed_measures_ALL <- TO_taz_acc %>%
  mutate(A_indexed = TO_A_i/(max(TO_A_i, na.rm = TRUE))*100,
         V_indexed = TO_V_i/(max(TO_V_i, na.rm = TRUE))*100,
         A_V_indexed_change = (V_indexed - A_indexed)/A_indexed,
         TO_avg_f_i)

TO_indexed_measures_pos <- TO_indexed_measures_ALL %>%
  filter(A_V_indexed_change >= 0 ) 

TO_indexed_measures_neg <- TO_indexed_measures_ALL %>%
  filter(A_V_indexed_change < 0 )#& (
           # A_V_indexed_change_rank == 1|
           # A_V_indexed_change_rank == 2 |
           # A_V_indexed_change_rank == 3 |
           #  A_V_indexed_change_rank == 4 ))
```

```{r distribution-of-change, include=FALSE}
boxplot(TO_indexed_measures_pos$A_V_indexed_change, horizontal=TRUE)
boxplot(TO_indexed_measures_neg$A_V_indexed_change, horizontal=TRUE)
boxplot(TO_indexed_measures_ALL$A_V_indexed_change, horizontal=TRUE)

# as a comment.. Moran I's test is not robust to outliers- if we remove all of Quantile 5 (i.e. ~ -70%-0%) from the negative change data set this will remove all the outliers. For the time being though, I am not doing that and am just proceeding. 
```


```{r weights-matrix-for-moran, include=FALSE}
taz_nb <- poly2nb(TO_indexed_measures_neg, queen = TRUE)
taz_w <- nb2listw(taz_nb, zero.policy = TRUE)
```
```{r moran-test-access-change, include=FALSE}
moran.test(TO_indexed_measures_neg$A_V_indexed_change, taz_w, zero.policy = TRUE, na.action=na.exclude)
```

```{r Toronto-local-moran-i, include=FALSE}
local_i <- localmoran(TO_indexed_measures_neg$A_V_indexed_change,
                      taz_w, 
                      alternative = "two.sided",
                      zero.policy = TRUE, na.action=na.exclude) %>%
  data.frame() %>%
  rename(p_val = Pr.z....E.Ii..) %>%
  mutate(significance = ifelse(p_val <= 0.10, "sig", "n.s."),
         significance = factor(significance,
                               levels = c("n.s.", "sig")))

summary(local_i)
```
```{r join-local-i-to-table, include=FALSE}
TO_indexed_measures_neg$significance <- local_i$significance


#graphinh histogram to create good breaks for plot
hist(TO_indexed_measures_neg$A_V_indexed_change, breaks = 4)
```
 

For the subset of jobs in Toronto and all origins in the GTHA, `r round(length(TO_indexed_measures_neg$GTA06)/(length(TO_indexed_measures_neg$GTA06)+length(TO_indexed_measures_pos$GTA06)),3)*100`% of TAZ have re-scaled spatial availability values which are lower than re-scaled accessibility values. Of this `r round(length(TO_indexed_measures_neg$GTA06)/(length(TO_indexed_measures_neg$GTA06)+length(TO_indexed_measures_pos$GTA06)),3)*100`%, the spatial availability value is on average `r round(mean(TO_indexed_measures_neg$A_V_indexed_change),4)*100`%  different than the accessibility value and the difference ranges between `r round(max(TO_indexed_measures_neg$A_V_indexed_change),4)*100`% to `r round(min(TO_indexed_measures_neg$A_V_indexed_change),3)*100`%. Furthermore, to emphasis the similarity of this difference measure between neighbouring TAZ, the spatial autocorrelation is calculated using Moran's I statistic  [@anselin1995local] and TAZ with a significant p-value ($p\le 0.10$) are more vividly presented. Figure \ref{fig:plot-local-i-Toronto} displays the described plotted comparison, where the more negative the value, the more the accessibility measure overestimation job access relative to spatial availability for each TAZ. It should be noted that although the majority of TAZ job access values are overestimated by accessibility, the `r length(TO_indexed_measures_pos$GTA06)` TAZ which are underestimated are shown in grey.


```{r plot-local-i-Toronto, echo=FALSE, fig.cap="\\label{fig:plot-local-i-Toronto}Difference between re-scaled the accessibility and the spatial availability job access measure in the context of employment from origins in the GTHA to destinations in the City of Toronto. Values are expressed in five quantile ranges. Vivid TAZs represent a significant spatial autocorrelation and dimmed TAZs represent a non-signficant autocorrelation as measured by Local Moran's I. TAZs with values which are higher than re-scaled accessibility (positive difference) are shown fully in grey." }

plot_morani_Toronto <- ggplot() +
  geom_sf(data = TO_indexed_measures_pos, fill = "#999999") +
  geom_sf(data = TO_indexed_measures_neg,
          aes(fill = cut(A_V_indexed_change,quantile(A_V_indexed_change, probs = seq(0, 1, 0.20))),
              alpha = significance),
          color = NA,
          size = 0.01) +
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") +
  scale_fill_manual(values = brewer.pal(5,"Spectral"),
                    name = "Difference Between \n Job Access Measures",
                    labels = c("-99% to -95% (Q1)",
                                  "-95% to -89% (Q2)",
                                  "-89% to -81% (Q3)",
                                  "-81% to -70% (Q4)",
                                  "-70% to -3% (Q5)",
                               "Positive difference")) +
  scale_alpha_manual(values = c("n.s." = 0.5, 
                                "sig" = 1)) +
  guides(alpha = "none",
         fill = guide_legend(title.position = "top")) +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() + 
  theme(legend.position = c(1.15, 0.75), 
        plot.margin = margin(t = 0, r = 0, b = 0, l = -80))# positing legend and clipping out white space

#main plot + adding the inset map. 
plot_morani_Toronto <- ggdraw(plot_morani_Toronto) +
  draw_plot({plot_morani_Toronto + coord_sf(xlim = st_coordinates(bbox_new)[c(1,2),1],
                                         ylim = st_coordinates(bbox_new)[c(2,3),2],
                                         expand = FALSE) + 
      theme(legend.position = "none")},
    x = 0.57, y = 0.00,  # The distance along a (0,1) x-axis (and y axis) to draw the left edge (the bottom edge) of the plot
    width = 0.46, height = 0.46) # The width and height of the plot expressed as proportion of the entire ggdraw object

plot_morani_Toronto
```

```{r calculating-correlation-Toronto, include=FALSE}
t <- TO_indexed_measures_neg %>% st_drop_geometry()
cor(t[, c('workers', 'jobs', "TO_A_i", "TO_V_i", "trips_i", "A_indexed", "V_indexed", "A_V_indexed_change", "TO_avg_f_i")])
```

We can see from Figure \ref{fig:plot-local-i-Toronto} that when we re-scale both job access values, accessibility consistently overestimates job access compared to the spatial availability measure for jobs within the city of Toronto and all people within the GTHA who travel to Toronto for work. Overestimation ranges from  `r percent(min(TO_indexed_measures_neg$A_V_indexed_change))` to `r percent(max(TO_indexed_measures_neg$A_V_indexed_change))` and is on average `r percent(mean(TO_indexed_measures_neg$A_V_indexed_change))`. However, while job access is consistently overestimated, it is overestimated in a variable way. The TAZ with the largest difference in measure are depicted in red and orange (quantiles 1 and 2) and can be seen, in sometimes concentrated clusters (as indicated by the  `r length(TO_indexed_measures_neg$significance == "sig")` TAZ with a significant Moran I's statistic) approximately 10-20 kms outside of Toronto city border and along the south side of the GTHA. These TAZ also have a relatively low density of people who work in Toronto and as such the difference between measures has a significant correlation ( `r round(cor(t[, c('workers', "A_V_indexed_change")])[1,2],3)`) with the number of workers in each TAZ. 

Nonetheless, the density of workers within each TAZ alone does not fully explain the variation in overestimation. The number of opportunities and the travel cost also factors in the calculation of both accessibility and spatial availability. From the perspective of accessibility $A_i$, job access does not consider opportunity-constraints and as such the extensively overestimated TAZ benefit from overestimated job access without any competition considerations from their more dense and more centrally located neighbours (within the city of Toronto) and their more peripherally located but more relatively more worker-dense peripheral neighbours. Spatial availability $V_i$ considers this competition by proportionally allocating jobs to these TAZ relative to their travel cost and worker population. In other words, these overestimated TAZ reflect the incident in which travel cost outpaced the number of workers and thus the proportionately allocated opportunities are significantly fewer when measured by spatial availability $V_i$ instead of accessibility $A_i$. 

```{r distribution-SA-Access-Toronto, include=FALSE}
# not included.. this is the density distribution of the scaled values. It dones't give us any thing new. 
x <- data.frame(TO_A = TO_indexed_measures_ALL$A_indexed, TO_V = TO_indexed_measures_ALL$V_indexed)
library(reshape2)
data <- melt(x)
ggplot(data,aes(x=value, fill=variable)) + geom_density(alpha=0.25)
```

## Underestimating jobs access (issue 2)

```{r indexed-measures-calculation-GGH}
#here we index (re-scale) the accessibility and spatial availability measures and split up the objects into POSITIVE change (i.e. when SA is higher than accessibility) and NEGATIVE change (i.e. when SA is lower than accessibility)
GGH_indexed_measures_ALL <- GGH_taz_acc %>%
  mutate(A_indexed = GGH_A_i/(max(GGH_A_i, na.rm = TRUE))*100,
         V_indexed = GGH_V_i/(max(GGH_V_i, na.rm = TRUE))*100,
         A_V_indexed_change = (V_indexed - A_indexed)/A_indexed,
         GGH_avg_f_i) 

GGH_indexed_measures_pos <- GGH_indexed_measures_ALL %>%
  filter(A_V_indexed_change >= 0)

GGH_indexed_measures_neg <- GGH_indexed_measures_ALL %>%
  filter(A_V_indexed_change < 0 ) 
```

Next, we demonstrate the difference between the two job access values for the full data set, namely, all jobs within the GTHA and all workers within the GTHA. While the majority of TAZ have difference values which correspond to accessibility being overestimated relative to spatial availability,  `r percent(nrow(GGH_indexed_measures_pos)/(nrow(GGH_indexed_measures_pos) + nrow(GGH_indexed_measures_neg)))`% of TAZ are underestimated. These underestimated TAZ are plotted in Figure \ref{fig:plot-difference-GGH} alongside the overestimated TAZ for comparison. Of the underestimated TAZ, the spatial availability value is on average `r round(mean(GGH_indexed_measures_pos$A_V_indexed_change),3)*100`%  different than the accessibility value and the difference ranges between `r round(max(GGH_indexed_measures_neg$A_V_indexed_change),3)*100`% to `r round(min(GGH_indexed_measures_neg$A_V_indexed_change),3)*100`%. The overestimated TAZ have a spatial availability value that is on average `r round(mean(GGH_indexed_measures_pos$A_V_indexed_change),3)*100`%  different than the accessibility value and the difference ranges between `r round(max(GGH_indexed_measures_neg$A_V_indexed_change),3)*100`% to `r round(min(GGH_indexed_measures_neg$A_V_indexed_change),3)*100`%. Moran's I is not plotted but the statistics is significant (i.e., there is spatial autocorrelation) for the full data set ($p< 0.001$ for all difference values).

```{r distribution-of-change-GGH, include=FALSE}
boxplot(GGH_indexed_measures_ALL$A_V_indexed_change, horizontal=TRUE)

# as a comment.. Moran I's test is not robust to outliers- if we remove all of Quantile 5 (i.e. ~ -70%-0%) from the negative change data set and Quantile 5 from the positive set (i.e. ~ ) (this will remove all the outliers. For the time being though, I am not doing that and am just proceeding. 
```

```{r weights-matrix-for-moran-GGH, include=FALSE}
taz_nb <- poly2nb(GGH_indexed_measures_ALL, queen = TRUE)
taz_w <- nb2listw(taz_nb, zero.policy = TRUE)
```
```{r moran-test-access-change-GGH, include=FALSE}
moran.test(GGH_indexed_measures_ALL$A_V_indexed_change, taz_w, zero.policy = TRUE, na.action=na.exclude)
```

```{r local-moran-i-GGH, include=FALSE}
local_i <- localmoran(GGH_indexed_measures_ALL$A_V_indexed_change,
                      taz_w, 
                      alternative = "two.sided",
                      zero.policy = TRUE, na.action=na.exclude) %>%
  data.frame() %>%
  rename(p_val = Pr.z....E.Ii..) %>%
  mutate(significance = ifelse(p_val <= 0.10, "sig", "n.s."),
         significance = factor(significance,
                               levels = c("n.s.", "sig")))
#many of the underestiamted TAZs are outliers. 
summary(local_i)
```
```{r join-local-i-to-table-GGH, include=FALSE}
#GGH_indexed_measures_neg$significance <- local_i$significance

GGH_indexed_measures_pos <- GGH_indexed_measures_ALL %>%
  filter(A_V_indexed_change >= 0)

GGH_indexed_measures_neg <- GGH_indexed_measures_ALL %>%
  filter(A_V_indexed_change < 0 ) 
```


```{r plot-difference-GGH, echo=FALSE, fig.cap="\\label{fig:plot-difference-GGH}Difference between re-scaled the accessibility and the spatial availability job access measure in the context of employment from origins in the GTHA to destinations in the City of Toronto. Values are expressed in five quantile ranges. Vivid TAZs represent a significant spatial autocorrelation and dimmed TAZs represent a non-signficant autocorrelation as measured by Local Moran's I only for underestimated TAZs. TAZs with values which are higher than re-scaled accessibility (positive difference) are shown fully in grey.", fig.width=7, fig.height=9, message=FALSE}

GGH_indexed_change_neg <- ggplot() + ggtitle("Overestimation") +
  geom_sf(data = GGH_indexed_measures_pos, fill = "#999999", size = 0.01) +
  geom_sf(data = GGH_indexed_measures_neg,
          aes(fill = cut(A_V_indexed_change,quantile(A_V_indexed_change, probs = seq(0, 1, 0.20)))),
          color = NA,
          size = 0.01) +
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") +
  scale_fill_manual(values = brewer.pal(5,"Spectral"),
                    name = " ",
                    labels = c("-99% to -93% (Q1)",
                                  "-93% to -83% (Q2)",
                                  "-83% to -70% (Q3)",
                                  "-70% to -47% (Q4)",
                                  "-47% to -0.1% (Q5)",
                               "Positive difference")) +
  guides(alpha = "none",
         fill = guide_legend(title.position = "top")) +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  theme_void() 

#positive
GGH_indexed_change_pos <- ggplot() + ggtitle("Underestimation") +
  geom_sf(data = GGH_indexed_measures_neg, fill = "#999999", size = 0.01) +
  geom_sf(data = GGH_indexed_measures_pos,
          aes(fill = cut(A_V_indexed_change,quantile(A_V_indexed_change, probs = seq(0, 1, 0.20)))),
          color = NA,
          size = 0.01) +
  geom_sf(data = toronto_muni_bound, # border for Toronto
          colour=alpha("dimgrey",1), 
          size = 0.5, fill=NA, 
          show.legend = "polygon") +
  scale_fill_manual(values = rev(brewer.pal(5,"Spectral")),
                    name = " ",
                    labels = c("0% to 22% (Q1)",
                                  "22% to 49% (Q2)",
                                  "49% to 91% (Q3)",
                                  "91% to 176% (Q4)",
                                  "176% + (Q5)",
                               "Negative difference")) +
  guides(alpha = "none",
         fill = guide_legend(title.position = "top")) +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot and inset
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot and inset
                   height = unit(0.15, "cm")) +
  guides(fill = guide_legend(reverse = FALSE)) + 
  theme_void() + 
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))
  
  
GGH_indexed_change_pos / GGH_indexed_change_neg  & theme(legend.position = "right")
```


```{r calculating-correlation-GGH, include = FALSE}
t <- GGH_indexed_measures_pos %>% st_drop_geometry()
cor(t[, c('workers', 'jobs', "GGH_A_i", "GGH_V_i", "trips_i", "A_indexed", "V_indexed", "A_V_indexed_change", "GGH_avgtt_i")])
```

As observed from Figure \ref{fig:plot-difference-GGH}, TAZ with underestimated job access (i.e., re-scaled accessibility values are smaller than re-scaled spatial availability values) are located on the periphery of the GTHA area.  The majority of these underestimated TAZ are not within the center of the GTHA where the city of Toronto and the Greater Toronto Area (GTA) is located but are in proximity to other, smaller, employment areas within smaller municipalities <!-- maybe put points/boundaries onto plots that indicate downtown city/commercial centers for all munis? Or too much information? Maybe remove all mention to city names then...-->. It can be understood that the underestimation of TAZ is a result of both high spatial availability as a result of low job competition and low accessibility scores that are a by-product of the job multiple-counting occurring within more densely job-populated TAZ in the GTA. Accessibility's multiple-counting effectively deflates the job access in these peripheral TAZ since their accessibility values are significantly lower compared to their multiple-counted GTA TAZ neighbours. The impact of this multiple-counting is starkly apparent when compared to the re-scaled spatial availability measure since spatial availability allocates jobs proportionally based on workers and travel cost, TAZ do not multiple-counting of jobs and TAZ which are not in the position to multiple-count are not deflated as a consequence. This is supported by viewing the spatial availability of jobs per worker (Figure \ref{fig:plot-avail-GGH-TTS-per-worker}) where we can see that commercial areas throughout the GTHAhave similar job access values as within some commercial areas in the GTA; this is not the case for the accessibility measure (see trends in Figure \ref{fig:plot-access-SA-GGH-TTS}).

Next, it is worth explaining why accessibility's multiple counting does not also result in the underestimation of job access when considering only considering the jobs available in Toronto. As depicted in the previous Figure \ref{fig:plot-local-i-Toronto}, almost all TAZ are overestimates (i.e., accessibility values are _higher_ than spatial availability). Within this subset of jobs in these peripheral TAZ, spatial availability is proportionally allocated based on their high (compared to the region) travel cost and Toronto-working population. In essence, these TAZ experience moderately high job competition and thus have low spatial availability. When accessibility is calculated, these peripheral TAZ have low accessibility as a result of the multiple-counting which occurs within and around Toronto but when the two measures are compared, however, accessibility is still _higher_ than spatial availability. The difference in the two measures flips when the workers who work in areas outside of Toronto are re-introduced to these peripheral TAZ as represented in Figure \ref{fig:plot-difference-GGH}. Since more workers (more competition) and more jobs with lower travel costs (less competition) are introduced, it can be inferred that these peripheral TAZ experience moderately higher job access (compare spatial availability per worker within these periphery TAZ in Figure \ref{fig:plot-avail-Toronto-TTS-per-worker} and Figure \ref{fig:plot-avail-GGH-TTS-per-worker}). Conversely, for the accessibility measure, the introduction of additional workers does not meter the accessibility gained by the introduction of additional jobs and as such, the re-scaled accessibility values are _higher_ than the spatial availability resulting in underestimated TAZ. 
 
It is also worth noting that the right panel of Figure \ref{fig:plot-difference-GGH}, by contrast, depicts all the TAZ with overestimated job access (i.e., re-scaled accessibility values are larger than re-scaled spatial availability values). Similar to the difference between measures depicted in the previous Figure \ref{fig:plot-local-i-Toronto} for the subset of jobs located in Toronto, these TAZ which are mostly within the GTA reflect an increased accessibility as a result of multiple-counting of jobs and a comparatively low spatial availability as a result of high job competition. Overall, within the full set of jobs in the GTHA, the first and second issue associated with accessibility's competition effect are observed.

# Contextualizing additional spatial availability use cases

In addition to measuring access to jobs for workers, spatial availability can be used to measure many other opportunity types and scenarios. In this section we demonstrate two additional ways in which spatial availability can be applied. Since spatial availability singly-constraints opportunities which are allocated to the demand seeking population, opportunities or demand seeking populations can be subset while the resulting access measure does not lose any interpretability. As such, we firstly present a practical application is calculating job access for a specialized subset of population to specialized employment centers. We then present an application where the roles of workers and employers are reversed and employers are the demand seeking population. These two additional use cases are non-exhaust and applications outside of employment are tenable and warranted. 

To illustrate these two additional examples, we return to the toy data set initially introduced in [Background]{#background} section.

## Available jobs for specialized working populations

Suppose that population centers P1 through P8 are not all eligible for employment at the three employment centers E1, E2, and E3. This can be due to education attainment or more simply a geographic barrier (i.e., river without a road) making it impossible for certain populations to be employed at certain employment centers. In this toy data set, we consider that only population center P1 and P2 are eligible for employment at employment center E1. Next assume that jobs in employment center E2 can be taken by individuals in population centers P3, P4, P5, P7, and P8. Lastly, jobs in employment center E3 require qualifications available only among individuals in population centers P5, P6, P8, and P9. In essence, eligibility criteria create catchments which can be easily considered within the spatial availability measure and this specialized job access is presented in Figure \ref{fig:toy-example-availability-with-catchments}.
 
```{r toy-example-create-catchments}
# Create catchments for visualization:
catchment_1 <- toy_sim_zones_access %>% filter(id == "Employment Center 1" | 
                                                 id == "Population 1" | 
                                                 id == "Population 2") %>%
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480) 

catchment_2 <- toy_sim_zones_access %>% filter(id == "Employment Center 2" | 
                                                 id == "Population 3" | 
                                                 id == "Population 4" | 
                                                 id == "Population 5" | 
                                                 id == "Population 7" | 
                                                 id == "Population 8") %>% 
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480)

catchment_3 <- toy_sim_zones_access %>% filter(id == "Employment Center 3" | 
                                                 id == "Population 5" | 
                                                 id == "Population 6" |  
                                                 id == "Population 8" | 
                                                 id == "Population 9") %>% 
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480)
```

```{r toy-example-with-catchments-proportional-allocation}
#Calculate the proportional allocation of opportunities but now with catchment constraint (referred to as $V_ij_r$):
toy_od_table <- toy_od_table %>%
  mutate(V_ij_r = sp_avail(.,
                           o_id = Origin,
                           d_id = Destination,
                           pop = Population,
                           opp = Jobs,
                           r = catchments,
                           f = f))
```

```{r toy-example-availability-with-catchment-verification, include=FALSE}
#Verify that the sum of all jobs allocated is consistent with the total number of jobs:
sum(toy_od_table$V_ij_r)

sum_jobs <- toy_od_table %>% group_by(Destination) %>% summarise(Jobs = mean(Jobs))
sum(sum_jobs$Jobs, na.rm = T)
```

```{r toy-example-availability-with-catchments-calculation}
#Repeat the availability calculation:
availability <- toy_od_table %>%
  group_by(Origin) %>%
  summarize(V_i_r = sum(V_ij_r))
#availability

#Join the availability to the toy_sim_zones_access:
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability,
            by = c("id" = "Origin"))
```


```{r toy-example-availability-with-catchments, fig.cap="\\label{fig:toy-example-availability-with-catchments}Spatial availability of jobs from population centers assuming catchment restrictions for the simple toy data set"}
ggplot() +
  geom_sf(data = catchment_1,
          fill = "orange",
          alpha = 0.05) +
  geom_sf(data = catchment_1,
          color = "orange",
          fill = NA) +
  geom_sf(data = catchment_2,
          fill = "blue",
          alpha = 0.05) +
  geom_sf(data = catchment_2,
          color = "blue",
          fill = NA) +
  geom_sf(data = catchment_3,
          fill = "red",
          alpha = 0.05) +
  geom_sf(data = catchment_3,
          color = "red",
          fill = NA) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = V_i_r, size = V_i_r, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 7, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs"),
                     guide = guide_legend(order = 2)) +
  scale_size_continuous(range = c(3,7), name = "Spatial Availability \n(V_i_r)", guide = "none") +
  scale_fill_distiller(palette = "Greens", direction = 1, name = "Spatial Availability \n(V_i_r)",
                       limits = c(0, max(toy_sim_zones_access$V_i_r, na.rm = T)),
                       guide = guide_colorbar(order = 1)) +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1.5, 
                                        color = "grey", 
                                        fill = "gray95"))
```

```{r toy-example-availability-per-capita-with-catchment-calculation, include=FALSE}
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(v_i_r = V_i_r/number)
```


```{r toy-example-jobs-proportional-allocation}
toy_od_table <- toy_od_table %>%
  mutate(catch = 1) %>% # No catchment restrictions, all members of the population are eligible for the opportunities
  mutate(V_ij = sp_avail(., 
                         o_id = Origin, 
                         d_id = Destination, 
                         pop = Population, 
                         opp = Jobs,
                         r = catch,
                         f = f))
```

```{r toy-example-availability-jobs-verification, include=FALSE}
# After calculating that spatial availability, we can verify that the sum of all available jobs  is consistent with the total number of jobs in the region:
sum(toy_od_table$V_ij)

toy_sim_zones %>% 
  filter(type == "jobs") %>% 
  pull(number) %>%
  sum()

# The total number of jobs is preserved, as desired.
```

```{r  toy-example-availability-jobs-calculation, include=FALSE}
# Next we aggregate the jobs spatially available by origin-destination pair to obtain $V_i$:
availability <- toy_od_table %>%
  group_by(Origin) %>%
  summarize(V_i = sum(V_ij))
availability

# To visualize the outcome we proceed to join the availability to the zones in the example:
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability, 
            by = c("id" = "Origin"))

# per person availability
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(v_i = V_i/number)

```

```{r toy-example-availability-jobs-per-capita, fig.cap="\\label{fig:toy-example-availability-jobs-per-capita} Spatial availability of jobs per capita for each population centers with catchment restrictions (top) and without catchment restrictions (bottom) for the simple toy data set", fig.width=7, fig.height=9, message=FALSE}

plot_toy_SA_catch <- ggplot() +
  geom_sf(data = catchment_1,
          color = "orange",
          fill = "orange",
          alpha = 0.02) +
  geom_sf(data = catchment_2,
          color = "blue",
          fill = "blue",
          alpha = 0.02) +
  geom_sf(data = catchment_3,
          color = "red",
          fill = "red",
          alpha = 0.02) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = v_i_r, size = v_i_r, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 7, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs"),
                     guide = guide_legend(order=2)) +
  scale_size_continuous( range = c(3,7), name = "Spatial Availability \nper Capita (v_i_r)", guide = "none") +
  scale_fill_gradient2(low = "goldenrod1",
                       mid = "white",
                       high = "darkgreen",
                       name = "Spatial Availability \nper Capita (v_i_r)",
                       midpoint = mean(toy_sim_zones_access$v_i_r, na.rm = T),
                       limits = c(0, max(toy_sim_zones_access$v_i_r, na.rm = T)),
                       guide = guide_colorbar(order = 1)) +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1.5, 
                                        color = "grey", 
                                        fill = "gray95"))

plot_toy_SA <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = v_i, size = v_i, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 7, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs"), 
                     guide = guide_legend(order = 2)) +
  scale_size_continuous( range = c(3,7), name = "Spatial Availability \nper Capita (v_i)", guide = "none") +
  scale_fill_gradient2(name = "Spatial Availability \nper Capita (v_i)",
                      low = "goldenrod1",
                      mid = "white",
                      high = "darkgreen",
                      midpoint = mean(toy_sim_zones_access$v_i, na.rm = T),
                      limits = c(0, max(toy_sim_zones_access$v_i, na.rm = T)),
                      guide = guide_colorbar(order = 1)) +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1.5, 
                                        color = "grey", 
                                        fill = "gray95"))

plot_toy_SA_catch / plot_toy_SA

```

For higher interpretability, we can view Figure \ref{fig:toy-example-availability-jobs-per-capita} which demonstrates a plot of spatial availability per captia considering catchments and also another plot which assumes the same number of employment center opportunities and population but no catchments. 

In the bottom plot of Figure \ref{fig:toy-example-availability-jobs-per-capita}, we see that population center P5 has the highest level of spatial availability, due to being a large population center that is more relatively close to jobs. We also see population centers which are further from employment centers have low spatial availability (P1, P3, P6, P7, P9) and population centers which are more central have, evidently, higher job access. We can also discern that the regional spatial availability per capita is `r round(mean(toy_sim_zones_access$v_i, na.rm = TRUE),3)`.  In contrast, when catchments are introduced as shown in the top plot of Figure \ref{fig:toy-example-availability-jobs-per-capita}, we see that the job access for population centers in the blue catchment decrease as job competition increases. However, we also observe that access marginally increases for the population centers in the yellow catchment and the regional spatial availability per capita increases slightly to `r round(mean(toy_sim_zones_access$v_i_r, na.rm = TRUE),3)`. 

## Alternative Use Case 3: Available Workers for Employment Centers

In this use case, we remove the catchments and switch the demand and opportunity roles of the employment centers and population centers. In this way, the spatial availability measure reflects _worker access_ by proportionally allocating _workers_ to employment centers based on travel cost (i.e., distance) and population (i.e., jobs at each employment center). Figure \ref{fig:toy-example-availability-workers-per-job} presents spatial availability generally and per capita for this use case. 

```{r toy-example-workers-proportional-allocation}
toy_od_table <- toy_od_table %>%
  mutate(catch = 1) %>%
  mutate(W_ji = sp_avail(., 
                         o_id = Destination, 
                         d_id = Origin, 
                         pop = Jobs, 
                         opp = Population,
                         r = catch,
                         f = f))
```

```{r toy-example-availability-workers-verification, include=FALSE}
#Verify that the sum of all population allocated is consistent with the total number of population:
sum(toy_od_table$W_ji)

toy_sim_zones %>% 
  filter(type == "population") %>% 
  pull(number) %>%
  sum()
# The total population is preserved, as desired.
```

```{r toy-example-availability-workers-calculation}
# Aggregate available workers by employment center:
availability <- toy_od_table %>%
  group_by(Destination) %>%
  summarize(W_j = sum(W_ji))
#availability

# Join the availability to the toy_sim_zones_access:
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability, 
            by = c("id" = "Destination"))
```


```{r toy-example-spatial-availability-workers-per-job-calculation, include=FALSE}
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(w_j = W_j/number)

toy_sim_zones_access %>% 
  st_drop_geometry() %>%
  filter(type == "jobs") %>%
  dplyr::select(id, w_j)
```

```{r toy-example-availability-workers-per-job, fig.cap= "\\label{fig:toy-example-availability-workers-per-job} Spatial availability of workers for each employment center (top) and the spatial availability of workers per job for each employment center (bottom) for the simple toy data set", fig.width=7, fig.height=9, message=FALSE}

plot_toy_SA_workers <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(fill = W_j, size = W_j, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(shape = type),
          size = 6, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs"),
                     guide = guide_legend(order = 2)) +
  scale_size_continuous(range = c(4,9), name = "Spatial Availability \n(W_j)", guide = "none") +
  scale_fill_distiller(palette = "Greens", direction = 1, name = "Spatial Availability \n(W_j)",
                       limits = c(0, max(toy_sim_zones_access$W_j, na.rm = T)),
                       guide = guide_colourbar(order = 1)) +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1.5, 
                                        color = "grey", 
                                        fill = "gray95"))

plot_toy_SA_workers_perjob <- ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(fill = w_j, size = w_j, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(shape = type),
          size = 6, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs"),
                     guide = guide_legend(order = 2)) +
  scale_size_continuous( range = c(4,9), name = "Spatial Availability \nper Job (w_j)", guide = "none") +
   scale_fill_gradient2(low = "goldenrod1",
                       mid = "white",
                       high = "darkgreen",
                       name = "Spatial Availability \nper Job (w_j)",
                       midpoint = mean(toy_sim_zones_access$w_j, na.rm=T),
                       guide = guide_colorbar(order = 1)) +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1.5, 
                                        color = "grey", 
                                        fill = "gray95"))

plot_toy_SA_workers / plot_toy_SA_workers_perjob
```

As shown in Figure \ref{fig:toy-example-availability-workers-per-job}, the top plot demonstrates the spatial availability which measures _worker access_ for the three employment centers. As with all spatial availability calculations, the number of all opportunities (in this case _workers_) are proportionally allocated to each employment center so employment center E3, E2 and E1 have access to `r round(toy_sim_zones_access %>% filter(id_short == "E3") %>% pull(W_j),2)`, `r round(toy_sim_zones_access %>% filter(id_short == "E2") %>% pull(W_j),2)`, and `r round(toy_sim_zones_access %>% filter(id_short == "E1") %>% pull(W_j),2)` workers respectively. Again, this totals to `r toy_sim_zones_access %>% filter(type == "jobs") %>% pull(number) %>% sum()` workers in the area. In the bottom plot, these spatial availability values are normalized per job (i.e. the 'population' of the employment centers) and we can see that employment center E3 has an above average worker access of `r round(toy_sim_zones_access %>% filter(id_short == "E3") %>% pull(w_j), 2)` workers per job while E2 and E1 have `r round(toy_sim_zones_access %>% filter(id_short == "E2") %>% pull(w_j), 2)` and `r round(toy_sim_zones_access %>% filter(id_short == "E1") %>% pull(w_j), 2)` workers per job respectively.

# Concluding remarks and future applications

In this paper, we propose  _spatial availability_ as an alternative to conventional accessibility which measures opportunity access which addressed the _competition effect_ and thus produces a meaningful opportunity access measure which can be normalized per demand population and used to compare access across regions. As a reminder, the competition effect results in the over and under estimation of opportunity access, under specific conditions, due to the multiple-counting of opportunities which is embedded in accessibility's method and thus makes comparing accessibility across regions potentially biased <!-- cite -->. Spatial availability, however, proportionally allocates opportunities based on the demand population and travel cost thus constraining the number of opportunities allocated across the measured region to the number of opportunities available. This single-sided opportunity constraint can be said to only consider opportunity competition for any magnitude of demand population (i.e., when measuring job access per worker the number of workers (demanding population) does not need to match the number of jobs (opportunities). We demonstrate the use of this measure and how it compares with accessibility in an empirical example of workers and jobs in the GTHA. We also demonstrate two additional employment use cases for this versatile measure in a hypothetical toy data set. These data sets and examples highlight how intuitive the per demand population access values are and captures some of the extent to which accessibility overestimates and underestimates access.

We acknowledge recent work to address limitations associated with the accessibility measure; in this light, we propose that spatial availability be seen as a type of spatial mismatch and an evolution of the BFCA approach. Historically, literature has iteratively improved measures assessing access to opportunities. In the context of employment and healthcare opportunities, simple container counting solutions such as the population-to-provider ratio (PPR) for healthcare services and jobs to housing ratio were implemented. This approach, while straight forward, is highly susceptible to the modifiable unit area problem (MUAP). Recognizing this and harnessing the computation power and access to finer resolution data as it became available, scholars proposed the next evolution, namely the accessibility measure which is widely used today and we implemented in our examples for comparison. It partially addresses the MUAP by considering opportunities outside of the conventional 'containers' which represented opportunities in a census areas/neighbourhoods by counting opportunities informed by an impedance function based on travel cost. Our measure, spatial availability, iterates on the accessibility measure by proportionally allocating travel cost and population (workers) of origins to opportunities at destinations. This single-constrained approach ensures that the population is mutually exclusive in essence replicating the properties of the self-contained unit which is _not_ limited to a zoning system proposed; the pros of accessibility solution in using the impedance function and pros of the container solutions.

However, similar to the accessibility measure, it should be noted that spatial availability is only as robust to the MUAP as the input data allows. For instance, in the empirical TTS data set, job access calculated using accessibility and spatial availability still only considers population, opportunities, and travel times from the centroids of TAZ and those TAZ are vulnerable to MUAP. Even though spatial availability can be can be meaningful calculated on a per population basis because of the proportionality property (unlike accessibility) it will still include issues of MUAP because of the input data. That said, since spatial availability does not inconsistently multiple-counts opportunities (like accessibility) it is not prone to replicating existing MUAP issues. For this reason, spatial availability is more robust to MUAP than the accessibility measure and this idea along with other multi-scale dimensions of access such as scales, populations, and time-windows, will be explored in future papers.


Fundamentally, accessibility measure's methodology results in the overestimation or underestimation of opportunity access as a result of the competition effect. Accessibility does not include factors to bound the summation so origins, hypothetically, can have infinite _opportunity access_. Spatial availability includes a single-sided opportunity constraint so it can be used to calculate access to any opportunity type, whether competitive or non-competitive in natural. In this paper, we only examined access to employment (or access to workers from the perspective of employment centers), but any opportunities which are competitive (i.e., a finite number of seats or capacity is available at any given time) such as schools, hospitals, and other essential services can be measured. Additional, opportunities which are non-competitive in the sense that they have always larger capacities than population can still benefit from this measure as access will not be over or underestimated as a result of the competition effect seen in accessibility; non-competitive opportunities can include large natural parks and beaches. As such, all access values measured for all opportunities can benefit from spatial availability measure through the reduction in competition effect (from accessibility) and a meaningful per demand population benchmark. 

# Appendix

```{r create-cullen-frey-data}
# remove all NA trips from dataset and set all 0min travel times to 0.1min
od_ft_tt  <- od_ft_tt %>% filter( !is.na(travel_time)) %>% mutate(travel_time = ifelse(travel_time == 0, 0.1, travel_time))
all_tt <- od_ft_tt  %>% dplyr::select(trips, travel_time)
all_tt <- all_tt[rep(seq_len(dim(all_tt)[1]), all_tt$trips), 2]
```

```{r plot-cullen-frey, message = FALSE, fig.height=6, fig.cap="\\label{fig:plot-cullen-frey}Cullen and frey graphy for the complete empirical 2016 TTS travel time data set."}
fitdistrplus::descdist(data=all_tt) 
```

# References {#references .unnumbered}

