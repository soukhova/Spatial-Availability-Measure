---
title: "Estimating spatial availability/mismatch using singly constrained accessibility measures"
author:
  - name: "Author One"
    email: "author.1@example.com"
    affiliation: Some School
  - name: "Author Two"
    email: "author.2@example.com"
    affiliation: Some School
    footnote: "Corresponding Author"
address:
  - code: Some School
    address: "Address"
footnote:
  - code: 1
    text: "Corresponding Author"
abstract: |
  This is the abstract.

  It consists of two paragraphs.

journal: "Journal of Transport Geography"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
#linenumbers: true
#numbersections: true
csl: elsevier-harvard.csl
output: rticles::elsevier_article
header-includes:
- \usepackage[font=small,skip=0pt]{caption}

---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  comment = '', 
  out.width = "1\\linewidth"
)
```

```{r load-packages, include=FALSE, cache=FALSE}
library(AccessPack)
library(dplyr)
library(fitdistrplus)
library(ggplot2)
library(kableExtra)
library(patchwork)
library(sf)
library(scales)
library(ggpmisc)
library(ggrepel)

options(scipen = 999)
```

\newpage

# Introduction

The concept of accessibility (opportunity access) is a relatively simple one whose appeal derives from combining the spatial distribution of opportunities and the cost of reaching them [@hansen1959]. Numerous methods for calculating _opportunity access_ have been proposed that can be broadly organized into infrastructure-, place-, person-, and utility-based measures [@geurs2004]. Of these, the place-based family of measures is arguably the most common, capturing the number of opportunities reachable from an origin using the transportation network. This type of measure is also referred to as a gravity-based measure of accessibility that captures the potential for interaction.

_Opportunity access_ analysis is widely employed in transportation, geography, public health, and many other areas, and there is increasing emphasis on a shift from mobility-oriented to access-oriented planning [@deboosere2018; @handy2020; @proffitt2017; @yan2021]. However, while these types of _opportunity access_ measures are excellent indicators of the intersection between urban structure and transportation infrastructure, they have been criticized in the past for not being highly interpretable. Previous research has highlighted how the weighting of opportunities using an impedance function can make gravity measures more difficult for planners and policymakers to interpret compared to simpler cumulative opportunity measures [@geurs2004; @miller2018]. Moreover, because place-based access measures sensitive to the number of opportunities and the characteristics of the transportation network, raw accessibility values cannot be easily compared across study areas [@allen2019].

Intra- and inter-regional comparisons are challenging because gravity-based accessibility indicators are spatially smoothed estimates of the total number of opportunities, however, the meaning of their magnitudes is unclear. This is evident when we consider the "total accessibility" in the region, a quantity that is not particularly meaningful since it is not constrained to resemble, let alone match the number of opportunities available. Furthermore, while accessibility depends on the supply of destination opportunities weighted by the travel costs associated with reaching them, the calculated accessibilities are not sensitive to the demand for those opportunities at the origins. Put another way, traditional measures of place-based accessibility do not capture the competition for opportunities. This theoretical shortcoming [@geurs2004] is particularly problematic when those opportunities are "non-divisible" in the sense that, once they have been taken by someone, are no longer available to other members of the population. Examples of indivisible opportunities include jobs (when a person takes up a job, the same job cannot be taken by someone else) and placements at schools (once a student takes a seat at a school, that particular opportunity is no longer there for another student). From a different perspective, employers may see workers as opportunities, so when a worker takes a job, this particular individual is no longer in the available pool of candidates for hiring.

To remedy these issues, researchers have proposed several different approaches for calculating competitive _opportunity access_. On the one hand, this includes several approaches that first normalize the number of opportunities available at a destination by the demand for them from the origin zones and, second, sum the demand-corrected opportunities which can be reached from the origins [e.g. @joseph1984; @shen1998]. These advances were popularized in the family of two-step floating catchment area methods [@luo2003] that have found widespread adoption for calculating competitive _opportunity access_ to healthcare and other uses. In principle floating catchment areas purport to account for competition/congestion effects, although in practice several researchers [e.g., @delamater2013spatial; @wan2012three] have found that they tend to over-estimate the level of demand and/or service. The underlying issue, as demonstrated by @paez2019, is the multiple counting of both population and level of service, which can lead to biased estimates if not corrected.

A second approach is to impose constraints on the gravity model to ensure flows between zones are equal to the observed totals. Based on Wilson's [-@wilson1971] entropy-derived gravity model, researchers can incorporate constraints to ensure that the modeled flows match some known quantities in the data inputs. In this way, models can be singly-constrained to match the row- or column-marginals (the trips produced or attracted, respectively), whereas a doubly-constrained model is designed to match both marginals. Allen and Farber [-@allen2019] recently incorporated a version of the doubly-constrained gravity model within the floating catchment area approach to calculate competitive _opportunity access_ to employment using transit across eight cities in Canada. But while such a model can account for competition, the mutual dependence of the balancing factors in a doubly-constrained model means they must be iteratively calculated which makes them more computationally-intensive. Furthermore, the double constraint means that the sum of opportunity-seekers and the sum of opportunities must match, which is not necessarily true in every case (e.g., there might be more people searching for work than jobs exist in a region).

In this paper we propose an alternative approach to measuring competitive _opportunity access_. We call it a measure of **spatial availability** (SA), and it aims to capture the number of indivisible opportunities that are not only _accessible_ but also _available_ to the opportunity-seeking population, in the sense that they have not been claimed by a competing seeker of the opportunity. As we will show, spatial availability is a singly-constrained measure of accessibility. By allocating opportunities in a proportional way based on demand and distance, this method avoids the issues of conglomeration that result from multiple counting of opportunities in traditional accessibility measures. The method returns meaningful accessibilities that correspond to the rate of available opportunities per person. Moreover, the method also returns a benchmark value for the region under study against which results for individual origins can be compared.

In the following sections we will describe and illustrate this new measure using simple numerical examples. First, we will describe the measure. Second, we will calculate the SA using a simple hypothetical population and employment centers data set for three use-cases: one of jobs from the perspective of the population, another considering catchment restrictions, and another of workers from the perspective of employers. Thirdly, we calculate the SA using real world data for the Transportation Tomorrow Survey (TTS) home-to-work commute in 2016 for the Greater Golden Horseshoe (GGH) area in Ontario, Canada. Finally, we discuss the differences between accessibility estimates to the proposed measure of SA and the potential range of uses of the SA measure.

<!-- is it worth explaining some concepts in greater detail or is this redundant for the audience? i.e. gravity-based measures, raw accessibility values, floating catchment methods, the idea of marginals, a competitive vs. non-competitive opportunity, etc -->

# Background {#background}

Most _opportunity access_ measures (excluding utility-based measures) are derived from the gravity model, and are known as *gravity-based* accessibility. Briefly, consider the following widely used accessibility measure $A_i$ : 

$$
A_i = \sum_{j=1}^JO_jf(c_{ij})
$$

\noindent where:

-   $i$ is a set of origin locations.
-   $j$ is a set of destination locations.
-   $O_j$ is the number of opportunities at location $j$. These are opportunities for activity and add some sort of *supply* to the area;
-   $c_{ij}$ is a measure of the cost of moving between $i$ and $j$
-   $f(\cdot)$ is an impedance function of $c_{ij}$; it can take the form of any monotonically decreasing function such as a negative exponential, lognormal, or gamma .

The accessibility value $A_i$ is the weighted sum of opportunities that can be reached from location $i$, given the cost of travel $c_{ij}$ and an impedance function. Summing the opportunities in the neighborhood of $i$ (the neighborhood is defined by the impedance function) estimates of the total number of opportunities that can be reached from $i$ at a certain cost. Depending on the impedance function, the measure could be cumulative opportunities (if $f(\cdot)$ is a binary or indicator function) or a more traditional gravity measure, for instance with a Gaussian impedance function or an inverse cost impedance function <!--- more citations--> .

We use a simple numerical example to introduce the key concepts, and we will use the usual accessibility measure for comparison. In this way, we aim to show the differences between accessibility and spatial availability, which helps to explain how spatial availability can improve interpretability in the analysis of spatially dispersed opportunities.

## Accessibility Numerical Example

In this section we present a simple numerical example. The setup for the example is a system with three employment centers and nine population centers, as seen in Table \ref{tab:toy-example}.

```{r toy-example, eval = FALSE}
ggplot(data = toy_sim_zones) + 
  geom_sf(aes(color = type,
              shape = type,
              size = number)) +
  geom_sf_text(aes(label = id_short),
               size = 3,
               nudge_y = -600) +
  scale_size(range = c(2, 7))  + 
  theme(legend.position = "none",
        axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

```{r create-figure-with-toy-example, fig.height=2, include=FALSE}
ggplot(data = toy_sim_zones) + 
  geom_sf(aes(color = type,
              shape = type,
              size = number)) +
  geom_sf_text(aes(label = id_short),
               size = 3,
               nudge_y = -600) +
  scale_size(range = c(2, 7))  + 
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

ggsave("images/figure-1.png",
       width = 3,
       height = 2)
```

```{r toy-example-table}
toy_sim_zones %>%
  st_drop_geometry() %>%
  dplyr::select(-id) %>%
  mutate(fig = "") %>%
  kable(format = "latex",
        booktabs = TRUE,
        col.names = c("id", "number", "type", ""),
        caption = "\\label{tab:toy-example}Numerical example") %>%
  #kable_styling(latex_options = c("scale_down")) %>%
  column_spec(4, 
              image = "images/figure-1.png") %>%
  collapse_rows(columns = 4, 
                latex_hline = "major", 
                valign = "middle")
```

The accessibility to employment of each of the population centers can be calculated using the expression above for $A_i$. As noted, this yields the number of jobs (opportunities) that are accessible (i.e., can be reached) from each population center, given the cost. In this example we use the straight line distance between the population and jobs for $c_{ij}$, and a negative exponential function with $\beta = 0.0015$.

```{r toy-example-accessibility}
# Calculate impedance function
beta <- 0.0015
toy_od_table <- toy_od_table %>%
  mutate(f = exp(-beta * distance))

# using the origin-destination table (OD) of all origin to destination trips; filter in only jobs which are mean distance or less away from a population center and sum number of jobs available in each origin (population center)
c_accessibility <- toy_od_table %>% 
  mutate(A_ij = f * Jobs) %>%
  group_by(Origin) %>%
  summarise(A_i = sum(A_ij))

#pass conventional accessibility calculation into the spatial object (toy_sim_zones)
toy_sim_zones_access  <- toy_sim_zones %>% 
  left_join(c_accessibility, 
            by = c("id" = "Origin")) 
```

```{r toy-example-accessibility-plot, fig.cap="\\label{fig:toy-example-accessibility}Accessibility results using simple numerical example"}
# Plot the accessibility to employment in the example;
ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = A_i, size = A_i, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 9, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs")) +
  scale_size_continuous( range = c(3,7), name = "Accessibility \n(A_i)") +
  scale_fill_distiller(palette = "OrRd", direction = 1, name = "Accessibility \n(A_i)",
                       limits = c(0, max(toy_sim_zones_access$A_i)) ) +
  guides(size = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

Figure \ref{fig:toy-example-accessibility} shows the three employment centers locations (black circles), where the size of the symbol is in proportion to the number of jobs at each location. We also see nine population centers (triangles), where the size of the symbol is proportional to the accessibility ($A_i$) to jobs. At a glance:

-   Population centers (triangles) in the middle of the map are relatively close to all three employment centers and thus have the highest levels of job accessibility. Population center `r toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(id_short)` is relatively central and close to all employment centers, and it is the closest population to the second largest employment center in the region. Unsurprisingly, this population center has the highest accessibility `r  toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(A_i) %>% round(2)`);

-   Population centers (triangles) near the left edge of the map (only in proximity to the small employment center) have the lowest levels of job accessibility. Population center `r toy_sim_zones_access %>% slice_min(A_i, n=1) %>% pull(id_short)` is quite peripheral and the closest employment center is also the smallest one. Consequently, it has the lowest accessibility with $A_i=$ `r toy_sim_zones_access %>% slice_min(A_i, n=1, with_ties = F) %>% pull(A_i) %>% round(2)`);

## Issues With Accessibility

Accessibility measures are excellent indicators of the intersection between urban structure and transportation infrastructure. However, beyond enabling comparisons of relative values they are not highly interpretable on their own. For instance, from Figure \ref{fig:toy-example-accessibility}, `r toy_sim_zones_access %>% slice_min(A_i, n=1) %>% pull(id_short)` has lower accessibility than `r toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(id_short)`, however, despite the accessibility value for `r toy_sim_zones_access %>% slice_min(A_i, n=1) %>% pull(id_short)` being low it is still better than _zero_. This evaluation leaves decision makers unclear on how to interpret accessibility values, particularly extreme values and particularly when comparing across scenarios or regions <!--- cite?-->. The obscurity in interpretation of accessibility values arises from the following two ways.  <!--- cite?--> 

First, origins with accessibility to a high density of opportunities are susceptible to having disproportionately higher accessibility values than origins with a lower density of opportunities.  This occurs since total accessibility ($\sum_{i=1}^IA_i$) depends on the number of origins; every additional origin in the analysis causes at least one and possibly more opportunities at destinations to be multiple-counted. As opportunities are multiple-counted, origins which are in proximity to high density of opportunities have accessibility values which are relatively conglomerated compared to origins in proximity to a lower density of opportunities. This issue means total accessibility is vulnerable to the modifiable areal unit problem (MAUP) as opportunities and origins which are spatially aggregated are multiple-counted inconsistently. 

Second, the calculated accessibilities do not take competition into account. For example, an individual at `r toy_sim_zones_access %>% slice_max(A_i, n=1) %>% pull(id_short)` has accessibility to `r  max(toy_sim_zones_access$A_i, na.rm=T)` jobs. But since this is also a large population center, there is potentially large competition for those accessible jobs. In other words, the value of $A_i$ is not sensitive to the size of population at the origin seeking the opportunity (in this case jobs), let alone the population at other locations. This unfortunately limits the interpretability of the measure. Floating catchment areas purport to account for competition/congestion effects, but as discussed by Paez, Higgins, and Vivona [-@paez2019], they are vulnerable to conglomeration, which makes them prone to bias unless corrected. 

To address these two shortcomings of the accessibility measure, we propose a singly-constrained gravity measure that corresponds to the concept of *spatial availability*.

## Spatial Availability as a Solution - Analytical Framework

As recent research on accessibility shows (see for instance Paez, Higgins, Vivona [-@paez2019] and Allen and Farber [-@allen2019]), accounting for competitive access in a meaningful way requires the proportional allocations of quantities in the accessibility calculations, or their normalization. At issue is the fact that multiple-counting is commonplace when calculating conventional accessibility $A_i$ for $i=1,\cdots,n$ as every opportunity enters the weighted sum once for every origin $i$ that can reach it. This has the unfortunate effect of obscuring the interpretability of $A_i$ and fails to answer for a individual at a specific population center the question: _"many jobs are accessible, but the same jobs are also accessible to my (possibly) numerous neighbors...what does high accessibility actually mean to me?"_

In the spatial availability framework proposed, and in line with the gravity tradition, we distinguish between opportunities at a destination and demand for opportunities at the origin. To explain the analytical framework, the example of access to employment is illustrative, with "population" in the role of demand (i.e., the number of individuals in the labour market who "demand" employment) and "jobs" in the role of opportunities.

As an overview, spatial availability ($V_{ij}$) is the proportional allocation of opportunities ($O$) and allocation factor for population ($f^p$) and cost of travel ($f^c$). Since spatial availability ($V_{ij}$) consists of these two allocation factors, this example first details how the population allocation factor $f^p_{ij}$ produces $V^p_{ij}$, next details the role of travel cost allocation factor $f^c_{ij}$ in producing $V^c_{ij}$, and finally combines both allocation factors in the final general form of spatial availability $V_{ij}$ as follows:

$$
V_{ij} = O_j\frac{f^p_{ij} \cdot f^c_{ij}}{\sum_{k=1}^K f^p_{kj} \cdot f^c_{kj}}
$$

### Population Allocation Factor

We begin with allocation based on demand; consider an employment center $j$ with $O_j^r$ jobs of type $r$. In the general case where there are $K$ population centers in the region, the following factor can be defined:

$$
f^p_{ij} = \frac{P_{i\in r}^\alpha}{\sum_{k=1}^K P_{k\in r}^\alpha}
$$ 

\noindent On the right hand side of the equation, $P_{i\in r}$ is the population at location $i$ that is eligible for jobs of type $r$ (maybe those with a certain level of training, or in a designated age group). The summation in the bottom is over $k=1,\cdots,K$, the number of population centers in the region. The resulting factor $f^p_{ij}$ corresponds to the proportion of the population in zone $i$ relative to the rest of the region's population centres $K$. The factors $f^p_{ij}$ satisfy the property that $\sum_i^{I} f^p_{ij} = 1$. We can also add an empirical parameter $\alpha$ that can be used to modulate the effect of size in the calculations (i.e., $\alpha <1$ places greater weight on smaller centres relative to larger ones while $\alpha>1$ achieves the opposite effect).

This factor ($f^p_{ij}$) can now be used to proportionally allocate a share of the jobs at the employment centre $j$ to population center $i$ and population center $k$. The share of jobs at $j$ allocated to (i.e., available to) each population center is: 

$$
V^p_{ij} = O_jf^p_{ij}\\
$$

\noindent and since $\sum_i^{I} f^p_{ij} = 1$ it follows that: 

$$
\sum_{i=1}^I V_{ij} = O_j 
$$

In other words, the number of jobs is preserved. The result is a proportional allocation of available jobs to population centres based on demand. As an example, consider an employment center $j$ in a region with two population centers (say $i$ and $k$). For simplicity, assume that the all the population in the region is eligible for these jobs, that is, that the entirety of the population is included in the set $r$. The allocation factors for the jobs at $j$ would be: 

$$
\begin{array}{l}\
f^p_{ij} = \frac{P_i ^\alpha}{P_i^\alpha + P_k^\alpha}\\
f^p_{kj} = \frac{P_k^\alpha}{P_i^\alpha + P_k^\alpha}\\
\end{array}
$$

Suppose that there are three hundred jobs in the employment center ($W_j = 300$), and that the populations are $P_i=240$ and $P_k=120$. The jobs are allocated as follows (assuming that $\alpha=1$): 

$$
\begin{array}{l}\
V^p_{ij} = O_jf^p_{ij} = O_j\frac{P_i^\alpha}{P_i^\alpha + P_k^\alpha} = 300\frac{240}{240 + 120} = 300\frac{240}{360} = 200\\
V^p_{kj} = O_jf^p_{kj} = O_j\frac{P_k^\alpha}{P_i^\alpha + P_k^\alpha} = 300\frac{120}{240 + 120} = 300\frac{120}{360} = 100 \\
\end{array}
$$ 

It can be seen that proportionally more jobs are allocated to the bigger center and also that the total number of jobs is preserved. However, the factors above account for the total number of opportunities at the destination (i.e., the number of jobs at the employment center), but they do not account for their location relative to the population centers. The proportional allocation procedure above is insensitive to how far population centers $i$ or $k$ are from employment center $j$. To account for this effect we define a second set of allocation factors based on distance to the employment centers. 

### Travel Cost Allocation Factor

These are defined as: 

$$
f^c_{ij} = \frac{f(c_{ij})}{\sum_{k=1}^K f(c_{ij})}\\
$$ 

\noindent where $c_{ij}$ is the cost (e.g., the distance, travel time, etc.) from population center $i$ to employment center $j$, and $f(\cdot)$ is an impedance function that is a monotonically decreasing function of cost ($c_{ij}$); in other words, this allocation factor ($f^c_{ij}$) serves to proportionally allocates more jobs to closer locations through an impedance function. To illustrate, assume that the impedance function is a negative exponential function as follows, and assume that $\beta$ (which modulates the steepness of the impedance effect and is an empirical parameter) is the value of 1: 

$$
f(c_{ij}) = \exp(-\beta c_{ij})\\
$$ 

Continuing the example, suppose that the distance from population center $i$ to employment center $j$ is 0.6 km, and the distance from population center $k$ to employment center $j$ is 0.3 km. Being closer, we would expect more jobs to be allocated to the population of $k$. The jobs would be sorted as follows: 

$$
\begin{array}{l}\
f^c_{ij} = \frac{\exp(-\beta D_{ij})}{\exp(-\beta D_{ij}) + \exp(-\beta D_{kj})}\\
f^c_{kj} = \frac{\exp(-\beta D_{kj})}{\exp(-\beta D_{ij}) + \exp(-\beta D_{kj})}\\
\end{array}
$$

This step normalizes the impedance between $i$ and $j$ and $k$ and $j$ by the total impedance in the study area. Numerically, the jobs allocation is: 

$$
\begin{array}{l}\
V^c_{ij} = O_jf^c_{ij} = O_j\frac{\exp(-D_{ij})}{\exp(-D_{ij}) + \exp(-D_{kj})} = 300\frac{\exp(-0.6)}{\exp(-0.6) + \exp(-0.3)} = 3\times 0.426 = 127.8\\
V^c_{kj} = O_jf^c_{kj} =  O_j\frac{\exp(-D_{kj})}{\exp(-D_{ij}) + \exp(-D_{kj})} = 300\frac{\exp(-0.3)}{\exp(-0.6) + \exp(-0.3)} = 3\times  0.574 = 172.2\\
\end{array}
$$ 

A larger share of jobs (172.2 jobs) is allocated to the population center ($k$) that is closest as assumed. As before, the sum of jobs allocated to the population centers matches the total number of jobs available. Nevertheless, in isolation, this step does not account for the allocation of jobs based on demand.

### Putting Spatial Availability Together

We can combine the proportional allocation factors by population and distance and calculated spatial availability ($V_{ij}$) as follows: 

$$
V_{ij} = O_j\frac{f^p_{ij} \cdot f^c_{ij}}{\sum_{k=1}^K f^p_{kj} \cdot f^c_{kj}}
$$

When applied to the example of population center $i$ and $k$ (i.e., the demand) traveling to employment center $j$ (i.e., the opportunity $O$): 

$$
\begin{array}{l}\
V_{ij} = O_j\cdot \frac{f^p_{ij} \cdot f^c_{ij}}{f^p_{ij} \cdot f^c_{ij} + f^p_{kj} \cdot f^c_{kj}} = 300 \frac{\big(\frac{2}{3} \big) \big(0.426 \big)}{\big(\frac{2}{3} \big) \big(0.426 \big) + \big(\frac{1}{3} \big) \big(0.574 \big)} = \big(300 \big)\big(\frac{0.284}{0.475} \big)= 179.4\\
V_{kj} = O_j\cdot \frac{f^p_{kj} \cdot f^c_{kj}}{f^p_{ij} \cdot f^c_{ij} + f^p_{ik} \cdot f^c_{ik}} = 300 \frac{\big(\frac{1}{3} \big) \big(0.574 \big)}{\big(\frac{2}{3} \big) \big(0.426 \big) + \big(\frac{1}{3} \big) \big(0.574 \big)}  = \big(300 \big)\big(\frac{0.191}{0.475} \big)= 120.6 \\
\end{array}
$$ 

Notice how fewer jobs are allocated to population center $i$ compared to the allocation by population only, to account for the higher cost of reaching the employment center. On the other hand, distance alone allocated more jobs to the closest population center (i.e., $k$), but since it is smaller, it also gets a smaller share of the jobs overall. Again, the sum of jobs at employment center $j$ that are allocated to population centers $i$ and $k$ simultaneously based on *population-* and *distance-* based allocation is preserved (i.e., $W_{ij} + W_{kj} = W_j$).

Availability is simply the sum of the above by origin: 

$$
V_i = \sum_{j=1}^J V_{ij}
$$ 

This quantity represents opportunities (e.g., jobs) that can be reached from $i$ (i.e., they are accessible), and that are *not* allocated to a competitor: therefore the weighted sum of available opportunities. Compare $V_i$ to the singly-constrained gravity model (see Wilson [-@wilson1971]). In essence, $V_i$ is the result of constraining $A_i$ to match one of the marginals in the origin-destination table, the known total of opportunities.

Since the sum of opportunities is preserved in the procedures above, it is possible to calculate a highly interpretable measure of spatial availability per capita (call it lower-case $v_i$) as follows: 

$$
v_i = \frac{V_i}{P_i}
$$

In the example above: 

$$
\begin{array}{l}\
v_{ij} = \frac{V_{ij}}{P_i} =  \frac{179.4}{240}\\
v_{kj} =  \frac{V_{ik}}{P_k} =  \frac{120.6}{120}\\
\end{array}
$$ 

Less competition ($P_k$ is the smallest population center in the region) and being closer to the jobs clearly works in favor of individuals at $k$. Where the overall ratio of jobs to population in the region is $300/(240 + 120)=$ `r round(300/(240 + 120), 2)`, the spatially available jobs per capita at $k$ is closer to unity.

## Spatial Availability Use Cases

With the analytical framework for spatial availability outlined, in the following sub-sections, we return to the numerical example which was introduced in the [Background](#background) and illustrate how spatial availability $V_i$ can be calculated for three types of use cases.

### Available Jobs for The Working Population

In this use case, we calculate the spatial availability of jobs using the same impedance function that was used to calculate job accessibility in Figure \ref{fig:toy-example-accessibility}. The spatial availability calculations are implemented in the function `sp_avail`. The inputs are an Origin-Destination table with labels for the origins (`o_id`), labels for the destinations (`d_id`), the population (`pop)` and number of opportunities (`opp`), an indicator for catchments or other eligibility constraints (`r`), and a pre-calculated impedance function (`f`). For this example, we assume that there are no catchment restrictions by setting `r` to 1.

The value of the function (its output) is a vector with $V_ij$ given the inputs, that is, the opportunities available to $i$ from $j$:

```{r toy-example-jobs-proportional-allocation}
toy_od_table <- toy_od_table %>%
  mutate(catch = 1) %>% # No catchment restrictions, all members of the population are eligible for the opportunities
  mutate(V_ij = sp_avail(., 
                         o_id = Origin, 
                         d_id = Destination, 
                         pop = Population, 
                         opp = Jobs,
                         r = catch,
                         f = f))
```

```{r toy-example-availability-jobs-verification, include=FALSE}
# After calculating that spatial availability, we can verify that the sum of all available jobs  is consistent with the total number of jobs in the region:
sum(toy_od_table$V_ij)

toy_sim_zones %>% 
  filter(type == "jobs") %>% 
  pull(number) %>%
  sum()

# The total number of jobs is preserved, as desired.
```

```{r  toy-example-availability-jobs-calculation, include=FALSE}
# Next we aggregate the jobs spatially available by origin-destination pair to obtain $V_i$:
availability <- toy_od_table %>%
  group_by(Origin) %>%
  summarize(V_i = sum(V_ij))
availability

# To visualize the outcome we proceed to join the availability to the zones in the example:
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability, 
            by = c("id" = "Origin"))

# per person availability
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(v_i = V_i/number)

```

Figure \ref{fig:toy-example-availability-jobs} shows the estimates of spatial availability:

```{r toy-example-availability-jobs, fig.cap="\\label{fig:toy-example-availability-jobs}Spatial availability of jobs"}
ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = V_i, size = V_i, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 9, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs")) +
  scale_size_continuous( range = c(3,7), name = "Spatial Availability \n(V_i)") +
  scale_fill_distiller(palette = "Greens", direction = 1, name = "Spatial Availability \n(V_i)",
                       limits = c(0, max(toy_sim_zones_access$V_i)) ) +
  guides(size = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```
We see that population center 5 has the highest level of spatial availability, due to being a large population center that is moreover relatively close to jobs. To improve the interpretability of this measure, we first note that the regional measure of jobs per capita is `r round((toy_sim_zones %>% filter(type == "jobs") %>% pull(number) %>% sum())/(toy_sim_zones %>% filter(type == "population") %>% pull(number) %>% sum()), 3)`. We then calculate the spatially available jobs per person by dividing each spatial availability value by the population at each population center (Figure \ref{fig:toy-example-availability-jobs-per-capita}).

Some population centers have almost two jobs available per person (compared to the overall regional value of approximately one job per person), while others have less than one job available per person. This does not mean that people are not taking some of the jobs. It means that controlling for the cost of reaching jobs, they are worse off than those with more jobs spatially available.

```{r toy-example-availability-jobs-per-capita, fig.cap="\\label{fig:toy-example-availability-jobs-per-capita}Spatial availability of jobs per capita"}
ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = v_i, size = v_i, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 9, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs")) +
  scale_size_continuous( range = c(3,7), name = "Spatial Availability \nper Capita (v_i)") +
  scale_fill_distiller(name = "Spatial Availability \nper Capita (v_i)",
                      palette = "Blues", direction = 1,
                      limits = c(0, max(toy_sim_zones_access$v_i)) ) +
  guides(size = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

```
### Available Jobs for Specialized Working Populations

In this sub-section we introduce catchment/eligibility constraints. Due to differences in educational achievement among the population, the jobs in Employment Center 1 can only be taken by individuals in population centers 1 and 2. Jobs in Employment Center 2 can be taken by individuals in population centers 3, 4, 5, 7, and 8. Lastly, jobs in Employment Center 3 require qualifications available only among individuals in population centers 5, 6, 8, and 9. 

Calculate the spatial availability by proportionally allocating _specialized_ workers to jobs (we refer to spatial availability in this case as $V_ij_r$):
 
```{r toy-example-create-catchments}
# Create catchments for visualization:
catchment_1 <- toy_sim_zones_access %>% filter(id == "Employment Center 1" | 
                                                 id == "Population 1" | 
                                                 id == "Population 2") %>%
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480) 

catchment_2 <- toy_sim_zones_access %>% filter(id == "Employment Center 2" | 
                                                 id == "Population 3" | 
                                                 id == "Population 4" | 
                                                 id == "Population 5" | 
                                                 id == "Population 7" | 
                                                 id == "Population 8") %>% 
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480)

catchment_3 <- toy_sim_zones_access %>% filter(id == "Employment Center 3" | 
                                                 id == "Population 5" | 
                                                 id == "Population 6" |  
                                                 id == "Population 8" | 
                                                 id == "Population 9") %>% 
  st_union %>% 
  st_convex_hull()  %>%
  st_buffer(480)
```

```{r toy-example-with-catchments-proportional-allocation}
#Calculate the proportional allocation of opportunities but now with catchment constraint (referred to as $V_ij_r$):
toy_od_table <- toy_od_table %>%
  mutate(V_ij_r = sp_avail(.,
                           o_id = Origin,
                           d_id = Destination,
                           pop = Population,
                           opp = Jobs,
                           r = catchments,
                           f = f))
```

```{r toy-example-availability-with-catchment-verification, include=FALSE}
#Verify that the sum of all jobs allocated is consistent with the total number of jobs:
sum(toy_od_table$V_ij_r)

sum_jobs <- toy_od_table %>% group_by(Destination) %>% summarise(Jobs = mean(Jobs))
sum(sum_jobs$Jobs, na.rm = T)
```

```{r toy-example-availability-with-catchments-calculation}
#Repeat the availability calculation:
availability <- toy_od_table %>%
  group_by(Origin) %>%
  summarize(V_i_r = sum(V_ij_r))
#availability

#Join the availability to the toy_sim_zones_access:
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability,
            by = c("id" = "Origin"))
```

Plot the availability estimates:

```{r toy-example-availability-with-catchments, fig.cap="\\label{fig:toy-example-availability-with-catchments}Spatial availability of jobs with catchment restrictions"}
ggplot() +
  geom_sf(data = catchment_1,
          fill = "orange",
          alpha = 0.05) +
  geom_sf(data = catchment_1,
          color = "orange",
          fill = NA) +
  geom_sf(data = catchment_2,
          fill = "blue",
          alpha = 0.05) +
  geom_sf(data = catchment_2,
          color = "blue",
          fill = NA) +
  geom_sf(data = catchment_3,
          fill = "red",
          alpha = 0.05) +
  geom_sf(data = catchment_3,
          color = "red",
          fill = NA) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = V_i_r, size = V_i_r, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 9, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs")) +
  scale_size_continuous( range = c(3,7), name = "Spatial Availability \n(V_i_r)") +
  scale_fill_distiller(palette = "Greens", direction = 1, name = "Spatial Availability \n(V_i_r)",
                       limits = c(0, max(toy_sim_zones_access$V_i_r)) ) +
  guides(size = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

Available jobs per person with catchment/eligibility conditions:

```{r toy-example-availability-per-capita-with-catchment-calculation}
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(v_i_r = V_i_r/number)
```

The plot in Figure \ref{fig:toy-example-availability-with-catchments-per-capita} shows the availability per person without and with catchment restrictions.

```{r toy-example-availability-with-catchments-per-capita, fig.cap="\\label{fig:toy-example-availability-with-catchments-per-capita}Spatial availability of jobs per capita with and without catchment restrictions "}
ggplot() +
  geom_sf(data = catchment_1,
          fill = "orange",
          alpha = 0.05) +
  geom_sf(data = catchment_1,
          color = "orange",
          fill = NA) +
  geom_sf(data = catchment_2,
          fill = "blue",
          alpha = 0.05) +
  geom_sf(data = catchment_2,
          color = "blue",
          fill = NA) +
  geom_sf(data = catchment_3,
          fill = "red",
          alpha = 0.05) +
  geom_sf(data = catchment_3,
          color = "red",
          fill = NA) +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "population"),
          aes(fill = v_i_r, size = v_i_r, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "jobs"),
          aes(shape = type),
          size = 9, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs")) +
  scale_size_continuous( range = c(3,7), name = "Spatial Availability \nper Capita (v_i_r)") +
  scale_fill_distiller(palette = "Blues", direction = 1, name = "Spatial Availability \nper Capita (v_i_r)",
                       limits = c(0, max(toy_sim_zones_access$v_i_r)) ) +
  guides(size = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

We can see that when there are catchment restrictions population center 2, despite being relatively peripheral, has higher spatial availability due to spatial specialization. With catchments, the spatial availability of jobs declines from the perspective of population center 4: the population here has skills required for jobs at a small employment center, where they face substantial competition from other population centers.

### Available Workers for Employment Centers

We can also examine the pool of workers available to each employment center by considering the workers as the opportunities and the jobs as the population.

Calculate the spatial availability by proportionally allocating jobs to workers (we refer to spatial availability in this case as $W_ji$) as follows:

```{r toy-example-workers-proportional-allocation}
toy_od_table <- toy_od_table %>%
  mutate(catch = 1) %>%
  mutate(W_ji = sp_avail(., 
                         o_id = Destination, 
                         d_id = Origin, 
                         pop = Jobs, 
                         opp = Population,
                         r = catch,
                         f = f))
```

```{r toy-example-availability-workers-verification, include=FALSE}
#Verify that the sum of all population allocated is consistent with the total number of population:
sum(toy_od_table$W_ji)

toy_sim_zones %>% 
  filter(type == "population") %>% 
  pull(number) %>%
  sum()
# The total population is preserved, as desired.
```

```{r toy-example-availability-workers-calculation}
# Aggregate available workers by employment center:
availability <- toy_od_table %>%
  group_by(Destination) %>%
  summarize(W_j = sum(W_ji))
#availability

# Join the availability to the toy_sim_zones_access:
toy_sim_zones_access <- toy_sim_zones_access %>%
  left_join(availability, 
            by = c("id" = "Destination"))
```

Plot the availability estimates:

```{r toy-example-availability-workers, fig.cap="\\label{fig:toy-example-availability-workers}Spatial availability of workers"}
ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(fill = W_j, size = W_j, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(shape = type),
          size = 8, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs")) +
  scale_size_continuous( range = c(6,11), name = "Spatial Availability \n(W_j)") +
  scale_fill_distiller(palette = "Greens", direction = 1, name = "Spatial Availability \n(W_j)",
                       limits = c(0, max(toy_sim_zones_access$W_j)) ) +
  guides(size = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

```{r toy-example-spatial-availability-workers-per-job-calculation, include=FALSE}
toy_sim_zones_access <- toy_sim_zones_access %>%
  mutate(w_j = W_j/number)

toy_sim_zones_access %>% 
  st_drop_geometry() %>%
  filter(type == "jobs") %>%
  dplyr::select(id, w_j)
```

Plot the spatial availability of workers per job:

```{r toy-example-availability-workers-per-job, fig.cap="\\label{fig:toy-example-availability-workers-per-job}Spatial availability of workers per job"}
ggplot() +
  geom_sf(data = toy_sim_zones_access %>% 
            filter(type == "jobs"),
          aes(fill = w_j, size = w_j, shape = type)) +
  geom_sf(data = toy_sim_zones_access %>%
            filter(type == "population"),
          aes(shape = type),
          size = 8, fill = "black") +
  geom_sf_text(data = toy_sim_zones_access , aes(label = id_short),
               size = 3, nudge_y = -400) +
  scale_shape_manual(values = c('population' = 24, 'jobs' = 21), name = "Location Type", labels=c("Population", "Jobs")) +
  scale_size_continuous( range = c(6,11), name = "Spatial Availability \nper Job (w_j)") +
  scale_fill_distiller(palette = "Blues", direction = 1, name = "Spatial Availability \nper Job (w_j)" ) +
  guides(size = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

# Empirical Example: Spatial Availability and Accessibility of Jobs in Toronto

For the reasons demonstrated in the hypothetical toy example; the spatial availability measure produces different and more interpretable results than accessibility. In this section we will demonstrate both measures and a comparison using empirical data for home-based work trips to places of employment in Toronto, Ontario. 

## Data

The 2016 Transportation Tomorrow Survey (TTS) data for 20 municipalities contained within the the Greater Golden Horseshoe (GGH) area in the province of Ontario, Canada (43.6°N 79.73°W) is analysed (Figure \ref{fig:TTS-16-survey-area}). This data set includes home-based origins and employment destinations defined by centroids of Traffic Analysis Zones (TAZ) of varying areas (n=`r round(length(AccessPack::ggh_taz$GTA06), 3)`), the number of jobs (n=`r round(sum(AccessPack::ggh_taz$jobs), 3)`) and workers (n=`r round(sum(AccessPack::ggh_taz$workers), 3)`) at each origin and destination, and the trips from origin to destination for the morning home-to-work commute (n=`r round(sum(AccessPack::od_ft_tt$trips), 3)`). Also included are calculated travel times by car (calculated via [`r5r`](https://github.com/ipeaGIT/r5r)) and a derived impedance function values corresponding to the cost of travel based on the trip length distribution (TLD). The descriptive statistics are presented in Table \ref{tab:TTS-16-desc-stats} and a [data-package](https://github.com/soukhova/AccessPack) is available to explore the data in greater detail.

```{r TTS-16-survey-area, echo=FALSE, fig.cap="\\label{fig:TTS-16-survey-area}The TTS 2016 study area within the Greater Golden Horseshoe in Ontario, Canada."}
knitr::include_graphics("images/Greater-Golden-Horseshoe-Map.png")
```

```{r}
od_ft_tt %>% 
  dplyr::select(trips, travel_time) %>% summary() %>%
  kable(format = "latex", 
        col.names = c("Trips", "Travel_Time"),
        caption = "\\label{tab:TTS-16-desc-stats}Descriptive statistics of the TTS 2016 dataset for the Greater Golden Horshoe Area")
```

## Calibrating an Impedance Function

In the hypothetical toy data set, an arbitrary negative exponential function describing the increase in travel cost as distance increases was used as the impedance function to derive both accessibility and availability. In this data set, an impedance function can be derived from the empirical trip length distribution (TLD) as the number of trips and their travel cost (in the case, travel time in minutes) are known (see black data points in Figure \ref{fig:TLD-Gamma-plot}).

The TLD density plot appears to follow a gamma distribution, as such, this theoretical distribution along with other common TLD distributions such as log-normal and exponential distributions <!-- cite--> were fitted to the empirical TLD using the maximum likelihood estimation method and Nelder-Mead method for direct optimization available within the fitdistrplus package in R [@fitdistrplus_2015; @R_2021] <!-- cite, why this fitting method -->. Based on goodness-of-fit criteria, the gamma distribution was selected (see red line in Figure \ref{fig:TLD-Gamma-plot}). The gamma distribution function is given in the following general form: 
$$ 
f(x, \alpha, \beta) = \frac {x^{\alpha-1}e^{-\frac{x}{\beta}}}{ \beta^{\alpha}\Gamma(\alpha)} \quad \text{for }	0 \leq x \leq \infty
$$
\noindent where the estimated 'shape' is $\alpha$,the estimated 'rate' is $\beta$, and $\Gamma(\alpha)$ is defined as:

$$
\Gamma(\alpha) =  \int_{0}^{\infty} x^{\alpha-1}e^{-x} \,dx
$$  

```{r data-for-impedance}
# remove all NA trips from dataset and set all 0min travel times to 0.1 min
od_ft_tt  <- od_ft_tt %>% 
  filter( !is.na(travel_time)) %>% 
  mutate(travel_time = ifelse(travel_time == 0, 0.1, travel_time))
all_tt <- od_ft_tt  %>% 
  dplyr::select(trips, travel_time)

all_tt <- all_tt[rep(seq_len(dim(all_tt)[1]), all_tt$trips), 2]
```

```{r fitting-impedance-function}
# using fitdist function to fit a distribution using the default maximum likelihood estimation method and Nelder-Mead method for direct optimization
gamma_ <- fitdistrplus::fitdist(data=all_tt, "gamma", method="mle", optim.method="Nelder-Mead") 
#lnorm_ <- fitdistrplus::fitdist(data=all_tt, "lnorm", method="mle", optim.method="Nelder-Mead")
#norm_ <-fitdistrplus::fitdist(data=all_tt, "norm", method="mle", optim.method="Nelder-Mead")
#exp_ <- fitdistrplus::fitdist(data=all_tt, "exp", method="mle", optim.method="Nelder-Mead")
```

```{r save-impedance-plot, include=FALSE}
# For some reason plot(gamma_) does not play well with knitr, so instead we save the figure and then include it as a graphic in the following chunk
png("images/impedance_function.png")
plot(gamma_)
dev.off()
```

```{r plot-impedance-function, fig.cap="\\label{fig:impedance-function-plot}Impedance function and diagnostics."}
knitr::include_graphics("images/impedance_function.png")
```

```{r TLD-gamma-calculation}
tld <- od_ft_tt %>%
  mutate(tt_classes = cut(travel_time, 
                          150,
                          ordered_result = TRUE)) %>%
  group_by(tt_classes) %>%
  summarize(trips = sum(trips),
            travel_time = mean(travel_time))
```

```{r TLD-Gamma-plot, fig.cap="\\label{fig:TLD-Gamma-plot}Empirical trip length distribution (black) and calibrated gamma distribution impedance function (red)"}
#dgamma is the density plot for gamma function
ggplot(data = tld, aes(x = travel_time, y = trips/sum(trips))) + 
  geom_point(size = 3) +     
  geom_line(aes(x=travel_time, y=dgamma(travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"])), 
            color="red", size = 1) + 
  theme_classic()
```

The calibrated impedance function has a shape parameter of `r round(gamma_$estimate[1], 3)` and a rate parameter of `r round(gamma_$estimate[2], 3)`. The function and diagnostics are plotted in Figure \ref{fig:impedance-function-plot} and the predicted values are plotted alongside the empirical TLD in Figure \ref{fig:TLD-Gamma-plot}. As a point of summary, values calculated by this calibrated impedance function captures our theoretical cost of travel (i.e. probability of travel based on the trip length distribution of empirical trips and associated travel time) within the following accessibility and spatial availability calculations.

## Accessibility and Spatial Availability of Jobs in Toronto 

Using the impedance function defined, the accessibility to employment destinations in Toronto from home-based origins anywhere in the GGH is calculated. The higher the accessibility value, the more accessible places of employment are to home-based origins as seen in Figure \ref{fig:plot-accessibility-Toronto-TTS}. It can be briefly summarized that the that the accessibility values follow a radial trend where the majority of TAZs in Toronto have high accessibility values and values decrease in TAZs which are further from the city boundary.

```{r calc-for-accessibility}
#transform CRS
toronto_muni_bound <- st_transform(toronto_muni_bound, crs=32617)

#select only zones within Toronto Municipality

TO_taz <- ggh_taz %>%
  filter(st_intersects(., toronto_muni_bound, sparse = FALSE)[,1]) %>% dplyr::select(GTA06, AREA, jobs)

# transfer calibrated impedance function values to OD matrix
od_ft_tt <- od_ft_tt %>%
  mutate(f = dgamma(travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"]))

#add the number of jobs and workers to the od_ft_tt matrix
od_ft <- od_ft_tt %>% merge(ggh_taz %>% dplyr::select(GTA06, workers) %>% st_drop_geometry(),
                   by.x = "Origin", by.y="GTA06", all.x = TRUE)

od_ft <- od_ft %>% merge(ggh_taz %>% dplyr::select(GTA06, jobs) %>% st_drop_geometry(),
                   by.x = "Destination", by.y="GTA06", all.x = TRUE)

#jobs at destinations IN Toronto and origins from anywhere; workers are associated with the origin (ggh) and jobs with the destination (Toronto)
TO_od_ft <- od_ft %>% filter(Destination %in% TO_taz$GTA06)

#calculate accessibility for workers from any origin to jobs in Toronto 
TO_c_accessibility <- TO_od_ft %>% 
  mutate(TO_A_ij = f * jobs) %>%
  group_by(Origin) %>%
  summarise(TO_A_i = sum(TO_A_ij, na.rm = T),
            trips_i = sum(trips, na.rm = T))

#Merge TO accessibly calculation to the ggh_taz:
TO_taz_acc <- ggh_taz %>% merge(TO_c_accessibility, by.x=c("GTA06"), by.y=c("Origin"), all.y=T) 
```

```{r plot-accessibility-Toronto-TTS, fig.cap="\\label{fig:plot-accessibility-Toronto-TTS}Calculated accessibility of employment from origins in the GGH to destinations in the City of Toronto"}
plot_c_access <- ggplot() +
  geom_sf(data = TO_taz_acc, 
          aes(fill= TO_A_i), color = NA) +
    scale_fill_distiller(palette = "Spectral", trans="sqrt", name = "Accessibility \n(A_i)",
                         limits = c(0, max(TO_taz_acc$TO_A_i)) )+ 
  geom_sf(data = toronto_muni_bound, colour="black", fill=NA) +
    guides(size = "none") + 
  theme(legend.position = "right",
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
plot_c_access
```
```{r calc-for-avail, include=FALSE, warning=FALSE, message=FALSE}
#calculate spatial availability
TO_od_ft <- TO_od_ft %>%
  mutate(catch = 1) %>%
  mutate(TO_V_ij = sp_avail(., 
                         o_id = Origin,
                         d_id = Destination,
                         pop = workers,
                         opp = jobs,
                         r = catch,
                         f = f))

#verify that the sum of all jobs is consistent with the number of jobs
sum(TO_od_ft$TO_V_ij, na.rm=T)
sum_jobs <- TO_od_ft %>% group_by(Destination) %>% summarise(jobs = mean(jobs))
sum(sum_jobs$jobs, na.rm = T)

#aggregating spatial availability  
TO_availability <- TO_od_ft %>%
  group_by(Origin) %>%
  summarize(TO_V_i = sum(TO_V_ij),
            TO_avgtt_i = mean(travel_time),
            TO_avg_f_i = mean(f)) 

#Merge TO availability calculation to the TAZ sf object created for accessibility above:
TO_taz_acc <- TO_taz_acc %>% merge(TO_availability, by.x=c("GTA06"), by.y=c("Origin"), all.x=T) 
```


Next, the spatial availability using the same impedance function is calculated for the same survey area; the higher the spatial availability value the more available employment destinations in Toronto are to any home-based origins in the GGH (Figure \ref{fig:plot-avail-Toronto-TTS}). If a TAZ has a spatial availability value which is higher or lower than `r round(mean(TO_taz_acc$TO_V_i), 3)` it has above or below average spatial availability of jobs relative to all job opportunities within the City of Toronto (for all origins in the GGH). Spatial availability can also be normalized per workers within each TAZ to provide meaningful insight on how many jobs are _available_ on average for each TAZ. This normalization, shown in Figure \ref{fig:plot-avail-Toronto-TTS-per-worker}, demonstrates which TAZ have above and below the average (`r round(mean(TO_taz_acc$TO_V_i)/mean(TO_taz_acc$worker), 3)`) available jobs per worker in the GGH (to jobs located within the city of Toronto). It can be briefly summarized that the spatial availability measure has a smaller and less pronounced radial impact than the accessibility measure; TAZs within and immediately outside the boundary of Toronto have above average spatial availability of jobs but at a lower relative intensity than compared to the availability measure. Additionally, more TAZs outside of Toronto have low spatial availability values.

```{r plot-avail-Toronto-TTS, fig.cap="\\label{fig:plot-avail-Toronto-TTS}Calculated spatial availability of employment from origins in the GGH to destinations in the City of Toronto"}
ggplot() +
  geom_sf(data = TO_taz_acc,
          aes(fill= TO_V_i), color = NA) +
    scale_fill_distiller(palette = "Spectral",  trans = "sqrt", name = "Spatially Availability \n(V_i)", 
                         limits = c(0, max(TO_taz_acc$TO_V_i)) ) +
  geom_sf(data = toronto_muni_bound, colour="black", fill=NA) +
    guides(size = "none") +
  theme(legend.position = "right",
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```

```{r plot-avail-Toronto-TTS-per-worker, fig.cap="\\label{fig:plot-avail-Toronto-TTS-per-worker}Calculated spatial availability of employment, per worker, from origins in the GGH to destinations in the City of Toronto."}
ggplot() +
  geom_sf(data = TO_taz_acc,
          aes(fill= TO_V_i/workers), color = NA) +
    scale_fill_distiller(palette = "Spectral", name = "Spatially Availability \n per Worker (v_i)",
                         limits = c(0, max(TO_taz_acc$TO_V_i / TO_taz_acc$workers)))+
  geom_sf(data = toronto_muni_bound, colour="black", fill=NA) +
  guides(size = "none") + 
  theme(legend.position = "right",
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))
```


# Discussion

## Comparing Opportunity Access Measures

```{r indexed-measures-calculation}
indexed_measures_pos <- TO_taz_acc %>%
  mutate(A_indexed = TO_A_i/(max(TO_A_i))*100,
         V_indexed = TO_V_i/(max(TO_V_i))*100,
         A_V_indexed_change = (V_indexed - A_indexed)/A_indexed) %>%
  filter(A_V_indexed_change >= 0) %>%
  mutate(A_V_indexed_change_rank = ntile(A_V_indexed_change,5))

indexed_measures_neg <- TO_taz_acc %>%
  mutate(A_indexed = TO_A_i/(max(TO_A_i))*100,
         V_indexed = TO_V_i/(max(TO_V_i))*100,
         A_V_indexed_change = (V_indexed - A_indexed)/A_indexed) %>% 
  filter(A_V_indexed_change < 0) %>%
  mutate(A_V_indexed_change_rank = ntile(A_V_indexed_change,5))
```

Accessibility and spatial availability in our example both measure _access to jobs_. However, these two measures cannot be meaningfully compared through normalization on a per worker basis since the accessibility methodology inherently multiple-counts opportunities. We thus take a different approach to compare the relative magnitudes (within each measure) by re-scaling both measures from 0 to 100 where each value of the measure is divided by the maximum value. The percentage change between re-scaled spatial availability and accessibility for each TAZ is then calculated;`r round(length(indexed_measures_neg$GTA06)/(length(indexed_measures_neg$GTA06)+length(indexed_measures_pos$GTA06)),3)*100`% of TAZs have lower re-scaled spatial availability values than accessibility values and they are on average `r round(mean(indexed_measures_neg$A_V_indexed_change),4)*100`% different and range between `r round(max(indexed_measures_neg$A_V_indexed_change),4)*100`% to `r round(min(indexed_measures_neg$A_V_indexed_change),3)*100`% different than re-scaled accessibility. To simplify the presentation of percentage change in difference between measures, five quantiles are calculated and coloured to represent each TAZ in Figure \ref{fig:indexed-measures-comparison-plot}. The quantile ranks range from 1 to 5 where 1 represents the highest percentage difference between spatial availability and accessibility. In other words, the higher the quantile rank, the more pronounced the overestimation of _job access_ is in that TAZ when referring to the accessibility measure relative to the spatial availability measure. It should be noted that the `r round(length(indexed_measures_pos$GTA06)/(length(indexed_measures_neg$GTA06)+length(indexed_measures_pos$GTA06)),3)*100`% of TAZs which experience a positive change between the rescaled measures are shown in grey.


```{r indexed-measures-comparison-plot, fig.cap="\\label{fig:indexed-measures-comparison-plot}Difference in rescaled accessbility and spatial availability values in the context of employment from origins in the GGH to destinations in the City of Toronto. TAZs with rescaled spatial accessibility values that are lower than rescaled accessibility values are presented in five quantiles from 1 to 5 with 1 representing the highest negetative change between spatial availability and accessibility. TAZs with values which are higher than rescaled accessibility are shown in grey."}

indexed_change <- ggplot() +
  geom_sf(data = indexed_measures_neg,
          aes(fill = A_V_indexed_change_rank),  color = NA) +
  scale_fill_distiller(palette = "RdYlGn", direction = 1, name = "Quantile Ranks 
of the % Difference
Between Job Access 
Measures")+
  geom_sf(data = toronto_muni_bound, colour="black", fill=NA) +
  geom_sf(data = indexed_measures_pos, fill = "#999999") +
  guides(fill = guide_legend(reverse = FALSE)) + 
  theme(legend.position = "right",
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

## I was attempting to insert a table on the plot which shows the ranges of the quantiles... thoughts? Ex. Quantile 1 represents a -100% to -95% difference, Quantile 2 represents.. etc.

quantile_ranges <- indexed_measures_neg %>% group_by(A_V_indexed_change_rank) %>% st_drop_geometry() %>%
  summarise(low = percent(min(A_V_indexed_change)),
            high = percent(max(A_V_indexed_change))) %>% plyr::rename(., c("A_V_indexed_change_rank" = "Quantile",
                           "low" = "Lower",
                           "high" = "Upper"))
# indexed_change +                                               
#   annotate(geom = "table",
#             x = Inf, y = - Inf,
#            label = list(quantile_ranges))

indexed_change
```
```{r calculating-correlation, include=FALSE}
t <- indexed_measures_neg %>% st_drop_geometry()
cor(t[, c('workers', 'jobs', "TO_A_i", "TO_V_i", "trips_i", "A_indexed", "V_indexed", "A_V_indexed_change", "TO_avgtt_i")])
```


We can see from Figure \ref{fig:indexed-measures-comparison-plot} that when we re-scale the accessibility values, they consistently overestimate  _job access_ compared to the re-scaled spatial availability measure. Overestimation ranges from  `r min(quantile_ranges$Upper)` to `r min(quantile_ranges$Lower)` and is on average `r percent(mean(indexed_measures_neg$A_V_indexed_change))`. However, while accessibility consistently overestimates _job access_ relative to spatial availability, it does so in a variable way. _Job access_ is more overestimated in TAZs that have a low number of workers and is less overestimated in TAZs with a high number of workers; the correlation between the number of workers and the percentage difference between measures is `r round(cor(t[, c('workers', "A_V_indexed_change")])[1,2],3)`. As such, the TAZs that have a relatively low number of workers are located between the border of the GGH and the City of Toronto and are also mostly coloured by red and orange indicating Quantiles 1 and 2 (highest percentage of overestimation) and vice versa. Both _job access_ measures are more similar when the number of workers correlates with travel cost and the number of jobs at the destination. However, when the calibrated travel cost outpaces the number of workers, as is the case for the low-worker TAZs within this empirical example, then these measures increasingly diverge. This difference emphasizes the importance in using an accurate and well-informed impedance function and origin-destination data. For reference to these trends, the plots for workers and impedance function values for all TAZs are presented in Figure \ref{fig:plot-workers-imp}.

```{r plot-workers-imp, fig.cap="\\label{fig:plot-workers-imp}Number of workers (top) and average impedance function value (bottom) for each origin TAZ in the GGH."}
plot_workers<- ggplot() +
  geom_sf(data = indexed_measures_neg,
          aes(fill= workers), color = NA) +
    scale_fill_distiller(palette = "Spectral", name = "# of Workers",
                         limits = c(0, max(indexed_measures_neg$workers)))+
  geom_sf(data = toronto_muni_bound, colour="black", fill=NA) +
  guides(size = "none") + 
  theme(legend.position = "right",
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

plot_imp<- ggplot() +
  geom_sf(data = indexed_measures_neg,
          aes(fill= TO_avg_f_i), color = NA) +
    scale_fill_distiller(palette = "Spectral", name = "Travel Cost Value",
                         limits = c(0, max(indexed_measures_neg$TO_avg_f_i)))+
  geom_sf(data = toronto_muni_bound, colour="black", fill=NA) +
  guides(size = "none") + 
  theme(legend.position = "right",
        panel.grid = element_blank(),
        panel.background = element_rect(size = 1, 
                                        color = "black", 
                                        fill = NA))

plot_workers / plot_imp
```
Accessibility when used to measure _job access_ obscures the _availability_ of jobs. Overall, this can be seen when comparing Figure \ref{fig:plot-accessibility-Toronto-TTS} and Figure \ref{fig:plot-avail-Toronto-TTS} where the intra-measure magnitude of accessibility is much higher within and closer to the boundary of the City of Toronto while spatial availability is more level as it is proportioned by the number of workers within each origin TAZs. Since spatial availability is proportioned by the number of workers, the resulting _job access_ value is numerically meaningful to determine what _job access_ is available per worker and how it compares to the average _job access_ for the region. In this way, spatial availability is more interpretable than accessibility as it can be stated that the average Toronto jobs per worker is XX for the GGH and XX for Toronto; interestingly, all TAZs in Toronto have a higher _job access_ than the GGH value but still range between XX and XX. <!-- add values? worth it? -->

<!-- Does it make sense to report some sort of uncertainty? How does the uncertainty in the calculation of spatial availability vary between high and low values. -->

## Contextualizing Spatial Availability Use Cases

With the toy and empirical example presented, we propose that spatial availability be seen as a type of *spatial mismatch* and an evolution of  the *balanced floating catchment* approach (BFCA) <!-- how? -->. Historically, literature has iteratively improved measures assessing access to opportunities. In the context of employment and healthcare opportunities, simple container counting solutions such as the population-to-provider ratio (PPR) for healthcare services and jobs to housing ratio were implemented. This approach, while straight forward, is highly sustible to the modifiable unit area problem (MUAP). Recognizing this and harnessing the computation power and access to finer resolution data as it became available, scholars proposed the next evolution, namely the accessibility measure which is widely used today and we implemented in our examples for comparison. It partially addresses the MUAP by considering opportunities outside of the conventional 'containers' which represented opportunities in a census areas/neighbourhoods by counting opportunities informed by an impedance function based on travel cost. Our measure, spatial availability, iterates on the accessibility measure by proportionally allocating travel cost and population (workers) of origins to opportunities at destinations. This single-constrained approach ensures that the population is mutually exclusive in essence replicating the properties of the self-contained unit which is _not_ limited to a zoning system proposed; the pros of accessibility solution in using the impedance function and pros of the container solutions. 

Similar to the accessibility measure, it should be noted that spatial availability is only as robust to the MUAP as the input data allows. For instance, in the empirical example present, the measure of _job access_ still only considers population, opportunities, and travel times from the centroids of TAZs. However, unlike the accessibility measure, spatial availability can be meaningful calculated on a per population basis at higher resolutions because of the proportionality property.

Further, the measure of spatial availability can be a useful way to distinguish between low accessibility/low population centers, which may enjoy higher availability than the accessibility value may suggest, and contrariwise, high accessibility/high population centers (which potentially can result in lower availability due to competition). For instance, as presented in the numerical example, more remote, smaller population centers can have sufficient spatial availability by being in close proximity to the smaller employment centers; however this sufficiency is obscured by accessibility measure by conglomerating accessibly of population centers which are more central to more (and larger) employment centers. Conversely, referring to the empirical GGH example, the TAZs that are relatively close to the Toronto job destinations but have a relatively low number of workers receive sufficiently high values of accessibility and signficantly lower spatial availability values; this trend is opposite to what is experienced in the numerical example and is a result of higher job competition (i.e. job opportunities are more highly allocated to TAZs with lower travel costs and higher worker populations). Measuring access to opportunities is a multi-scale problem; since the number of opportunities are preserved, different scales, populations, and time-windows can be incorporated within the measure without introducing additional spatial basis.

Fundamentally, accessibility measure's methodology results in the overestimation of _jobs access_ since it simply sums the count of destination opportunities based on travel cost to opportunities; the measure does not include factors to bound the summation so origins, hypothetically, can have infinite _opportunity access_. This property can be practical for calculating _opportunity access_ for opportunities which have large capacities and are _non-competitive_ such as large natural parks and beaches. These non-competitive opportunities can be considered infinitely divisible as they offer more 'spots' at any given time than the population. However, often times opportunities are not divisible but are in fact indivisible and competitive meaning, such as the numerical and GGH empirical example of _jobs access_, where only 1 worker can access 1 job at any given time. In these cases, spatial availability measure can be used to calculate the _opportunity access_ in which the report values are numerically meaningful, the MUAP is potentially addressed, and _opportunity access_ values across regions, neighbourhoods, and spatial scales can be compared. 


## Limitations 

still does not tell us how many accessible opportunities will lead to participation/positive outcomes; it does come closer... this is an important question for equity analysis. 

<!-- 
This measure is a type of spatial mismatch and evolution on BFCA (how?).
1. when opportunity is indivisible; 
2. When an opportunity is not indivisible it can be used to calculate "peak" accessibility in transportation planning cases
3. Accessibility is still a multi-scale problem; since the number of opportunities are preserved, different scales, populations, and time-windows can be incorporated within the measure without introducing additional spatial basis. 
-->

# Conclusion

Words go here.

<!-- 
- This measure is a type of spatial mismatch and evolution on BFCA (how?).
- Preserves the number of opportunities, this results in an interpretable measure which depicts spatial availability
- Interpretable benchmark for the region and across regions (e.g., availability of jobs per person)
-->

# References {#references .unnumbered}
